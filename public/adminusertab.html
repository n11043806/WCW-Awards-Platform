<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Manage Users - WCW Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Arial, sans-serif; background-color: #fafafa; color: #333; }

    .sidebar{
      position: fixed; top:0; left:0; width:220px; height:100vh;
      background:#d7336f; padding:20px; color:#fff; display:flex; flex-direction:column;
    }
    .sidebar h2{ text-align:center; margin-bottom:40px; font-size:22px; }
    .sidebar a{ color:#fff; text-decoration:none; padding:10px 15px; border-radius:4px; margin-bottom:10px; transition:background-color .2s; }
    .sidebar a:hover, .sidebar a.active{ background:#b8235a; }

    .main-content{ margin-left:220px; padding:30px; }
    header{
      background:#d7336f; color:#fff; padding:20px; border-radius:8px;
      display:flex; justify-content:space-between; align-items:center;
    }

    h2.section-title{ margin-top:30px; color:#d7336f; }

    .controls{ display:flex; align-items:center; gap:10px; margin:20px 0; }
    .controls input{ padding:8px; font-size:14px; border:1px solid #ccc; border-radius:4px; width:70%; }
    .controls select, .controls button{
      padding:8px; font-size:14px; border:1px solid #ccc; border-radius:4px; background:#fff; cursor:pointer;
    }
    .controls button{ background:#d7336f; color:#fff; font-weight:bold; border:none; }
    .controls button:hover{ background:#b8235a; }

    table{ width:100%; border-collapse:collapse; margin-top:10px; }
    th, td{ text-align:left; padding:12px; border-bottom:1px solid #ddd; }
    th{ background:#fafafa; color:#d7336f; }

    .row-actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .action-btn{
      padding:6px 10px; border:none; border-radius:4px;
      background:#d7336f; color:#fff; font-size:14px; cursor:pointer;
    }
    .action-btn:hover{ background:#b8235a; }
    .btn-danger{ background:#e57373; }
    .btn-danger:hover{ background:#d32f2f; }

    footer{ text-align:center; color:#888; margin-top:40px; font-size:14px; }

    .error{ color:#e53935; margin-top:10px; }

    /* Overlay & popups */
    #overlay{
      display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:999;
    }
    .popup{
      display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      background:#fff; padding:24px; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,.3);
      z-index:1000; width:320px; text-align:left; animation:fadeIn .2s ease-in-out;
    }
    .popup h3{ margin:0 0 14px; color:#d7336f; }
    .popup p{ margin:0 0 16px; color:#444; }
    .popup .actions{ display:flex; gap:10px; justify-content:flex-end; }
    .popup button{ padding:8px 14px; border:none; border-radius:6px; font-weight:bold; cursor:pointer; }
    .popup .btn-primary{ background:#d7336f; color:#fff; }
    .popup .btn-secondary{ background:#f0f0f0; color:#333; }
    .popup .btn-danger{ background:#e57373; color:#fff; }

    @keyframes fadeIn{ from{opacity:0;} to{opacity:1;} }

    /* User menu */
    .user-menu-container{ position:relative; display:flex; gap:10px; align-items:center; }
    .user-fullname{ color:#fff; font-weight:600; margin-right:6px; }
    .user-circle{ background:#8d57a0; color:#fff; border:2px solid #5f386d; border-radius:50%; width:38px; height:38px; display:inline-flex; align-items:center; justify-content:center; cursor:pointer; font-weight:700; }
    .user-dropdown{ display:none; position:absolute; top:48px; right:0; background:#fff0f6; border:1px solid #b8235a; border-radius:8px; min-width:180px; z-index:100; flex-direction:column; }
    .user-dropdown.open{ display:flex; }
    .user-dropdown button{ background:none; border:none; color:#b8235a; padding:12px 18px; text-align:left; cursor:pointer; display:flex; justify-content:space-between; }
    .user-dropdown button:hover{ background:#ffe6ee; }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>WCW Admin</h2>
    <a href="admindashboard.html">Dashboard</a>
    <a href="adminentriestab.html">Entries</a>
    <a href="adminusertab.html" class="active">Users</a>
    <a href="adminjudgetab.html">Judging</a>
    <a href="#" onclick="logout()">Logout</a>
  </div>

  <div class="main-content">
    <header>
      <div style="display:flex;align-items:center;justify-content:space-between;width:100%">
        <h1>User Management</h1>
        <div class="user-menu-container" id="adminUserMenu">
          <span id="userFullName" class="user-fullname"></span>
          <button id="userCircle" class="user-circle" aria-haspopup="true" aria-expanded="false" title="Account">A</button>
          <div id="userDropdown" class="user-dropdown">
            <button onclick="window.location.href='adminprofile.html'">Profile <span class="material-symbols-outlined" style="font-size:18px;">person</span></button>
            <button onclick="window.open('https://support.awardforce.com/hc/en-us','_blank')">Get help <span class="material-symbols-outlined" style="font-size:18px;">help</span></button>
            <button onclick="logout()">Log out <span class="material-symbols-outlined" style="font-size:18px;">logout</span></button>
          </div>
        </div>
      </div>
    </header>

    <h2 class="section-title">Registered Users</h2>
    <div class="controls">
      <input type="text" id="searchInput" placeholder="Search by name or role..." oninput="filterUsers()" />
      <select id="sortSelect" onchange="filterUsers()">
        <option value="createdDesc">Recently Created</option>
        <option value="createdAsc">Created First</option>
        <option value="nameAsc">Name A–Z</option>
        <option value="roleAsc">Role A–Z</option>
      </select>
      <button onclick="window.location.href='admininviteuser.html'">Invite User</button>
      <button onclick="window.location.href='adminnewuser.html'">New User</button>
    </div>

    <div id="errorBox" class="error"></div>
    <table>
      <thead>
        <tr>
          <th>Full Name</th>
          <th>Email</th>
          <th>Role</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="userTableBody"></tbody>
    </table>

    <footer>&copy; 2025 WCW Awards Platform. All rights reserved.</footer>
  </div>

  <!-- Overlay -->
  <div id="overlay"></div>

  <!-- Edit Role Popup -->
  <div id="popup" class="popup" aria-modal="true" role="dialog">
    <h3>Edit User Role</h3>
    <select id="newRole" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; margin-bottom:14px;">
      <option value="admin">Admin</option>
      <option value="applicant">Applicant</option>
      <option value="judge">Judge</option>
    </select>
    <div class="actions">
      <button class="btn-primary" onclick="confirmRoleChange()">Save</button>
      <button class="btn-secondary" onclick="closePopup()">Cancel</button>
    </div>
  </div>

  <!-- Delete Confirm Popup -->
  <div id="deletePopup" class="popup" aria-modal="true" role="dialog">
    <h3>Delete user</h3>
    <p id="deleteText">Are you sure you want to delete this user?</p>
    <div class="actions">
      <button class="btn-danger" onclick="confirmDelete()">Delete</button>
      <button class="btn-secondary" onclick="closeDelete()">Cancel</button>
    </div>
    <div id="deleteNote" style="margin-top:10px; font-size:12px; color:#777;"></div>
  </div>

  <!-- Firebase SDKs -->
  <script src="/__/firebase/12.0.0/firebase-app-compat.js"></script>
  <script src="/__/firebase/12.0.0/firebase-auth-compat.js"></script>
  <script src="/__/firebase/12.0.0/firebase-firestore-compat.js"></script>
  <script src="/__/firebase/12.0.0/firebase-functions-compat.js"></script>
  <script src="/__/firebase/init.js?useEmulator=true"></script>

  <script>
    let usersList = [];
    let selectedUserId = null;
    let selectedUserName = '';
    let currentAdminUid = null;

    function logout() {
      firebase.auth().signOut().then(() => { window.location.href = "signin.html"; });
    }

    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        currentAdminUid = user.uid;
        firebase.firestore().collection("users").doc(user.uid).get()
          .then(doc => {
            if (!doc.exists || doc.data().role !== "admin") {
              window.location.href = "unauthorized.html";
            } else {
              loadUsers();
            }
          });
      } else {
        window.location.href = "signin.html";
      }
    });

    function loadUsers() {
      firebase.firestore().collection("users").get()
        .then(snapshot => {
          usersList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          filterUsers();
        })
        .catch(error => { document.getElementById("errorBox").textContent = error.message; });
    }

    function filterUsers() {
      const searchTerm = document.getElementById("searchInput").value.toLowerCase();
      const sortOption = document.getElementById("sortSelect").value;

      let filtered = usersList.filter(user =>
        (user.fullName || "").toLowerCase().includes(searchTerm) ||
        (user.role || "").toLowerCase().includes(searchTerm)
      );

      switch (sortOption) {
        case "nameAsc": filtered.sort((a, b) => (a.fullName || "").localeCompare(b.fullName || "")); break;
        case "roleAsc": filtered.sort((a, b) => (a.role || "").localeCompare(b.role || "")); break;
        case "createdAsc": filtered.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0)); break;
        case "createdDesc":
        default: filtered.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
      }

      const tbody = document.getElementById("userTableBody");
      tbody.innerHTML = "";
      filtered.forEach(user => {
        const disableDelete = user.id === currentAdminUid ? 'disabled title="You cannot delete yourself"' : '';
        const row = `
          <tr>
            <td>${user.fullName || "N/A"}</td>
            <td>${user.email || "N/A"}</td>
            <td>${user.role || "N/A"}</td>
            <td>
              <div class="row-actions">
                <button class="action-btn" onclick="editRole('${user.id}', '${user.role || ''}')">Edit</button>
                <button class="action-btn btn-danger" ${disableDelete}
                  onclick="askDelete('${user.id}', '${(user.fullName || user.email || 'this user').replace(/'/g,'\\\'')}')">
                  Delete
                </button>
              </div>
            </td>
          </tr>
        `;
        tbody.insertAdjacentHTML("beforeend", row);
      });
    }

    /* ---------- Edit role popup ---------- */
    function editRole(userId, currentRole) {
      selectedUserId = userId;
      document.getElementById("newRole").value = currentRole || "";
      openPopup("popup");
    }
    function closePopup(){ closePopupId("popup"); }
    function confirmRoleChange() {
      const newRole = document.getElementById("newRole").value;
      if (!selectedUserId) return;
      firebase.firestore().collection("users").doc(selectedUserId).update({ role: newRole })
        .then(() => { closePopup(); loadUsers(); })
        .catch(error => { alert("Failed to update role: " + error.message); });
    }

    /* ---------- Delete user popup ---------- */
    function askDelete(userId, displayName) {
      selectedUserId = userId;
      selectedUserName = displayName || 'this user';
      if (selectedUserId === currentAdminUid) return; // double safety

      document.getElementById("deleteText").textContent =
        `Are you sure you want to delete ${selectedUserName}? This permanently removes their account.`;
      document.getElementById("deleteNote").textContent =
        "Auth deletion requires the callable Cloud Function 'adminDeleteUser'. Firestore profile will be deleted regardless.";
      openPopup("deletePopup");
    }
    function closeDelete(){ closePopupId("deletePopup"); }

    async function confirmDelete() {
      if (!selectedUserId) return;
      if (selectedUserId === currentAdminUid) { alert("You can’t delete your own account."); return; }

      const db = firebase.firestore();
      const functions = firebase.functions();

      try {
        // 1) Try to delete the Auth user via callable CF (if deployed)
        try {
          const delFn = functions.httpsCallable('adminDeleteUser');
          await delFn({ uid: selectedUserId });
        } catch (e) {
          console.warn('adminDeleteUser not available or failed:', e?.message || e);
          // continue to Firestore deletion; Auth account might remain if function not deployed
        }

        // 2) Delete Firestore profile
        await db.collection('users').doc(selectedUserId).delete();

        closeDelete();
        loadUsers();
      } catch (err) {
        console.error(err);
        alert("Failed to delete user: " + (err.message || err));
      }
    }

    /* ---------- Generic popup helpers ---------- */
    function openPopup(id){ document.getElementById("overlay").style.display="block"; document.getElementById(id).style.display="block"; }
    function closePopupId(id){ document.getElementById(id).style.display="none"; document.getElementById("overlay").style.display="none"; }
    document.getElementById('overlay').addEventListener('click', ()=>{ closePopup(); closeDelete(); });

    /* ---------- User menu ---------- */
    (function(){
      const uc=document.getElementById('userCircle'), ud=document.getElementById('userDropdown'), uf=document.getElementById('userFullName');
      if(uc && ud){
        uc.addEventListener('click',()=>{ ud.classList.toggle('open'); });
        document.addEventListener('click', e=>{ if(!document.getElementById('adminUserMenu')?.contains(e.target)){ ud.classList.remove('open'); }});
      }
      if(window.firebase&&firebase.auth){
        firebase.auth().onAuthStateChanged(u=>{
          if(!u) return;
          if(uf) uf.textContent = u.displayName||u.email||'Admin';
          if(uc) uc.textContent = u.displayName ? u.displayName.split(' ').map(w=>w[0]).join('').toUpperCase() : (u.email?u.email[0].toUpperCase():'A');
        });
      }
    })();
  </script>
</body>
</html>
