<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin – Manual Assignment | WCW Awards</title>
  <style>
    /* === Base & Dashboard-matching Sidebar === */
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #fafafa;
      color: #333;
    }
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 220px;
      height: 100vh;
      background-color: #d62d83;
      padding: 20px;
      color: white;
      display: flex;
      flex-direction: column;
    }
    .sidebar h2 {
      text-align: center;
      margin-bottom: 40px;
      font-size: 22px;
    }
    .sidebar a {
      color: white;
      text-decoration: none;
      padding: 10px 15px;
      border-radius: 4px;
      margin-bottom: 10px;
      transition: background-color 0.2s;
    }
    .sidebar a:hover, .sidebar a.active {
      background-color: #b8235a;
    }

    /* === Page layout matching dashboard spacing === */
    .main-content {
      margin-left: 220px;
      padding: 30px;
    }

    /* Header row with Back button on the RIGHT */
    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between; /* push title left, button right */
      margin-bottom: 14px;
    }
    .page-header h1 {
      color: #d62d83;
      font-size: 26px;
      margin: 0;
      line-height: 1.2;
    }
    .back-btn {
      background: #fff;
      color: #d62d83;
      border: 1px solid #d62d83;
      padding: 8px 12px;
      border-radius: 6px;
      font-weight: 700;
      cursor: pointer;
    }
    .back-btn:hover { background: #ffe6ee; }

    /* === Inline toolbar (Score Set & Round) === */
    .toolbar {
      background: #fff;
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 12px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .tool { display: flex; align-items: center; gap: 8px; }
    .tool label { font-weight: 600; font-size: 14px; color: #444; }
    select {
      padding: 10px 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
      background: #fff;
      outline: none;
    }

    /* === Panels grid === */
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    @media (max-width: 1024px) { .grid { grid-template-columns: 1fr; } }

    .panel {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 20px;
      border: 1px solid #eee;
      display: flex;
      flex-direction: column;
      /* Give the panel a stable height relative to the viewport so inner list can scroll */
      min-height: 420px;
      height: calc(100vh - 260px);
      /* 260px ≈ header + toolbar + margins; adjust if your layout changes */
      overflow: hidden;
    }
    .panel h2 {
      margin: 0 0 12px;
      font-size: 18px;
      color: #d62d83;
    }
    .meta-note { color: #777; font-size: 12.5px; margin-top: 10px; }

    .row-actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin: 10px 0;
    }
    .search { flex: 1; }
    .search input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
      background: #fff;
    }
    .tiny {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      color: #555;
    }

    /* The scrolling list area */
    .list {
      border: 1px solid #eee;
      border-radius: 8px;
      background: #fcfcfc;
      overflow-y: auto;
      overflow-x: hidden;
      flex: 1;
      max-height: calc(100% - 70px);
    }
    .item {
      display: grid;
      grid-template-columns: 26px 1fr;
      gap: 10px;
      align-items: center;
      padding: 10px 12px;
      border-bottom: 1px solid #eee;
    }
    .item:last-child { border-bottom: none; }
    .item:hover { background: #fff; }
    .sub { color: #777; font-size: 12.5px; }

    /* === Footer action row === */
    .footer-actions {
      margin-top: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: #fff;
      border: 1px solid #eee;
      border-radius: 999px;
      font-size: 12.5px;
      color: #555;
    }
    .btn-primary {
      background: #d62d83;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 16px;
      font-weight: bold;
      cursor: pointer;
    }
    .btn-primary:hover { background: #b8235a; }

    .error { color: #b00020; font-weight: 700; margin: 8px 0 0; }
  </style>
</head>
<body>
  <!-- Sidebar (exactly like dashboard) -->
  <div class="sidebar">
    <h2>WCW Admin</h2>
    <a href="admindashboard.html">Dashboard</a>
    <a href="adminentriestab.html">Entries</a>
    <a href="adminusertab.html">Users</a>
    <a href="adminjudgetab.html">Judging</a>
    <a href="#" onclick="logout()">Logout</a>
  </div>

  <!-- Main content -->
  <div class="main-content">
    <div class="page-header">
      <h1>Manual Assignment</h1>
      <button class="back-btn" onclick="location.href='adminmanagejudge.html'">← Back</button>
    </div>

    <!-- Slim inline toolbar under title -->
    <div class="toolbar">
      <div class="tool">
        <label for="scoreSet">Score Set</label>
        <select id="scoreSet">
          <option value="Finalist Judging (copied from 2024)">Finalist Judging (copied from 2024)</option>
          <option value="Initial Review">Initial Review</option>
        </select>
      </div>
      <div class="tool">
        <label for="roundSel">Round</label>
        <select id="roundSel">
          <option value="Round 1">Round 1</option>
          <option value="Round 2">Round 2</option>
        </select>
      </div>
    </div>

    <div id="errorBox" class="error"></div>

    <div class="grid">
      <!-- Judges -->
      <section class="panel">
        <h2>Judges</h2>
        <div class="row-actions">
          <div class="search"><input id="judgeSearch" type="text" placeholder="Search judges by name or email…"></div>
          <div class="tiny">
            <label><input type="checkbox" id="selectAllJudges"> Select all</label>
          </div>
        </div>
        <div id="judgeList" class="list"></div>
        <div class="meta-note">Only users with role <b>judge</b> are listed.</div>
      </section>

      <!-- Entries -->
      <section class="panel">
        <h2>Entries</h2>
        <div class="row-actions">
          <div class="search"><input id="entrySearch" type="text" placeholder="Search entries by title/name, id, or category…"></div>
          <div class="tiny">
            <label><input type="checkbox" id="selectAllEntries"> Select all</label>
          </div>
        </div>
        <div id="entryList" class="list"></div>
        <div class="meta-note">Loaded from the <b>applications</b> collection.</div>
      </section>
    </div>

    <div class="footer-actions">
      <span class="pill"><b id="selJudgesCount">0</b> judges selected</span>
      <span class="pill"><b id="selEntriesCount">0</b> entries selected</span>
      <button class="btn-primary" id="assignBtn">Assign</button>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="/__/firebase/12.0.0/firebase-app-compat.js"></script>
  <script src="/__/firebase/12.0.0/firebase-auth-compat.js"></script>
  <script src="/__/firebase/12.0.0/firebase-firestore-compat.js"></script>
  <script src="/__/firebase/init.js?useEmulator=true"></script>

  <script>
    const db = () => firebase.firestore();
    const $ = (id) => document.getElementById(id);

    let ALL_JUDGES = [];
    let ALL_ENTRIES = [];
    const JUDGE_MAP = new Map(); // id -> { id, fullName, email }
    const ENTRY_MAP = new Map(); // id -> { id, entryName, category, subcategory, awards_choice }

    function logout() {
      firebase.auth().signOut().then(() => (window.location.href = "signin.html"));
    }
    function showError(msg) { $('errorBox').textContent = msg || ''; }
    function esc(s) {
      return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
    function updateSelectedPills() {
      $('selJudgesCount').textContent = document.querySelectorAll('.ck-judge:checked').length;
      $('selEntriesCount').textContent = document.querySelectorAll('.ck-entry:checked').length;
    }

    // Render lists
    function renderJudges(list) {
      const box = $('judgeList'); box.innerHTML = '';
      if (!list.length) { box.innerHTML = `<div class="item"><div></div><div class="sub">No judges found.</div></div>`; return; }
      const frag = document.createDocumentFragment();
      list.forEach(j => {
        const el = document.createElement('div');
        el.className = 'item';
        el.innerHTML = `
          <input type="checkbox" class="ck-judge" value="${j.id}">
          <div>
            <div><strong>${esc(j.fullName || '(Unnamed)')}</strong></div>
            <div class="sub">${esc(j.email || '')}</div>
          </div>`;
        frag.appendChild(el);
      });
      box.appendChild(frag);
      box.querySelectorAll('.ck-judge').forEach(cb => cb.addEventListener('change', updateSelectedPills));
      updateSelectedPills();
    }
    function renderEntries(list) {
      const box = $('entryList'); box.innerHTML = '';
      if (!list.length) { box.innerHTML = `<div class="item"><div></div><div class="sub">No entries found.</div></div>`; return; }
      const frag = document.createDocumentFragment();
      list.forEach(e => {
        const line1 = e.entryName || '(Untitled)';
        const line2 = [e.category, e.subcategory, e.awards_choice].filter(Boolean).join(' • ');
        const el = document.createElement('div');
        el.className = 'item';
        el.innerHTML = `
          <input type="checkbox" class="ck-entry" value="${e.id}">
          <div>
            <div><strong>${esc(line1)}</strong></div>
            <div class="sub">${esc(line2)}${line2 ? ' • ' : ''}ID: ${esc(e.id)}</div>
          </div>`;
        frag.appendChild(el);
      });
      box.appendChild(frag);
      box.querySelectorAll('.ck-entry').forEach(cb => cb.addEventListener('change', updateSelectedPills));
      updateSelectedPills();
    }

    // Filters
    function filterJudges(q) {
      q = q.trim().toLowerCase();
      if (!q) return ALL_JUDGES;
      return ALL_JUDGES.filter(j =>
        (j.fullName || '').toLowerCase().includes(q) ||
        (j.email || '').toLowerCase().includes(q)
      );
    }
    function filterEntries(q) {
      q = q.trim().toLowerCase();
      if (!q) return ALL_ENTRIES;
      return ALL_ENTRIES.filter(e =>
        (e.entryName || '').toLowerCase().includes(q) ||
        (e.id || '').toLowerCase().includes(q) ||
        (e.category || '').toLowerCase().includes(q) ||
        (e.subcategory || '').toLowerCase().includes(q) ||
        (e.awards_choice || '').toLowerCase().includes(q)
      );
    } 

    // Helpers
    function toggleAll(selector, checked) {
      document.querySelectorAll(selector).forEach(cb => cb.checked = checked);
      updateSelectedPills();
    }
    function checkedIds(containerSel, boxSel) {
      return Array.from(document.querySelector(containerSel).querySelectorAll(boxSel))
        .filter(cb => cb.checked).map(cb => cb.value);
    }

    // Loads
    async function loadJudges() {
      const snap = await db().collection('users').where('role', '==', 'judge').get();
      ALL_JUDGES = snap.docs.map(d => {
        const x = d.data();
        const fullName = x.fullName || x['full name'] || x.displayName || '';
        const email = x.email || '';
        const j = { id: d.id, fullName, email };
        JUDGE_MAP.set(d.id, j);
        return j;
      });
      renderJudges(ALL_JUDGES);
    }
    async function loadEntries() {
      const snap = await db().collection('applications').get();
      ALL_ENTRIES = snap.docs.map(d => {
        const x = d.data();
        const e = {
          id: d.id,
          entryName: x.entryName || x.name || '',
          category: x.category || '',
          subcategory: x.subcategory || '',
          awards_choice: x.awards_choice || ''
        };
        ENTRY_MAP.set(d.id, e);
        return e;
      });
      renderEntries(ALL_ENTRIES);
    }

    // Fallback getters
    async function getJudgeInfo(id) {
      let j = JUDGE_MAP.get(id);
      if (j && (j.fullName || j.email)) return j;
      try {
        const doc = await db().collection('users').doc(id).get();
        if (doc.exists) {
          const x = doc.data();
          j = { id, fullName: x.fullName || x['full name'] || x.displayName || '', email: x.email || '' };
          JUDGE_MAP.set(id, j);
          return j;
        }
      } catch {}
      return { id, fullName: '', email: '' };
    }
    async function getEntryInfo(id) {
      let e = ENTRY_MAP.get(id);
      if (e && e.entryName) return e;
      try {
        const doc = await db().collection('applications').doc(id).get();
        if (doc.exists) {
          const x = doc.data();
          e = { id, entryName: x.entryName || x.name || '', category: x.category || '', subcategory: x.subcategory || '', awards_choice: x.awards_choice || '' };
          ENTRY_MAP.set(id, e);
          return e;
        }
      } catch {}
      return { id, entryName: '' };
    }

    // Assign (idempotent upsert by judgeId + applicationId)
    async function assignSelected() {
      const judgeIds = checkedIds('#judgeList', '.ck-judge');
      const entryIds = checkedIds('#entryList', '.ck-entry');
      const scoreSet = $('scoreSet').value;
      const round = $('roundSel').value;

      if (!judgeIds.length || !entryIds.length) {
        showError('Select at least one judge and one entry.');
        return;
      }
      showError('');

      const total = judgeIds.length * entryIds.length;
      if (!confirm(`Create or update ${total} assignment${total > 1 ? 's' : ''}?`)) return;

      try {
        const ts = firebase.firestore.FieldValue.serverTimestamp();
        const me = firebase.auth().currentUser?.uid || null;

        for (const judgeId of judgeIds) {
          const j = await getJudgeInfo(judgeId);
          const judgeName = j.fullName || '(Unnamed)';
          const judgeEmail = j.email || '';

          for (const applicationId of entryIds) {
            const e = await getEntryInfo(applicationId);
            const entryName = e.entryName || '(Untitled)';

            // Deterministic doc id to avoid duplicates and allow updates
            const docId = `${judgeId}__${applicationId}`;
            const ref = db().collection('judgeAssignments').doc(docId);

            // Use a transaction to preserve first assignedAt if doc already exists
            await db().runTransaction(async (trx) => {
              const snap = await trx.get(ref);
              if (snap.exists) {
                trx.set(ref, {
                  judgeId,
                  judgeName,
                  judgeEmail,
                  applicationId,
                  entryName,
                  scoreSet,
                  round,
                  method: 'manual',
                  status: snap.data().status || 'pending',
                  assignedBy: me,
                  updatedAt: ts
                }, { merge: true });
              } else {
                trx.set(ref, {
                  judgeId,
                  judgeName,
                  judgeEmail,
                  applicationId,
                  entryName,
                  scoreSet,
                  round,
                  method: 'manual',
                  status: 'pending',
                  assignedAt: ts,
                  assignedBy: me,
                  updatedAt: ts
                }, { merge: true });
              }
            });
          }
        }

        alert('Assignments saved (created/updated) successfully!');
        toggleAll('.ck-judge', false);
        toggleAll('.ck-entry', false);
      } catch (err) {
        console.error(err);
        showError('Failed to save assignments: ' + (err.message || 'permission denied'));
      }
    }

    // Auth + init
    firebase.auth().onAuthStateChanged(async user => {
      if (!user) return (window.location.href = 'signin.html');
      try {
        const me = await db().collection('users').doc(user.uid).get();
        if (!me.exists || me.data().role !== 'admin') {
          return (window.location.href = 'unauthorized.html');
        }
        await Promise.all([loadJudges(), loadEntries()]);
      } catch (e) {
        console.error(e);
        showError('Failed to load data. ' + (e.message || ''));
      }
    });

    // Wire UI
    $('judgeSearch').addEventListener('input', e => renderJudges(filterJudges(e.target.value)));
    $('entrySearch').addEventListener('input', e => renderEntries(filterEntries(e.target.value)));
    $('selectAllJudges').addEventListener('change', e => toggleAll('.ck-judge', e.target.checked));
    $('selectAllEntries').addEventListener('change', e => toggleAll('.ck-entry', e.target.checked));
    $('assignBtn').addEventListener('click', assignSelected);
  </script>
</body>
</html>
