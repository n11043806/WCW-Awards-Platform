<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Judge - Application View</title>
  <style>
    * { box-sizing: border-box; }
    body { margin:0; font-family: Arial, sans-serif; background:#f4f4f4; color:#333; }
    header {
      background:#d7336f; color:#fff; padding:18px 28px; display:flex; align-items:center; justify-content:space-between;
    }
    header h1 { margin:0; font-size:20px; font-weight:600; }
    .logout-btn { background:#fff; color:#d7336f; padding:8px 14px; border-radius:6px; border:0; font-weight:700; cursor:pointer; }
    main { padding:28px; max-width:1100px; margin:0 auto; }

    .top-actions { display:flex; gap:12px; align-items:center; margin-bottom:18px; }
    .back-btn { background:#fff; color:#444; padding:8px 12px; border-radius:6px; border:1px solid #e6e6e6; cursor:pointer; }

    /* layout: left column contains entrant + questions, each question row has judge box on right */
    .left { min-width:0; }
    .card { background:#fff; padding:18px; border-radius:8px; box-shadow:0 4px 14px rgba(0,0,0,0.04); margin-bottom:18px; }
    .card h2 { margin:0 0 12px 0; color:#333; font-weight:600; font-size:18px; }
    .field { background:#fff; padding:12px; border-radius:6px; border:1px solid #f0f0f0; color:#333; margin-bottom:12px; white-space:pre-wrap; line-height:1.45; }
    .label { font-size:15px; color:#666; margin-bottom:8px; display:block; }

    /* per-criterion row: question on left, judge controls on right */
    .criteria-row { display:flex; gap:18px; align-items:flex-start; margin-bottom:18px; }
    .crit-left { flex:1; min-width:0; }
    .crit-judge { width:360px; min-width:260px; }
    .crit-judge .criterion { margin:0; display:flex; gap:10px; align-items:flex-start; border:1px solid #eee; padding:12px; border-radius:6px; background:#fff; }
    .score-box { background:#6e1742; color:#fff; padding:10px 12px; border-radius:6px; min-width:120px; text-align:center; font-weight:700; display:flex; flex-direction:column; align-items:center; gap:8px; }
    .score-box input[type="number"] { width:100%; border:0; padding:6px 8px; border-radius:4px; font-size:16px; }
    .score-help { font-size:12px; color:#fff; opacity:0.9; margin-top:6px; text-align:center; }
    .comment-area { flex:1; }
    .comment-area textarea { width:100%; height:100px; border:1px solid #e0e0e0; border-radius:6px; padding:8px; resize:vertical; }

    /* bottom action buttons (no-op) */
    .bottom-actions { display:flex; gap:12px; justify-content:flex-start; margin:30px 0 60px; }
    .btn { padding:12px 18px; border-radius:8px; border:0; cursor:pointer; font-weight:700; font-size:14px; }
    .btn-save { background:#f7cfd6; color:#8b2a4a; border:2px solid #f7cfd6; }
    .btn-submit { background:#fff; color:#8b2a4a; border:2px solid #8b2a4a; }

    /* New styles for judge actions buttons */
    .judge-actions {
      display: flex;
      gap: 32px;
      margin-top: 32px;
      justify-content: center;
      align-items: center;
    }
    .action-btn {
      background: #fff;
      color: #d7336f;
      border: 2px solid #d7336f;
      border-radius: 8px;
      padding: 12px 40px;
      font-weight: bold;
      font-size: 18px;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    .action-btn:hover {
      background: #ffe6ee;
      color: #b8235a;
    }
    #bottomSaveBtn {
      background: #ffe6ee;
      border-color: #ffe6ee;
      color: #d7336f;
    }
    #bottomSaveBtn:hover {
      background: #ffd6e6;
      color: #b8235a;
    }

    @media(max-width:1000px){
      .criteria-row { flex-direction:column-reverse; }
      .crit-judge { width:100%; min-width:0; }
      .crit-left { width:100%; }
      main { padding:16px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Welcome, <span id="judgeName">Judge</span></h1>
    <div style="display:flex;gap:10px;align-items:center;">
      <!-- Only keep the logout button, remove the top-right back button -->
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </header>

  <main>
    <button onclick="window.location.href='judgedashboard.html'" style="margin-bottom:18px;background:#d7336f;color:#fff;border:none;border-radius:5px;padding:8px 18px;font-weight:bold;cursor:pointer;">&larr; Back to Dashboard</button>
    <div class="top-actions">
      <div style="color:#6e1742;font-size:14px;">Viewing application: <strong id="appIdLabel">-</strong></div>
    </div>

    <div class="left" id="leftContent">
      <div class="card" id="entrantCard">
        <h2>Entrant details</h2>

        <div class="label">Category</div>
        <div id="entrantCategory" class="field">-</div>

        <div class="label">Subcategory</div>
        <div id="entrantSubcategory" class="field">-</div>

        <div class="label">Award</div>
        <div id="entrantAward" class="field">-</div>

        <div class="label">Name</div>
        <div id="entrantFullName" class="field">-</div>

        <div class="label">Website</div>
        <div id="entrantWebsite" class="field">-</div>

        <div class="label">Email Address</div>
        <div id="entrantEmail" class="field">-</div>

        <div class="label">Mobile Number</div>
        <div id="entrantMobile" class="field">-</div>

        <div class="label">Address</div>
        <div id="entrantAddress" class="field">-</div>

        <div class="label">Instagram URL</div>
        <div id="entrantInstagram" class="field">-</div>

        <div class="label">LinkedIn URL</div>
        <div id="entrantLinkedIn" class="field">-</div>
      </div>

      <div id="applicationSections"></div>

      <!-- Place this where your action buttons go -->
      <div class="judge-actions">
        <button id="bottomSaveBtn" class="btn action-btn">Save</button>
        <button id="bottomSubmitBtn" class="btn action-btn">Submit</button>
      </div>
    </div>
  </main>

  <footer style="text-align:center;padding:20px 0;color:#888;font-size:13px;">&copy; 2025 WCW Awards Platform</footer>

  <script src="/__/firebase/12.0.0/firebase-app-compat.js"></script>
  <script src="/__/firebase/12.0.0/firebase-auth-compat.js"></script>
  <script src="/__/firebase/12.0.0/firebase-firestore-compat.js"></script>
  <script src="/__/firebase/init.js?useEmulator=true"></script>

  <script>
  function logout(){
    firebase.auth().signOut().then(()=> location.href='signin.html').catch(e=> alert('Error signing out: '+e.message));
  }

  function qs(name){ const p = new URLSearchParams(location.search); return p.get(name); }
  const APP_ID = qs('id');
  document.getElementById('appIdLabel').textContent = APP_ID || '-' ;

  // build a question row with inline judge controls
  function addCriteriaBlock(key, title, answer, scoreVal, commentVal){
    const container = document.getElementById('applicationSections');
    const row = document.createElement('div');
    row.className = 'criteria-row';

    const left = document.createElement('div');
    left.className = 'crit-left';
    left.innerHTML = `<div class="card"><h2 style="font-size:16px;margin-bottom:8px">${title}</h2><div class="field">${answer || '-'}</div></div>` ;

    const right = document.createElement('div');
    right.className = 'crit-judge';
    right.innerHTML = `
      <div class="criterion" data-crit="${key}">
        <div class="score-box">
          <div style="font-size:13px;">Judging</div>
          <input type="number" min="1" max="10" step="1" id="score_${key}" placeholder=" " ${scoreVal !== undefined ? `value="${scoreVal}"` : ''} />
          <div style="font-size:12px;color:#fff;opacity:0.9">/ 10</div>
        </div>
        <div class="comment-area">
          <div style="font-size:13px;color:#666;margin-bottom:6px;">Comments</div>
          <textarea id="comment_${key}" placeholder="Enter comments...">${commentVal ? commentVal : ''}</textarea>
        </div>
      </div>
    ` ;

    row.appendChild(left);
    row.appendChild(right);
    container.appendChild(row);
  }

  // Map of criteria definitions with EXACT field names in your data
  const CRITERIA_DEFS = [
    { key: 'tellUsAboutYourself', title: 'Tell us about yourself' },
    { key: 'tellUsAboutYourWork', title: 'Tell us about your work' },
    { key: 'whatInspiredYou', title: 'What inspired you to do this work?' },
    { key: 'whatMakesYouUnique', title: 'What makes what you do special or unique?' },
    { key: 'greatestChallenge', title: 'What has been your greatest challenge & how have you addressed this' },
    { key: 'topAchievements', title: 'What have been your top 3 greatest achievements in the past 12 months' },
    { key: 'achievementsSignificance', title: 'Why were these achievements significant and what do you attribute your achievements to' },
    { key: 'bigPictureVision', title: 'What is your big picture vision for the work you are doing' },
    { key: 'recognitionReason', title: 'Why should you be recognised in this category' }
  ];

  // Bottom buttons should do nothing per request
  document.getElementById('bottomSaveBtn').addEventListener('click', async function(e){
    e.preventDefault();
    const uid = firebase.auth().currentUser.uid;
    const scores = {};
    CRITERIA_DEFS.forEach(c => {
      const score = parseInt(document.getElementById('score_' + c.key).value, 10);
      const comment = document.getElementById('comment_' + c.key).value;
      if (!isNaN(score) || comment) {
        scores[c.key] = { score: isNaN(score) ? null : score, comment: comment || "" };
      }
    });

    try {
      await firebase.firestore().collection('judgeResponses').doc(uid + '_' + APP_ID).set({
        judgeId: uid,
        applicationId: APP_ID,
        scores: scores,
        status: "saved",
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
      alert('Progress saved!');
    } catch (err) {
      alert('Error saving: ' + err.message);
    }
  });
  document.getElementById('bottomSubmitBtn').addEventListener('click', async function(e){
    e.preventDefault();
    const uid = firebase.auth().currentUser.uid;
    const scores = {};
    CRITERIA_DEFS.forEach(c => {
      const score = parseInt(document.getElementById('score_' + c.key).value, 10);
      const comment = document.getElementById('comment_' + c.key).value;
      if (!isNaN(score) || comment) {
        scores[c.key] = { score: isNaN(score) ? null : score, comment: comment || "" };
      }
    });

    try {
      await firebase.firestore().collection('judgeResponses').doc(uid + '_' + APP_ID).set({
        judgeId: uid,
        applicationId: APP_ID,
        scores: scores,
        status: "submitted", // <-- set status to submitted
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
      alert('Judging submitted!');
    } catch (err) {
      alert('Error submitting: ' + err.message);
    }
  });

  document.addEventListener('DOMContentLoaded', function() {
    const judgeActionsDiv = document.querySelector('.judge-actions');
    const nextBtn = document.createElement('button');
    nextBtn.id = "nextBtn";
    nextBtn.className = "btn action-btn";
    nextBtn.textContent = "Next";
    judgeActionsDiv.appendChild(nextBtn);

    const orderedAppIds = JSON.parse(localStorage.getItem('judgeOrderedAppIds') || '[]');
    const APP_ID = new URLSearchParams(window.location.search).get('id');
    let currentIndex = orderedAppIds.indexOf(APP_ID);

    // Always show the Next button unless at the last entry
    if (currentIndex !== -1 && currentIndex < orderedAppIds.length - 1) {
      nextBtn.disabled = false;
      nextBtn.style.background = "#fff";
      nextBtn.style.color = "#d7336f";
      nextBtn.style.borderColor = "#d7336f";
      nextBtn.style.cursor = "pointer";
      nextBtn.onclick = function() {
        window.location.href = `judgeapplicationview.html?id=${orderedAppIds[currentIndex + 1]}`;
      };
    } else {
      // At the last entry, show but grey out
      nextBtn.disabled = true;
      nextBtn.style.background = "#eee";
      nextBtn.style.color = "#aaa";
      nextBtn.style.borderColor = "#ccc";
      nextBtn.style.cursor = "not-allowed";
      nextBtn.onclick = null;
    }
  });

  async function fetchApplicationWithFallback(appId, judgeId) {
    const db = firebase.firestore();
    let appData = {};

    // Try reading full application document
    try {
      const appDoc = await db.collection('applications').doc(appId).get();
      if (appDoc.exists) {
        appData = appDoc.data();
        console.log('Loaded full application:', appId);
        return appData;
      }
      console.warn('Application doc not found:', appId);
    } catch (err) {
      // likely permission-denied for judges
      console.warn('Reading applications/' + appId + ' failed, falling back to judgeAssignments:', err);
    }

    // Fallback 1: deterministic assignment doc id `${judgeId}_${appId}`
    try {
      const assignId = `${judgeId}_${appId}`;
      const assignDoc = await db.collection('judgeAssignments').doc(assignId).get();
      if (assignDoc.exists) {
        const a = assignDoc.data();
        console.log('Using assignment summary (doc id):', assignId);
        appData = {
          name: a.entryName || a.name || '-',
          category: a.category || '-',
          subcategory: a.subcategory || '-',
          // add any other summary fields your admin stores on the assignment
          pdfUrl: a.pdfUrl || a.pdfurl || ''
        };
        return appData;
      }
    } catch (err) {
      console.warn('Deterministic assignment lookup failed:', err);
    }

    // Fallback 2: query for assignment where applicationId == appId and judgeId == judgeId
    try {
      const q = await db.collection('judgeAssignments')
        .where('applicationId', '==', appId)
        .where('judgeId', '==', judgeId)
        .limit(1)
        .get();
      if (!q.empty) {
        const a = q.docs[0].data();
        console.log('Using assignment summary (query):', q.docs[0].id);
        appData = {
          name: a.entryName || a.name || '-',
          category: a.category || '-',
          subcategory: a.subcategory || '-',
          pdfUrl: a.pdfUrl || a.pdfurl || ''
        };
        return appData;
      }
    } catch (err) {
      console.warn('Assignment query fallback failed:', err);
    }

    // Nothing available
    return appData;
  }

  // Example: integrate into your existing onAuthStateChanged / loader logic
  // replace your current appDoc fetch with:
  firebase.auth().onAuthStateChanged(async user => {
    if (!user) { location.href = 'signin.html'; return; }
    const uid = user.uid;
    const judgeId = uid;
    const APP_ID = new URLSearchParams(window.location.search).get('id');
    document.getElementById('appIdLabel').textContent = APP_ID || '-';

    try {
      const appData = await fetchApplicationWithFallback(APP_ID, uid);
      console.log('appData used to populate UI:', appData);

      // helper: try candidates + snake_case + lowercase variants
      const toSnake = s => s.replace(/([A-Z])/g, '_$1').replace(/\./g,'_').toLowerCase();
      const pick = (obj, candidates) => {
        if (!obj) return null;
        for (const k of candidates) {
          const variants = [k];
          try { variants.push(toSnake(k)); } catch(e) {}
          variants.push(k.toLowerCase());
          for (const v of variants) {
            if (Object.prototype.hasOwnProperty.call(obj, v) && obj[v] !== undefined && obj[v] !== null && obj[v] !== '') return obj[v];
          }
        }
        return null;
      };

      const setField = (selectors, value) => {
        const val = (value === null || value === undefined || value === '') ? '-' : value;
        for (const sel of selectors) {
          const elById = document.getElementById(sel);
          if (elById) {
            if (elById.tagName === 'INPUT' || elById.tagName === 'TEXTAREA') elById.value = val;
            else elById.textContent = val;
            return true;
          }
          const elByData = document.querySelector(`[data-field="${sel}"]`);
          if (elByData) {
            if (elByData.tagName === 'INPUT' || elByData.tagName === 'TEXTAREA') elByData.value = val;
            else elByData.textContent = val;
            return true;
          }
        }
        return false;
      };

      const d = appData || {};

      setField(['entrantCategory', 'category', 'entryCategory'], pick(d, ['category','categoryName','cat']));
      setField(['entrantSubcategory', 'subcategory', 'entrySubcategory'], pick(d, ['subcategory','sub_category','subCat']));
      setField(['entrantAward','award','entrantAwardChoice'], pick(d, ['awards_choice','award','awardsChoice']));
      setField(['entrantFullName','name','entrantName'], pick(d, ['name','entryName','fullName']));
      setField(['entrantWebsite','website','website_url','url'], pick(d, ['website','website_url','url']));
      setField(['entrantEmail','email','contact_email'], pick(d, ['email','contact_email']));
      setField(['entrantMobile','mobile','mobile_number','phone'], pick(d, ['mobile_number','mobile','phone']));
      setField(['entrantAddress','address','location'], pick(d, ['address','location']));
      setField(['entrantInstagram','instagram','instagram_url'], pick(d, ['instagram_url','instagram']));
      setField(['entrantLinkedIn','linkedin','linkedin_url'], pick(d, ['linkedin_url','linkedin']));

      // Render criteria/questions using CRITERIA_DEFS and saved judge responses
      document.getElementById('applicationSections').innerHTML = '';
      let judgeScores = {};
      try {
        const respDoc = await firebase.firestore().collection('judgeResponses').doc(uid + '_' + APP_ID).get();
        if (respDoc.exists && respDoc.data().scores) judgeScores = respDoc.data().scores;
      } catch (err) {
        console.warn('Failed to load judge responses:', err);
      }

      CRITERIA_DEFS.forEach(c => {
        const answer = pick(d, [c.key, c.altKey || '']) || '-';
        const scoreVal = judgeScores[c.key]?.score;
        const commentVal = judgeScores[c.key]?.comment;
        addCriteriaBlock(c.key, c.title, answer, scoreVal, commentVal);
      });

      // If caller requested auto-print, give the UI a moment to finish rendering then open the print dialog.
      try {
        const params = new URLSearchParams(window.location.search);
        const autoPrint = params.get('autoPrint');
        if (autoPrint === '1' || autoPrint === 'true') {
          // allow layout to settle
          setTimeout(() => {
            try { window.print(); } catch (e) { console.warn('auto-print failed', e); }
          }, 300);
        }
      } catch (e) { /* ignore */ }

    } catch (err) {
      console.error('Failed to load application:', err);
      document.getElementById('applicationSections').innerHTML = '<div style="color:#d7336f;">Error loading application.</div>';
    }
  });
  </script>
</body>
</html>