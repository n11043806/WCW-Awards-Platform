<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Judge - Application View</title>
  <style>
    * { box-sizing: border-box; }
    body { margin:0; font-family: Arial, sans-serif; background:#f4f4f4; color:#333; }
    header {
      background:#d7336f; color:#fff; padding:18px 28px; display:flex; align-items:center; justify-content:space-between;
    }
    header h1 { margin:0; font-size:20px; font-weight:600; }
    .logout-btn { background:#fff; color:#d7336f; padding:8px 14px; border-radius:6px; border:0; font-weight:700; cursor:pointer; }
    main { padding:28px; max-width:1100px; margin:0 auto; }

    .top-actions { display:flex; gap:12px; align-items:center; margin-bottom:18px; }
    .back-btn { background:#fff; color:#444; padding:8px 12px; border-radius:6px; border:1px solid #e6e6e6; cursor:pointer; }

    /* layout: left column contains entrant + questions, each question row has judge box on right */
    .left { min-width:0; }
    .card { background:#fff; padding:18px; border-radius:8px; box-shadow:0 4px 14px rgba(0,0,0,0.04); margin-bottom:18px; }
    .card h2 { margin:0 0 12px 0; color:#333; font-weight:600; font-size:18px; }
    .field { background:#fff; padding:12px; border-radius:6px; border:1px solid #f0f0f0; color:#333; margin-bottom:12px; white-space:pre-wrap; line-height:1.45; }
    .label { font-size:15px; color:#666; margin-bottom:8px; display:block; }

    /* per-criterion row: question on left, judge controls on right */
    .criteria-row { display:flex; gap:18px; align-items:flex-start; margin-bottom:18px; }
    .crit-left { flex:1; min-width:0; }
    .crit-judge { width:360px; min-width:260px; }
    .crit-judge .criterion { margin:0; display:flex; gap:10px; align-items:flex-start; border:1px solid #eee; padding:12px; border-radius:6px; background:#fff; }
    .score-box { background:#6e1742; color:#fff; padding:10px 12px; border-radius:6px; min-width:120px; text-align:center; font-weight:700; display:flex; flex-direction:column; align-items:center; gap:8px; }
    .score-box input[type="number"] { width:100%; border:0; padding:6px 8px; border-radius:4px; font-size:16px; }
    .score-help { font-size:12px; color:#fff; opacity:0.9; margin-top:6px; text-align:center; }
    .comment-area { flex:1; }
    .comment-area textarea { width:100%; height:100px; border:1px solid #e0e0e0; border-radius:6px; padding:8px; resize:vertical; }

    /* bottom action buttons (no-op) */
    .bottom-actions { display:flex; gap:12px; justify-content:flex-start; margin:30px 0 60px; }
    .btn { padding:12px 18px; border-radius:8px; border:0; cursor:pointer; font-weight:700; font-size:14px; }
    .btn-save { background:#f7cfd6; color:#8b2a4a; border:2px solid #f7cfd6; }
    .btn-submit { background:#fff; color:#8b2a4a; border:2px solid #8b2a4a; }

    /* New styles for judge actions buttons */
    .judge-actions {
      display: flex;
      gap: 32px;
      margin-top: 32px;
      justify-content: center;
      align-items: center;
    }
    .action-btn {
      background: #fff;
      color: #d7336f;
      border: 2px solid #d7336f;
      border-radius: 8px;
      padding: 12px 40px;
      font-weight: bold;
      font-size: 18px;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    .action-btn:hover {
      background: #ffe6ee;
      color: #b8235a;
    }
    #bottomSaveBtn {
      background: #ffe6ee;
      border-color: #ffe6ee;
      color: #d7336f;
    }
    #bottomSaveBtn:hover {
      background: #ffd6e6;
      color: #b8235a;
    }

    /* When printing via autoPrint, hide chrome (header, dropdowns, nav buttons) */
    body.auto-print-mode header,
    body.auto-print-mode .profile-menu,
    body.auto-print-mode .profile-dropdown,
    body.auto-print-mode .logout-btn,
    body.auto-print-mode .back-btn,
    body.auto-print-mode .action-buttons,
    body.auto-print-mode .no-print,
    /* Hide judge interaction controls when autoPrint flag is present */
    body.auto-print-mode .judge-actions,
    body.auto-print-mode .action-btn,
    body.auto-print-mode #bottomSaveBtn,
    body.auto-print-mode #bottomSubmitBtn,
    body.auto-print-mode #nextBtn {
      display: none !important;
      visibility: hidden !important;
    }

    /* Make application content use full width when printing */
    body.auto-print-mode main,
    body.auto-print-mode .application-container,
    body.auto-print-mode #applicationSections {
      margin: 0 !important;
      padding: 0 !important;
      width: 100% !important;
    }

    /* Also ensure print media hides chrome regardless of class */
    @media print {
      header, .profile-menu, .profile-dropdown, .logout-btn, .back-btn, .action-buttons, .no-print,
      /* also hide judge controls for printed output */
      .judge-actions, .action-btn, #bottomSaveBtn, #bottomSubmitBtn, #nextBtn {
        display: none !important;
      }
      body { background: #fff !important; color: #000 !important; }
    }

    @media(max-width:1000px){
      .criteria-row { flex-direction:column-reverse; }
      .crit-judge { width:100%; min-width:0; }
      .crit-left { width:100%; }
      main { padding:16px; }
    }
  </style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const params = new URLSearchParams(window.location.search);
    const autoPrint = params.get('autoPrint');
    
    if (autoPrint === '1' || autoPrint === 'true') {
      // Add print mode class
      document.body.classList.add('auto-print-mode');
      
      // Wait for content to be populated before printing
      setTimeout(() => {
        window.print();
      }, 2000);
    }
  });
</script>
</head>
<body>
  <header>
    <h1>Welcome, <span id="judgeName">Judge</span></h1>
    <div style="display:flex;gap:10px;align-items:center;">
      <!-- Only keep the logout button, remove the top-right back button -->
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </header>

  <main>
    <button class="back-btn" onclick="window.location.href='judgedashboard.html'" style="margin-bottom:18px;background:#d7336f;color:#fff;border:none;border-radius:5px;padding:8px 18px;font-weight:bold;cursor:pointer;">&larr; Back to Dashboard</button>
    <div class="top-actions">
      <div style="color:#6e1742;font-size:14px;">Viewing application: <strong id="appIdLabel">-</strong></div>
    </div>

    <div class="left" id="leftContent">
      <div class="card" id="entrantCard">
        <h2>Entrant details</h2>

        <div class="label">Category</div>
        <div id="entrantCategory" class="field">-</div>

        <div class="label">Subcategory</div>
        <div id="entrantSubcategory" class="field">-</div>

        <div class="label">Award</div>
        <div id="entrantAward" class="field">-</div>

        <div class="label">Name</div>
        <div id="entrantFullName" class="field">-</div>

        <div class="label">Website</div>
        <div id="entrantWebsite" class="field">-</div>

        <div class="label">Email Address</div>
        <div id="entrantEmail" class="field">-</div>

        <div class="label">Mobile Number</div>
        <div id="entrantMobile" class="field">-</div>

        <div class="label">Address</div>
        <div id="entrantAddress" class="field">-</div>

        <div class="label">Instagram URL</div>
        <div id="entrantInstagram" class="field">-</div>

        <div class="label">LinkedIn URL</div>
        <div id="entrantLinkedIn" class="field">-</div>
      </div>

      <div id="applicationSections"></div>

      <!-- Place this where your action buttons go -->
      <div class="judge-actions">
        <button id="bottomSaveBtn" class="btn action-btn">Save</button>
        <button id="bottomSubmitBtn" class="btn action-btn">Submit</button>
      </div>
    </div>
  </main>

  <footer style="text-align:center;padding:20px 0;color:#888;font-size:13px;">&copy; 2025 WCW Awards Platform</footer>

  <script src="/__/firebase/12.0.0/firebase-app-compat.js"></script>
  <script src="/__/firebase/12.0.0/firebase-auth-compat.js"></script>
  <script src="/__/firebase/12.0.0/firebase-firestore-compat.js"></script>
  <script src="/__/firebase/init.js?useEmulator=true"></script>

  <script>
  function logout(){
    firebase.auth().signOut().then(()=> location.href='signin.html').catch(e=> alert('Error signing out: '+e.message));
  }

  function qs(name){ const p = new URLSearchParams(location.search); return p.get(name); }
  const APP_ID = qs('id');
  document.getElementById('appIdLabel').textContent = APP_ID || '-' ;

  // build a question row with inline judge controls
  function addCriteriaBlock(key, title, answer, scoreVal, commentVal){
    const container = document.getElementById('applicationSections');
    const row = document.createElement('div');
    row.className = 'criteria-row';

    const left = document.createElement('div');
    left.className = 'crit-left';
    left.innerHTML = `<div class="card"><h2 style="font-size:16px;margin-bottom:8px">${title}</h2><div class="field">${answer || '-'}</div></div>` ;

    const right = document.createElement('div');
    right.className = 'crit-judge';
    right.innerHTML = `
      <div class="criterion" data-crit="${key}">
        <div class="score-box">
          <div style="font-size:13px;">Judging</div>
          <input type="number" min="1" max="10" step="1" id="score_${key}" placeholder=" " ${scoreVal !== undefined ? `value="${scoreVal}"` : ''} />
          <div style="font-size:12px;color:#fff;opacity:0.9">/ 10</div>
        </div>
        <div class="comment-area">
          <div style="font-size:13px;color:#666;margin-bottom:6px;">Comments</div>
          <textarea id="comment_${key}" placeholder="Enter comments...">${commentVal ? commentVal : ''}</textarea>
        </div>
      </div>
    ` ;

    row.appendChild(left);
    row.appendChild(right);
    container.appendChild(row);
  }

// Replace the hardcoded CRITERIA_DEFS in judgeapplicationview.html
let CRITERIA_DEFS = [];

// Add this function to load criteria dynamically
async function loadCriteriaDefinitions() {
  try {
    const db = firebase.firestore();
    
    // Load questions from applicationInfo collection
    const snapshot = await db.collection('applicationInfo')
      .where('Question', '!=', null) // Only docs with Question field
      .get();
    
    if (snapshot.empty) {
      console.warn('No questions found in applicationInfo collection');
      // Use hardcoded fallback
      CRITERIA_DEFS = [
        { key: 'Tell_us_about_yourself', title: 'Tell us about yourself' },
        { key: 'Tell_us_about_your_work', title: 'Tell us about your work' },
        { key: 'What_inspired_you', title: 'What inspired you to do this work?' },
        { key: 'What_makes_you_special_unique', title: 'What makes what you do special or unique?' },
        { key: 'greatest_challenge', title: 'What has been your greatest challenge & how have you addressed this' },
        { key: 'top_greatest_achievements', title: 'What have been your top 3 greatest achievements in the past 12 months' },
        { key: 'achievements_significant', title: 'Why were these achievements significant and what do you attribute your achievements to' },
        { key: 'big_picture_vision', title: 'What is your big picture vision for the work you are doing' },
        { key: 'recognised_in_this_category', title: 'Why should you be recognised in this category' }
      ];
      return;
    }

    // Convert Firestore docs to CRITERIA_DEFS format
    const questions = [];
    snapshot.forEach(doc => {
      const data = doc.data();
      
      // Skip documents that don't have proper question structure
      if (!data.Question || !data.question_ID) return;
      
      const question = {
        key: data.question_ID, // Use question_ID as the key for matching responses
        title: data.Question, // Use Question as the display title
        docId: doc.id, // Store document ID for reference
        wordLimit: data.wordLimit || null
      };
      
      // Extract order from Season2025 field (e.g., "Q1" -> 1)
      const seasonOrder = data.Season2025 || data.season2025;
      if (seasonOrder) {
        const orderMatch = String(seasonOrder).match(/Q?(\d+)/i);
        question.order = orderMatch ? parseInt(orderMatch[1]) : 999;
      } else {
        question.order = 999; // No order specified
      }
      
      questions.push(question);
    });

    // Sort by order field
    questions.sort((a, b) => a.order - b.order);
    
    CRITERIA_DEFS = questions;
    console.log(`Loaded ${CRITERIA_DEFS.length} criteria from applicationInfo:`, CRITERIA_DEFS);
    
  } catch (err) {
    console.error('Error loading criteria definitions:', err);
    // Use hardcoded fallback
    CRITERIA_DEFS = [
      { key: 'Tell_us_about_yourself', title: 'Tell us about yourself' },
      { key: 'Tell_us_about_your_work', title: 'Tell us about your work' },
      { key: 'What_inspired_you', title: 'What inspired you to do this work?' },
      { key: 'What_makes_you_special_unique', title: 'What makes what you do special or unique?' },
      { key: 'greatest_challenge', title: 'What has been your greatest challenge & how have you addressed this' },
      { key: 'top_greatest_achievements', title: 'What have been your top 3 greatest achievements in the past 12 months' },
      { key: 'achievements_significant', title: 'Why were these achievements significant and what do you attribute your achievements to' },
      { key: 'big_picture_vision', title: 'What is your big picture vision for the work you are doing' },
      { key: 'recognised_in_this_category', title: 'Why should you be recognised in this category' }
    ];
  }
}

// Update your existing DOMContentLoaded and firebase.auth().onAuthStateChanged
document.addEventListener('DOMContentLoaded', async function() {
  // Load criteria definitions first
  await loadCriteriaDefinitions();
  
  // Add event listeners for Save and Submit buttons
  document.getElementById('bottomSaveBtn').addEventListener('click', async function() {
    const uid = firebase.auth().currentUser?.uid;
    if (!uid) {
      alert('Please log in first.');
      return;
    }

    const scores = {};
    CRITERIA_DEFS.forEach(c => {
      const scoreElement = document.getElementById('score_' + c.key);
      const commentElement = document.getElementById('comment_' + c.key);
      
      if (scoreElement && commentElement) {
        const score = parseInt(scoreElement.value, 10);
        const comment = commentElement.value;
        if (!isNaN(score) || comment) {
          scores[c.key] = { score: isNaN(score) ? null : score, comment: comment || "" };
        }
      }
    });

    try {
      await firebase.firestore().collection('judgeResponses').doc(uid + '_' + APP_ID).set({
        judgeId: uid,
        applicationId: APP_ID,
        scores: scores,
        status: "saved",
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
      alert('Progress saved successfully!');
    } catch (err) {
      console.error('Save error:', err);
      alert('Error saving: ' + err.message);
    }
  });

  document.getElementById('bottomSubmitBtn').addEventListener('click', async function() {
    const uid = firebase.auth().currentUser?.uid;
    if (!uid) {
      alert('Please log in first.');
      return;
    }

    const scores = {};
    let allScored = true;
    
    CRITERIA_DEFS.forEach(c => {
      const scoreElement = document.getElementById('score_' + c.key);
      const commentElement = document.getElementById('comment_' + c.key);
      
      if (scoreElement && commentElement) {
        const score = parseInt(scoreElement.value, 10);
        const comment = commentElement.value;
        
        if (isNaN(score) || score < 1 || score > 10) {
          allScored = false;
        }
        
        scores[c.key] = { score: isNaN(score) ? null : score, comment: comment || "" };
      }
    });

    if (!allScored) {
      alert('Please score all criteria (1-10) before submitting.');
      return;
    }

    if (!confirm('Are you sure you want to submit your final scores? This action cannot be undone.')) {
      return;
    }

    try {
      await firebase.firestore().collection('judgeResponses').doc(uid + '_' + APP_ID).set({
        judgeId: uid,
        applicationId: APP_ID,
        scores: scores,
        status: "submitted",
        submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
      alert('Scores submitted successfully!');
    } catch (err) {
      console.error('Submit error:', err);
      alert('Error submitting: ' + err.message);
    }
  });

  // Fix the Next button event listener (it was trying to access nextBtn before it was created)
  const judgeActionsDiv = document.querySelector('.judge-actions');
  const nextBtn = document.createElement('button');
  nextBtn.id = "nextBtn";
  nextBtn.className = "btn action-btn";
  nextBtn.textContent = "Next";
  judgeActionsDiv.appendChild(nextBtn);

  // NOW add the event listener after the button is created
  nextBtn.addEventListener('click', async function() {
    const uid = firebase.auth().currentUser?.uid;
    if (!uid) {
      alert('Please log in first.');
      return;
    }

    const scores = {};
    CRITERIA_DEFS.forEach(c => {
      const scoreElement = document.getElementById('score_' + c.key);
      const commentElement = document.getElementById('comment_' + c.key);
      
      if (scoreElement && commentElement) {
        const score = parseInt(scoreElement.value, 10);
        const comment = commentElement.value;
        if (!isNaN(score) || comment) {
          scores[c.key] = { score: isNaN(score) ? null : score, comment: comment || "" };
        }
      }
    });

    try {
      await firebase.firestore().collection('judgeResponses').doc(uid + '_' + APP_ID).set({
        judgeId: uid,
        applicationId: APP_ID,
        scores: scores,
        status: "saved",
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
      alert('Progress saved!');
    } catch (err) {
      console.error('Save error:', err);
      alert('Error saving: ' + err.message);
    }

    const params = new URLSearchParams(window.location.search);
    const currentId = params.get('id');
    const orderedAppIds = JSON.parse(localStorage.getItem('judgeOrderedAppIds') || '[]');
    const currentIndex = orderedAppIds.indexOf(currentId);

    if (currentIndex !== -1 && currentIndex < orderedAppIds.length - 1) {
      const nextId = orderedAppIds[currentIndex + 1];
      window.location.href = `judgeapplicationview.html?id=${nextId}`;
    } else {
      alert('This is the last application in the list.');
    }
  });

  const orderedAppIds = JSON.parse(localStorage.getItem('judgeOrderedAppIds') || '[]');
  const APP_ID = new URLSearchParams(window.location.search).get('id');
  let currentIndex = orderedAppIds.indexOf(APP_ID);

  // Set up Next button styling and behavior
  if (currentIndex !== -1 && currentIndex < orderedAppIds.length - 1) {
    nextBtn.disabled = false;
    nextBtn.style.background = "#fff";
    nextBtn.style.color = "#d7336f";
    nextBtn.style.borderColor = "#d7336f";
    nextBtn.style.cursor = "pointer";
  } else {
    // At the last entry, show but grey out
    nextBtn.disabled = true;
    nextBtn.style.background = "#eee";
    nextBtn.style.color = "#aaa";
    nextBtn.style.borderColor = "#ccc";
    nextBtn.style.cursor = "not-allowed";
  }
});


firebase.auth().onAuthStateChanged(async user => {
  if (!user) { location.href = 'signin.html'; return; }
  
  // Ensure criteria are loaded before proceeding
  if (CRITERIA_DEFS.length === 0) {
    await loadCriteriaDefinitions();
  }
  
  const uid = user.uid;
  const judgeId = uid;
  const APP_ID = new URLSearchParams(window.location.search).get('id');
  document.getElementById('appIdLabel').textContent = APP_ID || '-';

  try {
    // Get application data directly from Firestore
    const db = firebase.firestore();
    let appData = {};
    
    try {
      const appDoc = await db.collection('applications').doc(APP_ID).get();
      if (appDoc.exists) {
        appData = appDoc.data();
        console.log('Loaded application data:', appData);
      }
    } catch (err) {
      console.warn('Could not read application directly:', err);
      // Try judgeAssignments fallback
      try {
        const assignDoc = await db.collection('judgeAssignments').doc(`${uid}_${APP_ID}`).get();
        if (assignDoc.exists) {
          appData = assignDoc.data();
          console.log('Loaded from judge assignments:', appData);
        }
      } catch (err2) {
        console.warn('Could not read judge assignment:', err2);
      }
    }

    console.log('appData used to populate UI:', appData);

    // helper: try candidates + snake_case + lowercase variants
    const toSnake = s => s.replace(/([A-Z])/g, '_$1').replace(/\./g,'_').toLowerCase();
    const pick = (obj, candidates) => {
      if (!obj) return null;
      for (const k of candidates) {
        const variants = [k];
        try { variants.push(toSnake(k)); } catch(e) {}
        variants.push(k.toLowerCase());
        for (const v of variants) {
          if (Object.prototype.hasOwnProperty.call(obj, v) && obj[v] !== undefined && obj[v] !== null && obj[v] !== '') return obj[v];
        }
      }
      return null;
    };

    const setField = (selectors, value) => {
      const val = (value === null || value === undefined || value === '') ? '-' : value;
      for (const sel of selectors) {
        const elById = document.getElementById(sel);
        if (elById) {
          if (elById.tagName === 'INPUT' || elById.tagName === 'TEXTAREA') elById.value = val;
          else elById.textContent = val;
          return true;
        }
        const elByData = document.querySelector(`[data-field="${sel}"]`);
        if (elByData) {
          if (elByData.tagName === 'INPUT' || elByData.tagName === 'TEXTAREA') elByData.value = val;
          else elByData.textContent = val;
          return true;
        }
      }
      return false;
    };

    const d = appData || {};

    setField(['entrantCategory', 'category', 'entryCategory'], pick(d, ['category','categoryName','cat']));
    setField(['entrantSubcategory', 'subcategory', 'entrySubcategory'], pick(d, ['subcategory','sub_category','subCat']));
    setField(['entrantAward','award','entrantAwardChoice'], pick(d, ['awards_choice','award','awardsChoice']));
    setField(['entrantFullName','name','entrantName'], pick(d, ['name','entryName','fullName']));
    setField(['entrantWebsite','website','website_url','url'], pick(d, ['website','website_url','url']));
    setField(['entrantEmail','email','contact_email'], pick(d, ['email','contact_email']));
    setField(['entrantMobile','mobile','mobile_number','phone'], pick(d, ['mobile_number','mobile','phone']));
    setField(['entrantAddress','address','location'], pick(d, ['address','location']));
    setField(['entrantInstagram','instagram','instagram_url'], pick(d, ['instagram_url','instagram']));
    setField(['entrantLinkedIn','linkedin','linkedin_url'], pick(d, ['linkedin_url','linkedin']));

    // Render criteria/questions using CRITERIA_DEFS and saved judge responses
    document.getElementById('applicationSections').innerHTML = '';
    let judgeScores = {};
    try {
      const respDoc = await firebase.firestore().collection('judgeResponses').doc(uid + '_' + APP_ID).get();
      if (respDoc.exists && respDoc.data().scores) judgeScores = respDoc.data().scores;
    } catch (err) {
      console.warn('Failed to load judge responses:', err);
    }

    CRITERIA_DEFS.forEach(c => {
      const answer = pick(d, [c.key, c.altKey || '']) || '-';
      const scoreVal = judgeScores[c.key]?.score;
      const commentVal = judgeScores[c.key]?.comment;
      addCriteriaBlock(c.key, c.title, answer, scoreVal, commentVal);
    });

  } catch (err) {
    console.error('Failed to load application:', err);
    document.getElementById('applicationSections').innerHTML = '<div style="color:#d7336f;">Error loading application.</div>';
  }

  // Set judge name in header
  try {
    const userDoc = await firebase.firestore().collection('users').doc(uid).get();
    if (userDoc.exists) {
      const userData = userDoc.data();
      const name = userData.name || userData.firstName || user.email.split('@')[0];
      document.getElementById('judgeName').textContent = name;
    }
  } catch (err) {
    console.warn('Could not load judge name:', err);
    document.getElementById('judgeName').textContent = user.email.split('@')[0];
  }
});
  </script>
</body>
</html>