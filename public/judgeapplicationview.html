<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Judge - Application View</title>
  <style>
    * { box-sizing: border-box; }
    body { margin:0; font-family: Arial, sans-serif; background:#f4f4f4; color:#333; }
    header {
      background:#d7336f; color:#fff; padding:18px 28px; display:flex; align-items:center; justify-content:space-between;
    }
    header h1 { margin:0; font-size:20px; font-weight:600; }
    .logout-btn { background:#fff; color:#d7336f; padding:8px 14px; border-radius:6px; border:0; font-weight:700; cursor:pointer; }
    main { padding:28px; max-width:1100px; margin:0 auto; }

    .top-actions { display:flex; gap:12px; align-items:center; margin-bottom:18px; }
    .back-btn { background:#fff; color:#444; padding:8px 12px; border-radius:6px; border:1px solid #e6e6e6; cursor:pointer; }

    /* layout: left column contains entrant + questions, each question row has judge box on right */
    .left { min-width:0; }
    .card { background:#fff; padding:18px; border-radius:8px; box-shadow:0 4px 14px rgba(0,0,0,0.04); margin-bottom:18px; }
    .card h2 { margin:0 0 12px 0; color:#333; font-weight:600; font-size:18px; }
    .field { background:#fff; padding:12px; border-radius:6px; border:1px solid #f0f0f0; color:#333; margin-bottom:12px; white-space:pre-wrap; line-height:1.45; }
    .label { font-size:15px; color:#666; margin-bottom:8px; display:block; }

    /* per-criterion row: question on left, judge controls on right */
    .criteria-row { display:flex; gap:18px; align-items:flex-start; margin-bottom:18px; }
    .crit-left { flex:1; min-width:0; }
    .crit-judge { width:360px; min-width:260px; }
    .crit-judge .criterion { margin:0; display:flex; gap:10px; align-items:flex-start; border:1px solid #eee; padding:12px; border-radius:6px; background:#fff; }
    .score-box { background:#6e1742; color:#fff; padding:10px 12px; border-radius:6px; min-width:120px; text-align:center; font-weight:700; display:flex; flex-direction:column; align-items:center; gap:8px; }
    .score-box input[type="number"] { width:100%; border:0; padding:6px 8px; border-radius:4px; font-size:16px; }
    .score-help { font-size:12px; color:#fff; opacity:0.9; margin-top:6px; text-align:center; }
    .comment-area { flex:1; }
    .comment-area textarea { width:100%; height:100px; border:1px solid #e0e0e0; border-radius:6px; padding:8px; resize:vertical; }

    /* bottom action buttons (no-op) */
    .bottom-actions { display:flex; gap:12px; justify-content:flex-start; margin:30px 0 60px; }
    .btn { padding:12px 18px; border-radius:8px; border:0; cursor:pointer; font-weight:700; font-size:14px; }
    .btn-save { background:#f7cfd6; color:#8b2a4a; border:2px solid #f7cfd6; }
    .btn-submit { background:#fff; color:#8b2a4a; border:2px solid #8b2a4a; }

    @media(max-width:1000px){
      .criteria-row { flex-direction:column-reverse; }
      .crit-judge { width:100%; min-width:0; }
      .crit-left { width:100%; }
      main { padding:16px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Welcome, <span id="judgeName">Judge</span></h1>
    <div style="display:flex;gap:10px;align-items:center;">
      <button class="logout-btn" onclick="window.location.href='judgedashboard.html'">Back</button>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </header>

  <main>
    <div class="top-actions">
      <div style="color:#6e1742;font-size:14px;">Viewing application: <strong id="appIdLabel">-</strong></div>
    </div>

    <div class="left" id="leftContent">
      <div class="card" id="entrantCard">
        <h2>Entrant details</h2>

        <div class="label">Category</div>
        <div id="entrantCategory" class="field">-</div>

        <div class="label">Subcategory</div>
        <div id="entrantSubcategory" class="field">-</div>

        <div class="label">Award</div>
        <div id="entrantAward" class="field">-</div>

        <div class="label">Name</div>
        <div id="entrantFullName" class="field">-</div>

        <div class="label">Website</div>
        <div id="entrantWebsite" class="field">-</div>

        <div class="label">Email Address</div>
        <div id="entrantEmail" class="field">-</div>

        <div class="label">Mobile Number</div>
        <div id="entrantMobile" class="field">-</div>

        <div class="label">Address</div>
        <div id="entrantAddress" class="field">-</div>

        <div class="label">Instagram URL</div>
        <div id="entrantInstagram" class="field">-</div>

        <div class="label">LinkedIn URL</div>
        <div id="entrantLinkedIn" class="field">-</div>
      </div>

      <div id="applicationSections"></div>

      <div class="bottom-actions">
        <button class="btn btn-save" id="bottomSaveBtn">SAVE</button>
        <button class="btn btn-submit" id="bottomSubmitBtn">SUBMIT</button>
      </div>
    </div>
  </main>

  <footer style="text-align:center;padding:20px 0;color:#888;font-size:13px;">&copy; 2025 WCW Awards Platform</footer>

  <script src="/__/firebase/12.0.0/firebase-app-compat.js"></script>
  <script src="/__/firebase/12.0.0/firebase-auth-compat.js"></script>
  <script src="/__/firebase/12.0.0/firebase-firestore-compat.js"></script>
  <script src="/__/firebase/init.js?useEmulator=true"></script>

  <script>
    function logout(){
      firebase.auth().signOut().then(()=> location.href='signin.html').catch(e=> alert('Error signing out: '+e.message));
    }

    function qs(name){ const p = new URLSearchParams(location.search); return p.get(name); }
    const APP_ID = qs('id');
    document.getElementById('appIdLabel').textContent = APP_ID || '-';

    // build a question row with inline judge controls
    function addCriteriaBlock(key, title, answer){
      const container = document.getElementById('applicationSections');
      const row = document.createElement('div');
      row.className = 'criteria-row';

      const left = document.createElement('div');
      left.className = 'crit-left';
      left.innerHTML = `<div class="card"><h2 style="font-size:16px;margin-bottom:8px">${title}</h2><div class="field">${answer || '-'}</div></div>`;

      const right = document.createElement('div');
      right.className = 'crit-judge';
      right.innerHTML = `
        <div class="criterion" data-crit="${key}">
          <div class="score-box">
            <div style="font-size:13px;">Judging</div>
            <input type="number" min="1" max="10" step="1" id="score_${key}" placeholder=" " />
            <div style="font-size:12px;color:#fff;opacity:0.9">/ 10</div>
          </div>
          <div class="comment-area">
            <div style="font-size:13px;color:#666;margin-bottom:6px;">Comments</div>
            <textarea id="comment_${key}" placeholder="Enter comments..."></textarea>
          </div>
        </div>
      `;

      row.appendChild(left);
      row.appendChild(right);
      container.appendChild(row);
    }

    // Map of criteria definitions with EXACT field names in your data
    const CRITERIA_DEFS = [
      { key: 'tellUsAboutYourself', title: 'Tell us about yourself' },
      { key: 'tellUsAboutYourWork', title: 'Tell us about your work' },
      { key: 'whatInspiredYou', title: 'What inspired you to do this work?' },
      { key: 'whatMakesYouUnique', title: 'What makes what you do special or unique?' },
      { key: 'greatestChallenge', title: 'What has been your greatest challenge & how have you addressed this' },
      { key: 'topAchievements', title: 'What have been your top 3 greatest achievements in the past 12 months' },
      { key: 'achievementsSignificance', title: 'Why were these achievements significant and what do you attribute your achievements to' },
      { key: 'bigPictureVision', title: 'What is your big picture vision for the work you are doing' },
      { key: 'recognitionReason', title: 'Why should you be recognised in this category' }
    ];

    // Bottom buttons should do nothing per request
    document.getElementById('bottomSaveBtn').addEventListener('click', async function(e){
      e.preventDefault();

      // Get current user
      const user = firebase.auth().currentUser;
      if (!user) {
        alert('Not signed in');
        return;
      }
      const uid = user.uid;

      // Collect scores/comments for each criterion
      const scores = {};
      CRITERIA_DEFS.forEach(c => {
        const scoreVal = parseInt(document.getElementById('score_' + c.key)?.value, 10);
        const commentVal = document.getElementById('comment_' + c.key)?.value || '';
        scores[c.key] = {
          score: isNaN(scoreVal) ? null : scoreVal,
          comment: commentVal
        };
      });

      // Calculate average score (ignoring nulls)
      const scoreValues = Object.values(scores).map(s => s.score).filter(s => typeof s === 'number');
      const averageScore = scoreValues.length ? (scoreValues.reduce((a, b) => a + b, 0) / scoreValues.length) : null;

      // Prepare judge response document
      const judgeDoc = {
        judgeId: uid,
        applicationId: APP_ID,
        scores: scores,
        averageScore: averageScore,
        status: 'draft',
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
      };

      // Save to Firestore (judgeResponses collection, doc id: `${uid}_${APP_ID}`)
      try {
        await firebase.firestore().collection('judgeResponses').doc(uid + '_' + APP_ID).set(judgeDoc, { merge: true });
        alert('Saved as draft!');
      } catch (err) {
        alert('Error saving: ' + err.message);
      }
    });
    document.getElementById('bottomSubmitBtn').addEventListener('click', function(e){
      e.preventDefault();
      // intentionally no-op
    });

    // load application and populate fields + inline criteria
    firebase.auth().onAuthStateChanged(async user => {
      if(!user) { location.href = 'signin.html'; return; }
      const uid = user.uid;
      try {
        const udoc = await firebase.firestore().collection('users').doc(uid).get();
        const name = (udoc.exists && udoc.data().fullName) || user.displayName || 'Judge';
        document.getElementById('judgeName').textContent = name;
      } catch(e){
        console.warn('user fetch failed', e);
      }

      if(!APP_ID){
        console.warn('No application id provided in URL.');
        document.getElementById('applicationSections').innerHTML = '';
        CRITERIA_DEFS.forEach(c => {
          addCriteriaBlock(c.key, c.title, 'asdf');  // For demo showing values
        });
        return;
      }

      try {
        const appDoc = await firebase.firestore().collection('applications').doc(APP_ID).get();
        if(!appDoc.exists){
          console.warn('Application not found.');
          return;
        }
        
        const d = appDoc.data();
        console.log('Application data:', d); // Log for debugging

        // Entrant fields (match applicationhistory)
        document.getElementById('entrantCategory').textContent = d.category || '-';
        document.getElementById('entrantSubcategory').textContent = d.subcategory || '-';
        document.getElementById('entrantAward').textContent = d.award || '-';
        document.getElementById('entrantFullName').textContent = d.name || '-';
        document.getElementById('entrantWebsite').textContent = d.website || '-';
        document.getElementById('entrantEmail').textContent = d.email || '-';
        document.getElementById('entrantMobile').textContent = d.mobile_number || d.mobile || '-';
        document.getElementById('entrantAddress').textContent = d.address || '-';
        document.getElementById('entrantInstagram').textContent = d.instagram_url || d.instagram || '-';
        document.getElementById('entrantLinkedIn').textContent = d.linkedin_url || d.linkedin || '-';

        // For demo/testing - use hardcoded values to match your screenshot if no data
        const mockData = {
          tellUsAboutYourself: 'asdf',
          tellUsAboutYourWork: 'asdf',
          whatInspiredYou: 'asdf',
          whatMakesYouUnique: 'asdf',
          greatestChallenge: 'asdf',
          topAchievements: 'asdf',
          achievementsSignificance: 'asdf',
          bigPictureVision: 'asdf',
          recognitionReason: 'asdf'
        };

        // Render criteria questions with values (use either real data or mock data)
        document.getElementById('applicationSections').innerHTML = '';
        CRITERIA_DEFS.forEach(c => {
          // Try exact field name, or fallback to mock data for demo
          const answer = d[c.key] || mockData[c.key] || '-';
          addCriteriaBlock(c.key, c.title, answer);
        });

        // Load any saved judge responses (optional)
        try {
          const respDoc = await firebase.firestore().collection('judgeResponses').doc(uid + '_' + APP_ID).get();
          if(respDoc.exists){
            const data = respDoc.data();
            if(data && data.scores){
              for(const key in data.scores){
                const s = data.scores[key];
                const scoreEl = document.getElementById('score_' + key);
                const commentEl = document.getElementById('comment_' + key);
                if(scoreEl && s.score !== undefined) scoreEl.value = s.score;
                if(commentEl && s.comment) commentEl.value = s.comment;
              }
            }
          }
        } catch(err) {
          console.warn('Failed to load judge responses:', err);
        }
      } catch(err){
        console.error('Failed to load application:', err);
        // Fall back to showing the structure with mock data
        document.getElementById('applicationSections').innerHTML = '';
        CRITERIA_DEFS.forEach(c => {
          addCriteriaBlock(c.key, c.title, 'asdf'); // For demo showing values
        });
      }
    });
  </script>
</body>
</html>