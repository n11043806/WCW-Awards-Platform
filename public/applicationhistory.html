<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Applications - WCW Awards</title>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; }
    header { background-color: #d7336f; color: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; }
    header h1 { margin: 0; font-size: 24px; }
    .back-btn { background-color: white; color: #d7336f; padding: 8px 16px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
    .back-btn:hover { background-color: #ffe6ee; }
    main { padding: 40px 30px; }
    .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.1); max-width: 1100px; margin: 30px auto; }
    h2 { color: #d7336f; margin-top: 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    th, td { text-align: left; padding: 10px 12px; border-bottom: 1px solid #eee; font-size: 14px; }
    th { background: #faf0f4; color: #8c1f4c; }
    .muted { color: #777; }

    /* Buttons */
    .action-btn {
      border: 2px solid transparent; 
      border-radius: 4px;
      padding: 6px 12px;
      font-weight: 700;
      text-transform: uppercase;
      cursor: pointer;
      transition: background-color .15s ease-in-out, transform .05s ease-in-out;
    }
    .action-btn:active { transform: translateY(1px); }

    /* Filter button  */
    .btn-filter {
      background: #a1466b;
      color: #eec5d6;
      border: 2px solid #572338;
    }
    .btn-filter:hover { background: #eec5d6; color: #572338;}

    /* Continue (draft) */
    .btn-continue {
      background: #ffe6ee;
      color: #8c1f4c;      
      border-color: #ffccd9; 
    }
    .btn-continue:hover { background: #ffccd9; }

    /* View (submitted) */
    .btn-view {
      background: #e1faed;
      color: #1f7a4b;     
      border-color: #c9f2da; 
    }
    .btn-view:hover { background: #c9f2da; }

    /* Delete button */
    .btn-danger {
      background: #eca1a1;
      color: #572338;
      border: 2px solid #eca1a1;
    }
    .btn-danger:hover { background: #572338; color: #f0e4e9; border: 2px solid #f0e4e9;}

    /* Modal */
    .modal {
      position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
      background: rgba(0,0,0,.4); z-index: 1000; padding: 24px;
    }
    .modal.open { display: flex; }
    .modal-dialog {
      background: #fff; border-radius: 10px; max-width: 980px; width: 100%;
      box-shadow: 0 12px 40px rgba(0,0,0,.25); overflow: hidden;
    }
    .modal-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 14px 18px; background: #faf0f4; color: #8c1f4c;
    }
    .modal-body { padding: 18px; max-height: 75vh; overflow: auto; }
    .meta { font-size: 13px; color: #666; margin-bottom: 10px; }


    .section-title {
      margin: 18px 0 10px;
      color: #8c1f4c;
      background: #faf0f4;          
      padding: 8px 12px;
      border-radius: 6px;
    }

    .field-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 10px 16px;
    }
    @media (max-width: 800px) { .field-grid { grid-template-columns: 1fr; } }

    .kv .k { font-weight: 600; font-size: 13px; color: #444; }
    .kv .v { font-size: 14px; color: #000; word-break: break-word; }
    .block {
      border: 1px solid #eee; border-radius: 6px; padding: 10px; background: #fcfcfc;
      white-space: pre-wrap;
    }

    /* Close button */
    .close-btn {
      background: #fff; color: #8c1f4c; border: 2px solid #8c1f4c;  /* updated */
      border-radius: 6px; padding: 6px 12px; font-weight: 700; cursor: pointer;
    }
    .close-btn:hover { background: #ffe6ee; }

    /* Confirm modal buttons layout */
    .confirm-actions { display: flex; gap: 10px; }
    .btn-secondary {
      background: #fff; color: #6c757d; border: 2px solid #6c757d;
      border-radius: 6px; padding: 6px 12px; font-weight: 700; cursor: pointer;
    }
    .btn-secondary:hover { background: #f1f3f5; }

    .list-header { display: flex; align-items: center; justify-content: space-between; gap: 10px; }

    /* Filter modal */
    .filters-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px 18px; }
    @media (max-width: 800px) { .filters-grid { grid-template-columns: 1fr; } }
    .filter-group { border: 1px solid #eee; padding: 10px; border-radius: 6px; background: #fcfcfc; }
    .filter-group h4 { margin: 0 0 8px; color: #8c1f4c; font-size: 16px; }
    .chk { display: flex; align-items: center; gap: 8px; margin: 6px 0; font-size: 14px; }
    .filters-actions { display: flex; gap: 10px; margin-top: 10px; }

    .sort-dropdown {
      position: relative;
      display: inline-block;
      margin-left: 10px;
    }
    .sort-btn {
      background: #fff;
      color: #572338;
      border: 2px solid #572338;
      border-radius: 4px;
      padding: 6px 12px;
      font-weight: 700;
      cursor: pointer;
      min-width: 100px;
      text-align: left;
    }
    .sort-btn:after {
      content: "â–¼";
      float: right;
      font-size: 12px;
      margin-left: 8px;
    }
    .sort-list {
      display: none;
      position: absolute;
      top: 110%;
      left: 0;
      background: #fff;
      border: 1px solid #eee;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      min-width: 120px;
      z-index: 10;
    }
    .sort-list.open { display: block; }
    .sort-list button {
      width: 100%;
      background: none;
      border: none;
      padding: 10px 14px;
      text-align: left;
      font-size: 15px;
      color: #572338;
      cursor: pointer;
    }
    .sort-list button:hover {
      background: #f0e4e9;
    }

    .user-menu-container { display: flex; align-items: center; gap: 10px; position: relative; }
    .user-fullname {
      font-weight: 600;
      color: #fff;
      font-size: 16px;
    }
    .user-circle {
      background: #8d57a0;
      color: #fff;
      border: 2px solid #5f386d;
      border-radius: 50%;
      width: 38px;
      height: 38px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .user-circle:hover {
      background: #5f386d;
    }
    .back-btn { background-color: white; color: #d7336f; padding: 8px 16px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
    .back-btn:hover { background-color: #ffe6ee; }
    .user-dropdown {
      display: none;
      position: absolute;
      top: 60px;
      right: 30px;
      background: #fff0f6;
      border: 1px solid #b8235a;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(215,51,111,0.08);
      min-width: 160px;
      z-index: 100;
      flex-direction: column;
    }
    .user-dropdown button {
      background: none;
      border: none;
      color: #b8235a;
      font-size: 15px;
      text-align: left;
      padding: 12px 18px;
      cursor: pointer;
      width: 100%;
      transition: background 0.15s;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .user-dropdown button:hover {
      background: #ffe6ee;
    }
    .user-dropdown.open {
      display: flex;
    }
    .material-symbols-outlined {
      color: #b8235a;
      vertical-align: middle;
    }

    /* Dark mode styles */
    @media (prefers-color-scheme: dark) {
      body {
        background-color: #121212;
        color: #e0e0e0;
      }
      .container {
        background: #1e1e1e;
        box-shadow: 0 0 15px rgba(0,0,0,0.3);
      }
      .section-title {
        background: #2c2c2c;
        color: #e0e0e0;
      }
      table {
        background: #1e1e1e;
        color: #e0e0e0;
      }
      th {
        background: #2c2c2c;
        color: #e0e0e0;
      }
      .btn-danger {
        background: #581010;
        color: #fff;
        border: 2px solid #652b2b;
      }
      .btn-danger:hover {
        background: #d73434;
        color: #fff;
        border: 2px solid #c62828;
      }
      .user-dropdown {
        background: #2c2c2c;
        border: 1px solid #444;
      }
      .btn-continue {
        background: #5a1f2e;
        color: #ffe6ee;      
        border-color: #7a2a3d; 
      }
      .btn-continue:hover {
        background: #ffccd9;
        color: #572338;      
        border-color: #ff99b3;
      }
      .btn-view {
        background: #5a1f2e;
        color: #ffe6ee;
        border: 2px solid #7a2a3d;
      }
      .btn-view:hover {
        background: #ffccd9;
        color: #572338;
        border-color: #ff99b3;
      }
      .sort-btn {
        background: #5a1f2e;
        color: #ffe6ee;
        border: 2px solid #7a2a3d;
      }
      .sort-btn:after {
        content: "";
        display: inline-block;
        width: 0;
        height: 0;
        border-left: 5px solid transparent;
        border-right: 5px solid transparent;
        border-top: 5px solid #ffe6ee;
        margin-left: 5px;
      }
      .sort-list button {
        color: #ffe6ee;
      }
      .sort-dropdown .sort-list {
        background: #2c2c2c;
        border: 1px solid #444;
      }      
      .sort-btn:hover {
        background: #ffccd9;
        color: #572338;
        border-color: #ff99b3;
      }
      .btn-filter {
        background: #5a1f2e;
        color: #ffe6ee;
        border: 2px solid #7a2a3d;
      }
      .btn-filter:hover {
        background: #ffccd9;
        color: #572338;
        border-color: #ff99b3;
      }      
      .filter-dropdown {
        background: #2c2c2c;
        border: 1px solid #444;
      }
      .close-btn {
        background: #5a1f2e;
        color: #ffe6ee;
        border: 2px solid #7a2a3d;
      }
      .close-btn:hover {
        background: #ffccd9;
        color: #572338;
        border-color: #ff99b3;
      }
      .filter-dropdown {
        background: #2c2c2c;
        border: 1px solid #444;
      }
      .filter-group {
        background: #2c2c2c;
        border: 1px solid #444;
      }
      .filter-group h4 {
        color: #ff99b3;
      }
      .modal-header {
        background: #2c2c2c;
        color: #ff99b3;
        border-bottom: 1px solid #444;
      }
      .modal-body {
        background: #1e1e1e;        
      }
      .section-title {
        background: #2c2c2c;
        color: #ff99b3;
      }
      .kv .k {
        color: #ff99b3;
      }
      .kv .v {
        color: #e0e0e0;
      }
      .block {
        background: #2c2c2c;
        border: 1px solid #444;
      }
    }
  </style>

  <!-- Firebase SDKs -->
  <script src="/__/firebase/12.0.0/firebase-app-compat.js"></script>
  <script src="/__/firebase/12.0.0/firebase-auth-compat.js"></script>
  <script src="/__/firebase/12.0.0/firebase-firestore-compat.js"></script>
  <script src="/__/firebase/init.js?useEmulator=true"></script>
</head>
<body>
  <header>
    <div style="display:flex;align-items:center;justify-content:space-between;width:100%;">
      <h1 style="margin:0;">My Applications</h1>
      <div class="user-menu-container">
        <span id="userFullName" class="user-fullname"></span>
        <button id="userCircle" class="user-circle"></button>
        <button class="back-btn" onclick="goBack()">Back</button>
      </div>
    </div>
    <div id="userDropdown" class="user-dropdown">
      <button onclick="showProfile()">
        Profile <span class="material-symbols-outlined" style="font-size:20px;">person</span>
      </button>
      <button onclick="window.open('https://support.awardforce.com/hc/en-us','_blank')">
        Get help <span class="material-symbols-outlined" style="font-size:20px;">help</span>
      </button>
      <button onclick="logout()">
        Log out <span class="material-symbols-outlined" style="font-size:20px;">logout</span>
      </button>
    </div>
  </header>

  <main>
    <div class="container">
      <div class="list-header">
        <h2>Application History</h2>
        <div style="display:flex;align-items:center;gap:10px;">
          <div class="sort-dropdown" id="sortDropdown">
            <button class="sort-btn" id="sortBtn">SORT BY: -select-</button>
            <div class="sort-list" id="sortList">
              <button data-sort="none">-select-</button>
              <button data-sort="asc">Application ID Ascending</button>
              <button data-sort="desc">Application ID Descending</button>
              <button data-sort="updated_desc">Updated (Newest first)</button>
              <button data-sort="updated_asc">Updated (Oldest first)</button>
            </div>
          </div>
          <button id="openFilter" class="action-btn btn-filter">Filter</button>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th>Application ID</th>
            <th>Category</th>
            <th>Subcategory</th>
            <th>Award</th>
            <th>Stage</th>
            <th>Created</th>
            <th>Updated</th>
            <th>Action</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody id="appsBody">
          <tr><td colspan="10" class="muted">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </main>

  <!-- View Application Modal -->
  <div id="viewModal" class="modal" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-header">
        <div>
          <strong>Application ID:</strong> <span id="modalAppId"></span>
        </div>
        <button id="modalClose" class="close-btn">Close</button>
      </div>
      <div class="modal-body">
        <h3 class="section-title">Start here</h3>
        <div id="modalStartFields" class="field-grid"></div>

        <h3 class="section-title">Criteria</h3>
        <div id="modalCriteriaFields"></div>
      </div>
    </div>
  </div>

  <!-- Confirm Delete/Withdraw Modal -->
  <div id="confirmModal" class="modal" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-header">
        <strong id="confirmTitle">Confirm</strong>
        <button id="confirmClose" class="close-btn">Close</button>
      </div>
      <div class="modal-body">
        <p id="confirmText" style="margin-top:0">Are you sure?</p>
        <div class="confirm-actions">
          <button id="confirmYes" class="action-btn btn-danger">Yes</button>
          <button id="confirmNo" class="close-btn">No</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Filter Modal -->
  <div id="filterModal" class="modal" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-header">
        <strong>Filter</strong>
        <button id="filterClose" class="close-btn">Close</button>
      </div>
      <div class="modal-body">
        <div class="filters-grid">
          <div class="filter-group">
            <h4>Category</h4>
            <div id="flt_categories"></div>
          </div>
          <div class="filter-group">
            <h4>Subcategory</h4>
            <div id="flt_subcategories"></div>
          </div>
          <div class="filter-group">
            <h4>Award</h4>
            <div id="flt_awards"></div>
          </div>
          <div class="filter-group">
            <h4>Stage</h4>
            <div id="flt_stages"></div>
          </div>
        </div>
        <div class="filters-actions">
          <button id="filterApply" class="action-btn btn-view">Done</button>
          <button id="filterClear" class="close-btn">Clear</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    function logout() {
      firebase.auth().signOut().then(() => {
        window.location.href = "signin.html";
      }).catch((error) => {
        alert("Error signing out: " + error.message);
      });
    }
    function showProfile() {
      window.location.href = "applicantprofile.html";
    }
    function goBack() { 
      window.location.href = "applicantdashboard.html"; 
    }

    firebase.auth().onAuthStateChanged(user => {
      const fullNameEl = document.getElementById("userFullName");
      const circleEl = document.getElementById("userCircle");
      if (user) {
        const name = user.displayName || user.email || "User";
        fullNameEl.textContent = name;
        let initials = "U";
        if (user.displayName) {
          initials = user.displayName.split(' ').map(w => w[0]).join('').toUpperCase();
        } else if (user.email) {
          initials = user.email[0].toUpperCase();
        }
        circleEl.textContent = initials;

        // Dark mode check from Firestore
        firebase.firestore().collection("users").doc(user.uid).get().then(doc => {
          if (doc.exists && doc.data().darkMode === "enabled") {
            document.body.classList.add("dark-mode");
          } else {
            document.body.classList.remove("dark-mode");
          }
        }).catch(() => {
          document.body.classList.remove("dark-mode");
        });

      } else {
        window.location.href = "signin.html";
      }
    });
    
    function continueApplication(id) {
      sessionStorage.setItem('continueApplicationId', id);
      window.location.href = `applicationform.html?application=${encodeURIComponent(id)}`;
    }

    
    const modalEl = document.getElementById('viewModal');
    const modalClose = document.getElementById('modalClose');
    modalClose.onclick = () => closeModal();
    modalEl.addEventListener('click', (e) => { if (e.target === modalEl) closeModal(); });
    window.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });
    function openModal() { modalEl.classList.add('open'); modalEl.setAttribute('aria-hidden', 'false'); }
    function closeModal() { modalEl.classList.remove('open'); modalEl.setAttribute('aria-hidden', 'true'); }

    function esc(s) {
      return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
    function fmt(ts) {
      try {
        if (!ts) return "-";
        if (ts.toDate) return ts.toDate().toLocaleString();
        return new Date(ts).toLocaleString();
      } catch { return "-"; }
    }
    function kv(label, value) {
      return `<div class="kv"><div class="k">${esc(label)}</div><div class="v">${esc(value || '-')}</div></div>`;
    }
    function block(label, value) {
      const safe = esc(value || '');
      return `<div class="kv" style="margin-bottom:10px">
                <div class="k" style="margin-bottom:6px">${esc(label)}</div>
                <div class="block">${safe || '-'}</div>
              </div>`;
    }

    // 
    async function viewApp(id) {
      try {
        const db = firebase.firestore();
        const doc = await db.collection('applications').doc(id).get();
        if (!doc.exists) { alert("Application not found."); return; }
        const d = doc.data();

        // Header info
        document.getElementById('modalAppId').textContent = id;

        // Start here fields 
        const startHtml = [
          kv('Category', d.category),
          kv('Subcategory', d.subcategory),
          kv('Award', d.awards_choice),
          kv('Name', d.name),
          kv('Website', d.website),
          kv('Email Address', d.email),
          kv('Mobile Number', d.mobile_number),
          kv('Address', d.address),
          kv('Instagram URL', d.instagram_url),
          kv('LinkedIn URL', d.linkedin_url),
          kv('Stage', d.stage),
          kv('Created', fmt(d.createdAt)),
          kv('Updated', fmt(d.updatedAt))
        ].join('');
        document.getElementById('modalStartFields').innerHTML = startHtml;

        // Criteria fields 
        const critHtml = [
          block('Tell us about yourself', d.tell_us_about_yourself),
          block('Tell us about your work', d.tell_us_about_your_work),
          block('What inspired you to do this work?', d.what_inspired_you),
          block('What makes what you do special or unique?', d.what_makes_you_unique),
          block('What has been your greatest challenge & how have you addressed this', d.greatest_challenge),
          block('What have been your top 3 greatest achievements in the past 12 months', d.top_achievements),
          block('Why were these achievements significant and what do you attribute your achievements to', d.achievements_significance),
          block('What is your big picture vision for the work you are doing', d.big_picture_vision),
          block('Why should you be recognised in this category', d.recognition_reason),
          kv('Eligibility confirmed', d.eligibility ? 'Yes' : 'No')
        ].join('');
        document.getElementById('modalCriteriaFields').innerHTML = critHtml;

        openModal();
      } catch (err) {
        console.error(err);
        alert("Failed to load application: " + err.message);
      }
    }

    // Confirm modal logic
    const cModal = document.getElementById('confirmModal');
    const cTitle = document.getElementById('confirmTitle');
    const cText = document.getElementById('confirmText');
    const cClose = document.getElementById('confirmClose');
    const cNo = document.getElementById('confirmNo');
    const cYes = document.getElementById('confirmYes');
    let pendingAction = null; // { type: 'delete'|'withdraw', id: 'docId' }

    function openConfirm(type, id) {
      pendingAction = { type, id };
      cTitle.textContent = type === 'delete' ? 'Delete application' : 'Withdraw application';
      cText.textContent = type === 'delete'
        ? 'Are you sure you want to delete this application? This cannot be undone!'
        : 'Are you sure you want to withdraw this application? This cannot be undone!';
      cModal.classList.add('open');
      cModal.setAttribute('aria-hidden', 'false');
    }
    function closeConfirm() {
      cModal.classList.remove('open');
      cModal.setAttribute('aria-hidden', 'true');
      pendingAction = null;
    }
    cClose.onclick = closeConfirm;
    cNo.onclick = closeConfirm;
    cModal.addEventListener('click', (e) => { if (e.target === cModal) closeConfirm(); });
    window.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeConfirm(); });

    cYes.onclick = async () => {
      if (!pendingAction) return closeConfirm();
      try {
        const db = firebase.firestore();
        const id = pendingAction.id;
        if (pendingAction.type === 'delete') {
          await db.collection('applications').doc(id).delete();
          document.getElementById('row_' + id)?.remove();
        } else {
          await db.collection('applications').doc(id).set({
            stage: 'withdrawn',
            withdrawnAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
          location.reload();
        }
      } catch (err) {
        console.error(err);
        alert('Operation failed: ' + err.message);
      } finally {
        closeConfirm();
      }
    };

    // Filters 
    const KNOWN_CATEGORIES = [
      'BUSINESS AWARDS','IMPACT AWARDS','INDUSTRY AWARDS','LEADERSHIP AWARDS',"PEOPLE'S CHOICE",'WOMAN OF THE YEAR AWARDS'
    ];
    const KNOWN_AWARDS = [
      'WCWA Americas','WCWA Middle East & North Africa (MENA)','WCWA Czech Republic','WCWA South Africa','WCWA Global 2025'
    ];
    const KNOWN_STAGES = ['draft','submitted'];

    let ALL_APPS = [];            
    let SUBS_BY_CAT = new Map();    
    const FILTERS = {
      categories: new Set(),
      subcategories: new Set(),
      awards: new Set(),
      stages: new Set()
    };

    const fModal = document.getElementById('filterModal');
    const fOpen  = document.getElementById('openFilter');
    const fClose = document.getElementById('filterClose');
    const fApply = document.getElementById('filterApply');
    const fClear = document.getElementById('filterClear');

    function openFilterModal() {
      buildFilterUI();
      fModal.classList.add('open'); fModal.setAttribute('aria-hidden','false');
    }
    function closeFilterModal() {
      fModal.classList.remove('open'); fModal.setAttribute('aria-hidden','true');
    }
    fOpen?.addEventListener('click', openFilterModal);
    fClose?.addEventListener('click', closeFilterModal);
    fModal?.addEventListener('click', (e) => { if (e.target === fModal) closeFilterModal(); });
    window.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeFilterModal(); });

    function uniqSorted(arr) {
      return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>String(a).localeCompare(String(b)));
    }
    function computeSubsByCat() {
      SUBS_BY_CAT = new Map();
      ALL_APPS.forEach(({d}) => {
        const c = d.category || ''; const s = d.subcategory || '';
        if (!c || !s) return;
        if (!SUBS_BY_CAT.has(c)) SUBS_BY_CAT.set(c, new Set());
        SUBS_BY_CAT.get(c).add(s);
      });
    }

    function renderCheckboxList(containerId, values, selectedSet, onChange) {
      const el = document.getElementById(containerId);
      if (!el) return;
      el.innerHTML = values.length
        ? values.map(v => `
            <label class="chk">
              <input type="checkbox" value="${esc(v)}" ${selectedSet.has(v) ? 'checked' : ''}/>
              <span>${esc(v)}</span>
            </label>
          `).join('')
        : `<div class="muted">No options</div>`;
      el.onchange = (e) => {
        if (e.target && e.target.type === 'checkbox') {
          const val = e.target.value;
          if (e.target.checked) selectedSet.add(val);
          else selectedSet.delete(val);
          onChange?.();
        }
      };
    }

    function categoriesList() {
      const fromData = uniqSorted(ALL_APPS.map(({d}) => d.category));
      return uniqSorted([...KNOWN_CATEGORIES, ...fromData]);
    }
    function awardsList() {
      const fromData = uniqSorted(ALL_APPS.map(({d}) => d.awards_choice));
      return uniqSorted([...KNOWN_AWARDS, ...fromData]);
    }
    function stagesList() {
      const fromData = uniqSorted(ALL_APPS.map(({d}) => (d.stage || 'draft').toLowerCase()));
      return uniqSorted([...KNOWN_STAGES, ...fromData]);
    }
    function subcategoriesForSelectedCats() {
      const selectedCats = FILTERS.categories;
      const sets = [];
      if (selectedCats.size === 0) {
        // union of all subcategories
        SUBS_BY_CAT.forEach(s => sets.push(...s));
        return uniqSorted(sets);
      }
      selectedCats.forEach(cat => {
        const set = SUBS_BY_CAT.get(cat);
        if (set) sets.push(...set);
      });
      return uniqSorted(sets);
    }

    function buildFilterUI() {
      // build lists
      const cats = categoriesList();
      const awds = awardsList();
      const stgs = stagesList();

      renderCheckboxList('flt_categories', cats, FILTERS.categories, () => {
        const allowed = new Set(subcategoriesForSelectedCats());
        FILTERS.subcategories.forEach(v => { if (!allowed.has(v)) FILTERS.subcategories.delete(v); });
        renderCheckboxList('flt_subcategories', Array.from(allowed).sort(), FILTERS.subcategories);
      });
      renderCheckboxList('flt_awards', awds, FILTERS.awards);
      renderCheckboxList('flt_stages', stgs, FILTERS.stages);

      // initial subcategories
      renderCheckboxList('flt_subcategories', subcategoriesForSelectedCats(), FILTERS.subcategories);
    }

    function applyFiltersAndRender() {
      const matches = ALL_APPS.filter(({d}) => {
        const stage = (d.stage || 'draft').toLowerCase();
        const catOk  = FILTERS.categories.size     ? FILTERS.categories.has(d.category || '')      : true;
        const subOk  = FILTERS.subcategories.size  ? FILTERS.subcategories.has(d.subcategory || ''): true;
        const awdOk  = FILTERS.awards.size         ? FILTERS.awards.has(d.awards_choice || '')      : true;
        const stgOk  = FILTERS.stages.size         ? FILTERS.stages.has(stage)                      : true;
        return catOk && subOk && awdOk && stgOk;
      });
      renderTable(matches);
    }

    fApply?.addEventListener('click', () => { applyFiltersAndRender(); closeFilterModal(); });
    fClear?.addEventListener('click', () => {
      FILTERS.categories.clear();
      FILTERS.subcategories.clear();
      FILTERS.awards.clear();
      FILTERS.stages.clear();
      buildFilterUI();
      applyFiltersAndRender();
    });

    // Sorting
let SORT_MODE = 'none'; 

const sortBtn = document.getElementById('sortBtn');
const sortList = document.getElementById('sortList');
const sortDropdown = document.getElementById('sortDropdown');

sortBtn.onclick = function(e) {
  sortList.classList.toggle('open');
};

sortList.onclick = function(e) {
  if (e.target.tagName === 'BUTTON') {
    SORT_MODE = e.target.dataset.sort;
    sortBtn.textContent = 'SORT BY: ' + (
      SORT_MODE === 'asc' ? 'Application ID Ascending' :
      SORT_MODE === 'desc' ? 'Application ID Descending' :
      SORT_MODE === 'updated_desc' ? 'Updated (Newest to Oldest)' :
      SORT_MODE === 'updated_asc' ? 'Updated (Oldest to Newest)' :
      '-select-'
    );
    sortList.classList.remove('open');
    applyFiltersAndRender();
  }
};

// Close dropdown if clicking outside
document.addEventListener('click', function(e) {
  if (!sortDropdown.contains(e.target)) {
    sortList.classList.remove('open');
  }
});

function renderTable(items) {
  const body = document.getElementById('appsBody');
  if (!items.length) {
    body.innerHTML = `<tr><td colspan="10" class="muted">No applications match your filters.</td></tr>`;
    return;
  }

  let sorted = [...items];
  if (SORT_MODE === 'asc') {
    sorted.sort((a, b) => String(a.id).localeCompare(String(b.id)));
  } else if (SORT_MODE === 'desc') {
    sorted.sort((a, b) => String(b.id).localeCompare(String(a.id)));
  } else if (SORT_MODE === 'updated_desc') {
    sorted.sort((a, b) => {
      const ta = a.d.updatedAt?.toMillis?.() ?? new Date(a.d.updatedAt).getTime() ?? 0;
      const tb = b.d.updatedAt?.toMillis?.() ?? new Date(b.d.updatedAt).getTime() ?? 0;
      return tb - ta;
    });
  } else if (SORT_MODE === 'updated_asc') {
    sorted.sort((a, b) => {
      const ta = a.d.updatedAt?.toMillis?.() ?? new Date(a.d.updatedAt).getTime() ?? 0;
      const tb = b.d.updatedAt?.toMillis?.() ?? new Date(b.d.updatedAt).getTime() ?? 0;
      return ta - tb;
    });
  }

  body.innerHTML = '';
  sorted.forEach(({id, d}) => {
    const stage = (d.stage || 'draft').toLowerCase();
    const isSubmitted = stage === 'submitted';
    const isWithdrawn = stage === 'withdrawn';

    const label = isSubmitted ? 'VIEW' : 'CONTINUE';
    const handler = isSubmitted ? `viewApp('${id}')` : `continueApplication('${id}')`;
    const btnClass = isSubmitted ? 'btn-view' : 'btn-continue';

    const delLabel = isSubmitted ? 'WITHDRAW' : 'DELETE';
    const delType = isSubmitted ? 'withdraw' : 'delete';
    const delBtn = isWithdrawn
      ? `<span class="muted">WITHDRAWN</span>`
      : `<button class="action-btn btn-danger" onclick="openConfirm('${delType}','${id}')">${delLabel}</button>`;

    const tr = document.createElement('tr');
    tr.id = 'row_' + id;
    tr.innerHTML = `
      <td>${id}</td>
      <td>${d.category || '-'}</td>
      <td>${d.subcategory || '-'}</td>
      <td>${d.awards_choice || '-'}</td>
      <td>${d.stage || '-'}</td>
      <td>${fmt(d.createdAt)}</td>
      <td>${fmt(d.updatedAt)}</td>
      <td><button class="action-btn ${btnClass}" onclick="${handler}">${label}</button></td>
      <td>${delBtn}</td>
    `;
    body.appendChild(tr);
  });
}

    // Load and wire table 
    firebase.auth().onAuthStateChanged(async user => {
      const body = document.getElementById('appsBody');
      if (!user) { window.location.href = "signin.html"; return; }
      try {
        const db = firebase.firestore();
        const snap = await db.collection('applications').where('user_id', '==', user.uid).get();

        ALL_APPS = snap.docs.map(doc => ({ id: doc.id, d: doc.data() }));
        computeSubsByCat();
        renderTable(ALL_APPS);
      } catch (err) {
        body.innerHTML = `<tr><td colspan="10" class="muted">Error: ${err.message}</td></tr>`;
        console.error(err);
      }
    });
const userCircle = document.getElementById("userCircle");
const userDropdown = document.getElementById("userDropdown");
userCircle.onclick = function(e) {
  userDropdown.classList.toggle("open");
};
document.addEventListener("click", function(e) {
  if (!userCircle.contains(e.target) && !userDropdown.contains(e.target)) {
    userDropdown.classList.remove("open");
  }
});    
  </script>
</body>
</html>