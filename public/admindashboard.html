<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - WCW Awards</title>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #fafafa;
      color: #333;
    }
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 220px;
      height: 100vh;
      background-color: #d7336f;
      padding: 20px;
      color: white;
      display: flex;
      flex-direction: column;
    }
    .sidebar h2 {
      text-align: center;
      margin-bottom: 40px;
      font-size: 22px;
    }
    .sidebar a {
      color: white;
      text-decoration: none;
      padding: 10px 15px;
      border-radius: 4px;
      margin-bottom: 10px;
      transition: background-color 0.2s;
    }
    .sidebar a:hover, .sidebar a.active {
      background-color: #b8235a;
    }
    .main-content {
      margin-left: 220px;
      padding: 30px;
    }
    header {
      background-color: #d7336f;
      color: white;
      padding: 20px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logout-btn {
      background-color: white;
      color: #d62d83;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
    }
    .logout-btn:hover { background-color: #ffe6ee; }
    .cards-row, .tab-row {
      display: flex;
      gap: 20px;
      margin: 30px 0;
    }
    .card {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      padding: 20px;
      flex: 1;
      min-width: 260px;
    }
    .card:hover { box-shadow: 0 0 10px rgba(245,1,147,0.2); }
    .card-title {
      font-weight: bold;
      color: #d7336f;
      margin-bottom: 10px;
    }
    .chart-canvas {
      width: 100%;
      height: 200px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      text-align: left;
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }
    th {
      background-color: #fafafa;
      color: #d62d83;
    }
    footer {
      text-align: center;
      color: #888;
      margin-top: 40px;
      font-size: 14px;
    }
  
    .user-menu-container { position: relative; display:flex; gap:10px; align-items:center; }
    .user-fullname { color: #fff; font-weight:600; margin-right:6px; }
    .user-circle { background:#8d57a0;color:#fff;border:2px solid #5f386d;border-radius:50%;width:38px;height:38px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;font-weight:700;}
    .user-dropdown{display:none;position:absolute;top:48px;right:0;background:#fff0f6;border:1px solid #b8235a;border-radius:8px;min-width:180px;z-index:100;flex-direction:column;}
    .user-dropdown.open{display:flex;}
    .user-dropdown button{background:none;border:none;color:#b8235a;padding:12px 18px;text-align:left;cursor:pointer;display:flex;justify-content:space-between;}
    .user-dropdown button:hover{background:#ffe6ee;}

  </style>
</head>
<body>
  <div class="sidebar">
    <h2>WCW Admin</h2>
    <a href="#" class="active">Dashboard</a>
    <a href="adminentriestab.html">Entries</a> 
    <a href="adminusertab.html">Users</a>
    <a href="adminjudgetab.html">Judging</a>
    <a href="#" onclick="logout()">Logout</a>
  </div>
  <div class="main-content">
    <header>
      <div style="display:flex;align-items:center;justify-content:space-between;width:100%">
        <h1>Welcome, <span id="adminName">Trial Account</span></h1>
        <div class="user-menu-container" id="adminUserMenu">
          <span id="userFullName" class="user-fullname"></span>
          <button id="userCircle" class="user-circle" aria-haspopup="true" aria-expanded="false" title="Account">A</button>
          <div id="userDropdown" class="user-dropdown" aria-hidden="true">
            <button onclick="window.location.href='adminprofile.html'">Profile <span class="material-symbols-outlined" style="font-size:18px;">person</span></button>
            <button onclick="window.open('https://support.awardforce.com/hc/en-us','_blank')">Get help <span class="material-symbols-outlined" style="font-size:18px;">help</span></button>
            <button onclick="logout()">Log out <span class="material-symbols-outlined" style="font-size:18px;">logout</span></button>
          </div>
        </div>
      </div>
    </header>
    <div class="cards-row">
      <div class="card" onclick="window.location.href='adminrounddetails.html'" style="cursor:pointer">
        <div class="card-title">WCW25</div><p>Open</p>
      </div>
      <div class="card" onclick="window.location.href='adminjudginground.html'" style="cursor:pointer">
        <div class="card-title">Judging open period</div><p>Open</p>
      </div>
      <div class="card"><div class="card-title">Finalist Videos</div><p>Open</p></div>
      <div class="card"><div class="card-title">Award Status</div><p>Open</p></div>
    </div>

    <div class="cards-row">
      <!-- Completion -->
      <div class="card">
        <div class="card-title">Completion</div>
        <div class="completion-wrap">
          <canvas id="completionChart" class="completion-pie"></canvas>
          <div class="completion-stats">
            <div>
              <strong id="submittedCount">0</strong>
              <span>Submitted</span>
            </div>
            <div>
              <strong id="completedCount">0</strong>
              <span>Completed</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Daily Volume (placeholder) -->
      <div class="card">
        <div class="card-title">Daily Volume</div>
        <canvas id="dailyChart" class="chart-canvas"></canvas>
        <small><span style="color:#d7336f">●</span> Submitted &nbsp;
               <span style="color:#e57373">●</span> Created</small>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Entries by Category</div>
      <table>
        <thead>
          <tr>
            <th>Category</th>
            <th>In Progress</th>
            <th>Submitted</th>
          </tr>
        </thead>
        <tbody id="categoriesBody">
          <tr><td colspan="3">Loading…</td></tr>
        </tbody>
      </table>
    </div>

    <footer>
      &copy; 2025 WCW Awards Platform. All rights reserved.
    </footer>
  </div>

  <!-- Firebase + Chart.js -->
  <script src="/__/firebase/12.0.0/firebase-app-compat.js"></script>
  <script src="/__/firebase/12.0.0/firebase-auth-compat.js"></script>
  <script src="/__/firebase/12.0.0/firebase-firestore-compat.js"></script>
  <script src="/__/firebase/init.js?useEmulator=true"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    function logout() {
      firebase.auth().signOut().then(() => {
        window.location.href = "signin.html";
      });
    }
  
    firebase.auth().onAuthStateChanged(user => {
      if (!user) return window.location.href = "signin.html";
      const uid = user.uid;
      firebase.firestore().collection("users").doc(uid).get().then(doc => {
        const name = doc.exists && doc.data().fullName ? doc.data().fullName : "Trial Account";
        document.getElementById("adminName").textContent = name;
      });
      loadCompletionPie();
      loadMainAwardCounts();
    });

    /** ========= Completion Pie ========= */
    async function loadCompletionPie() {
      const db = firebase.firestore();
      let submitted = 0;
      let completed = 0;

      try {
        const appsSnap = await db.collection("applications").get();
        appsSnap.forEach(doc => {
          const s = (doc.data().status || "").toLowerCase();
          if (s === "submitted") submitted++;
        });

        const jaSnap = await db.collection("judgeAssignments").get();
        jaSnap.forEach(doc => {
          const s = (doc.data().status || "").toLowerCase();
          if (s === "completed") completed++;
        });
      } catch (e) {
        console.warn("Failed to load completion counts:", e?.message || e);
      }

      document.getElementById("submittedCount").textContent = submitted;
      document.getElementById("completedCount").textContent = completed;

      const canvas = document.getElementById("completionChart");
      canvas.width = 180; canvas.height = 180;

      new Chart(canvas, {
        type: "pie",
        data: {
          labels: ["Submitted", "Completed"],
          datasets: [{
            data: [submitted, completed],
            backgroundColor: ["#d62d83", "#4caf50"],
            borderWidth: 0
          }]
        },
        options: {
          responsive: false,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } }
        }
      });
    }
    // wire user menu
    (function wireAdminUserMenu() {
      const userCircle = document.getElementById('userCircle');
      const userDropdown = document.getElementById('userDropdown');
      const userFullNameEl = document.getElementById('userFullName');
      if (userCircle && userDropdown) {
        userCircle.addEventListener('click', ()=> { const open = userDropdown.classList.toggle('open'); userCircle.setAttribute('aria-expanded', open ? 'true' : 'false'); });
        document.addEventListener('click', e => { if (!document.getElementById('adminUserMenu')?.contains(e.target)) { userDropdown.classList.remove('open'); userCircle.setAttribute('aria-expanded', 'false'); }});
      }
      if (window.firebase && firebase.auth) {
        firebase.auth().onAuthStateChanged(user => {
          if (!user) return;
          const name = user.displayName || user.email || 'Admin';
          if (userFullNameEl) userFullNameEl.textContent = name;
          if (userCircle) {
            let initials = user.displayName ? user.displayName.split(' ').map(w=>w[0]).join('').toUpperCase() : (user.email?user.email[0].toUpperCase():'A');
            userCircle.textContent = initials;
          }
        });
      }
    })();

  </script>
</body>
</html>
