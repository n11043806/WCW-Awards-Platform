<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Application Form - WCW Awards</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; }
    header { background-color: #d7336f; color: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; }
    header h1 { margin: 0; font-size: 24px; }
    .back-btn { background-color: white; color: #d7336f; padding: 8px 16px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
    .back-btn:hover { background-color: #ffe6ee; }
    main { padding: 40px 30px; }
    .dates-section { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.1); max-width: 800px; margin: 30px auto; }
    .dates-section h2, .dates-section h3, .dates-section h4 { color: #d7336f; }
    .dates-section ul { font-size: 16px; }
    .dates-section p { font-size: 16px; }
    .start-entry-btn { padding: 12px 20px; background-color: #d7336f; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; margin-top: 20px; }
    .start-entry-btn:hover { background-color: #b8235a; }
    .tab-list { display: flex; gap: 0; margin: 40px auto 0 auto; max-width: 800px; }
    .tab { flex: 1; padding: 16px 0; text-align: center; font-size: 18px; font-weight: 500; border: none; cursor: pointer; background: #888; color: #fff; border-radius: 6px 6px 0 0; margin-right: 2px; }
    .tab.active { background: #b8235a; color: #fff; }
    .tab-content { background: white; min-height: 200px; border-radius: 0 0 10px 10px; box-shadow: 0 0 15px rgba(0,0,0,0.1); max-width: 800px; margin: 0 auto; padding: 30px; }
    .form-group { margin-bottom: 18px; }
    .form-group label { display: block; margin-bottom: 6px; font-weight: 500; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc; font-size: 16px; }
    .form-group textarea { resize: vertical; }
    .word-count { font-size: 13px; color: #888; float: right; }
    .eligibility-check { display: flex; align-items: flex-start; gap: 10px; margin-top: 10px; }
    .submit-btn { padding: 12px 20px; background-color: #d7336f; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; margin-top: 20px; }
    .submit-btn:disabled { background-color: #ccc; cursor: not-allowed; }
    /* Preview modal */
.preview-modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.4); z-index: 1000; padding: 24px; }
.preview-modal.open { display: flex; }
.preview-dialog { background: #fff; border-radius: 10px; max-width: 980px; width: 100%; box-shadow: 0 12px 40px rgba(0,0,0,.25); overflow: hidden; }
.preview-header { display: flex; justify-content: space-between; align-items: center; padding: 14px 18px; background: #faf0f4; color: #8c1f4c; }
.preview-body { padding: 18px; max-height: 75vh; overflow: auto; }
.preview-title { margin: 18px 0 10px; color: #8c1f4c; background: #faf0f4; padding: 8px 12px; border-radius: 6px; }
.preview-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px 16px; }
@media (max-width: 800px) { .preview-grid { grid-template-columns: 1fr; } }
.preview-actions { display: flex; gap: 10px; }
.preview-close { background: #fff; color: #8c1f4c; border: 2px solid #8c1f4c; border-radius: 6px; padding: 8px 14px; font-weight: 700; cursor: pointer; }
.preview-close:hover { background: #ffe6ee; }
.preview-submit { background: #d7336f; color: #fff; border: none; border-radius: 6px; padding: 8px 14px; font-weight: 700; cursor: pointer; }
.preview-submit:disabled { background: #ccc; cursor: not-allowed; }

    .preview-grid > div {
      display: flex;
      align-items: center;
      gap: 8px;              
    }
    .preview-grid label {
      min-width: 150px;   
      font-weight: 600;
      color: #000;
    }
    .preview-grid label::after {
      content: ":";         
      margin-left: 4px;    
    }

    
    .action-btn {
      border: 2px solid transparent;
      border-radius: 4px;
      padding: 8px 14px;
      font-weight: 700;
      text-transform: uppercase;
      cursor: pointer;
      transition: background-color .15s ease-in-out, transform .05s ease-in-out;
    }
    .action-btn:active { transform: translateY(1px); }
    .btn-view { background: #e1faed; color: #1f7a4b; border-color: #c9f2da; }
    .btn-view:hover { background: #c9f2da; }

    .form-actions {
      margin-top: 12px;              
      display: flex;
      gap: 10px;                    
      flex-wrap: wrap;
    }
    .subcat-info { margin-top: 8px; }
    .subcat-title { color: #8c1f4c; font-weight: 700; }
    .subcat-desc { color: #444; margin-top: 4px; }
  </style>
  <!-- Add Firebase SDKs  -->
  <script src="/__/firebase/12.0.0/firebase-app-compat.js"></script>
  <script src="/__/firebase/12.0.0/firebase-auth-compat.js"></script>
  <script src="/__/firebase/12.0.0/firebase-firestore-compat.js"></script>
  
  <script src="/__/firebase/init.js?useEmulator=true"></script>
</head>
<body>
  <header>
    <h1>WCW Awards Application</h1>
    <button class="back-btn" onclick="goBack()">Back</button>
  </header>
  <main>
    <div class="dates-section" id="datesSection">
      <h2>Dates</h2>
      <ul style="margin-bottom: 1.5em;">
        <li>Please note the entry deadline, this date is final and there will be no extensions provided.</li>
        <li>You may edit your entry after submitting, up until the entry deadline for your region.</li>
        <li>Please make sure all your personal details are entered accurately, including contact details.</li>
        <li>You are eligible to enter more than one category, as long as the work submitted meets the criteria.</li>
      </ul>
      <p style="font-style: italic; margin-bottom: 1.5em;">* You can use the ‘copy’ feature to create a copy of your entry and change the category as required.</p>
      <h3>IMPORTANT DATES</h3>
      <h4>GLOBAL:</h4>
      <p>All nominations have now closed for 2025<br>
      Finalists in all categories announced - 17 FEBRUARY 2025</p>
      <p>People’s Choice Voting starts - 24 FEBRUARY 2025<br>
      People’s Choice Voting ends - 10 MARCH 2025</p>
      <p>Winners Announced Global Awards & Summit - London 2-3 APRIL 2025</p>
      <p>For any questions, please contact <a href="mailto:awards@thewomenchangingtheworld.com">awards@thewomenchangingtheworld.com</a></p>
      <h3>Support</h3>
      <p>If you have any questions on the entry process, please contact the organisers by email to <a href="mailto:awards@thewomenchangingtheworld.com">awards@thewomenchangingtheworld.com</a></p>
      <button class="start-entry-btn" id="start-entry-btn">Start Entry</button>
    </div>
    <div id="tabSection" style="display:none;">
      <!-- Only show Start Here tab at first -->
      <div class="tab-list">
        <button class="tab active" id="tabStart">Start here</button>
        <button class="tab" id="tabCriteria" disabled>Criteria</button>
      </div>
      <div id="tabContent" class="tab-content"></div>
    </div>
  </main>
  <div id="previewModal" class="preview-modal" aria-hidden="true">
  <div class="preview-dialog">
    <div class="preview-header">
      <strong>Preview your application</strong>
      <div class="preview-actions">
        <button id="previewClose" class="preview-close">Close</button>
        <button id="previewSubmit" class="preview-submit" disabled>Submit Application</button>
      </div>
    </div>
    <div class="preview-body">
      <h3 class="preview-title">Start here</h3>
      <div class="preview-grid">
        <div>
          <label>Category</label>
          <select id="pv_category">
            <option value="">Select category</option>
            <option value="BUSINESS AWARDS">BUSINESS AWARDS</option>
            <option value="IMPACT AWARDS">IMPACT AWARDS</option>
            <option value="INDUSTRY AWARDS">INDUSTRY AWARDS</option>
            <option value="LEADERSHIP AWARDS">LEADERSHIP AWARDS</option>
            <option value="PEOPLE'S CHOICE">PEOPLE'S CHOICE</option>
            <option value="WOMAN OF THE YEAR AWARDS">WOMAN OF THE YEAR AWARDS</option>
          </select>
        </div>
        <div>
          <label>Award</label>
          <select id="pv_award">
            <option value="">Select award</option>
            <option value="WCWA Americas">WCWA Americas</option>
            <option value="WCWA Middle East & North Africa (MENA)">WCWA Middle East & North Africa (MENA)</option>
            <option value="WCWA Czech Republic">WCWA Czech Republic</option>
            <option value="WCWA South Africa">WCWA South Africa</option>
            <option value="WCWA Global 2025">WCWA Global 2025</option>
          </select>
        </div>
        <div><label>Name</label><input id="pv_name" type="text"></div>
        <div><label>Website</label><input id="pv_website" type="text"></div>
        <div><label>Email</label><input id="pv_email" type="email"></div>
        <div><label>Mobile Number</label><input id="pv_mobile" type="tel"></div>
        <div><label>Address</label><input id="pv_address" type="text"></div>
        <div><label>Instagram URL</label><input id="pv_instagram" type="text"></div>
        <div><label>LinkedIn URL</label><input id="pv_linkedin" type="text"></div>
      </div>

      <h3 class="preview-title">Criteria</h3>
      <div>
        <div class="form-group"><label>Tell us about yourself</label><textarea id="pv_about_yourself" rows="3"></textarea></div>
        <div class="form-group"><label>Tell us about your work</label><textarea id="pv_about_work" rows="3"></textarea></div>
        <div class="form-group"><label>What inspired you?</label><textarea id="pv_inspiration" rows="4"></textarea></div>
        <div class="form-group"><label>What makes you unique?</label><textarea id="pv_unique" rows="4"></textarea></div>
        <div class="form-group"><label>Greatest challenge</label><textarea id="pv_challenge" rows="6"></textarea></div>
        <div class="form-group"><label>Top achievements (last 12 months)</label><textarea id="pv_achievements" rows="5"></textarea></div>
        <div class="form-group"><label>Why achievements significant?</label><textarea id="pv_significance" rows="4"></textarea></div>
        <div class="form-group"><label>Big picture vision</label><textarea id="pv_vision" rows="6"></textarea></div>
        <div class="form-group"><label>Why should you be recognised?</label><textarea id="pv_recognition" rows="6"></textarea></div>

        <div class="eligibility-check">
          <input type="checkbox" id="pv_confirm_eligibility" />
          <label for="pv_confirm_eligibility" style="font-size: 0.98rem; font-weight: 400;">
            I confirm that I do not have a criminal record and that I meet the minimum requirements and am eligible to enter the Women Changing The World Awards.
          </label>
        </div>
      </div>
    </div>
  </div>
</div>
  <script>
    function goBack() {
      window.location.href = "applicantdashboard.html";
    }

    // Tab content templates
    const startHereContent = `
      <form id="startHereForm">
        <div class="form-group">
          <label for="category">Category</label>
          <select id="category" name="category" required>
            <option value="">Select category</option>
            <option value="BUSINESS AWARDS">BUSINESS AWARDS</option>
            <option value="IMPACT AWARDS">IMPACT AWARDS</option>
            <option value="INDUSTRY AWARDS">INDUSTRY AWARDS</option>
            <option value="LEADERSHIP AWARDS">LEADERSHIP AWARDS</option>
            <option value="PEOPLE'S CHOICE">PEOPLE'S CHOICE</option>
            <option value="WOMAN OF THE YEAR AWARDS">WOMAN OF THE YEAR AWARDS</option>
          </select>
        </div>
        <div class="form-group">
          <label for="name">Name</label>
          <input type="text" id="name" name="name" required />
        </div>
        <div class="form-group">
          <label for="website">Website (optional)</label>
          <input type="text" id="website" name="website" />
        </div>
        <div class="form-group">
          <label for="award">Which Awards would you want to enter?</label>
          <select id="award" name="award" required>
            <option value="">Select award</option>
            <option value="WCWA Americas">WCWA Americas</option>
            <option value="WCWA Middle East & North Africa (MENA)">WCWA Middle East & North Africa (MENA)</option>
            <option value="WCWA Czech Republic">WCWA Czech Republic</option>
            <option value="WCWA South Africa">WCWA South Africa</option>
            <option value="WCWA Global 2025">WCWA Global 2025</option>
          </select>
        </div>
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" name="email" required />
        </div>
        <div class="form-group">
          <label for="mobile">Mobile Number</label>
          <input type="tel" id="mobile" name="mobile" required />
        </div>
        <div class="form-group">
          <label for="address">Address</label>
          <input type="text" id="address" name="address" required autocomplete="off"/>
        </div>
        <div class="form-group">
          <label for="instagram">Instagram profile page URL (if applicable)</label>
          <input type="text" id="instagram" name="instagram" />
        </div>
        <div class="form-group">
          <label for="linkedin">LinkedIn profile page URL (if applicable)</label>
          <input type="text" id="linkedin" name="linkedin" />
        </div>
        <div class="form-actions">
          <button type="button" class="action-btn btn-view" id="saveStartHereBtn">Save</button>
          <button type="button" class="action-btn btn-view" id="saveNextBtn">Save & Next</button>
        </div>
      </form>
    `;

    const criteriaContent = `
      <form id="criteriaForm">
        <div class="form-group">
          <label for="about_yourself">Tell us about yourself</label>
          <textarea id="about_yourself" name="about_yourself" maxlength="1200" rows="3"></textarea>
          <span class="word-count" id="count_about_yourself">0/150</span>
        </div>
        <div class="form-group">
          <label for="about_work">Tell us about your work</label>
          <textarea id="about_work" name="about_work" maxlength="1200" rows="3"></textarea>
          <span class="word-count" id="count_about_work">0/150</span>
        </div>
        <div class="form-group">
          <label for="inspiration">What inspired you to do this work?</label>
          <textarea id="inspiration" name="inspiration" maxlength="1600" rows="4"></textarea>
          <span class="word-count" id="count_inspiration">0/200</span>
        </div>
        <div class="form-group">
          <label for="unique">What makes what you do special or unique?</label>
          <textarea id="unique" name="unique" maxlength="1600" rows="4"></textarea>
          <span class="word-count" id="count_unique">0/200</span>
        </div>
        <div class="form-group">
          <label for="challenge">What has been your greatest challenge & how have you addressed this? </label>
          <textarea id="challenge" name="challenge" maxlength="4000" rows="6"></textarea>
          <span class="word-count" id="count_challenge">0/500</span>
        </div>
        <div class="form-group">
          <label for="achievements">What have been your top 3 greatest achievements in the past 12 months? </label>
          <textarea id="achievements" name="achievements" maxlength="2400" rows="5"></textarea>
          <span class="word-count" id="count_achievements">0/300</span>
        </div>
        <div class="form-group">
          <label for="significance">Why were these achievements significant and what do you attribute your achievements to?</label>
          <textarea id="significance" name="significance" maxlength="1600" rows="4"></textarea>
          <span class="word-count" id="count_significance">0/200</span>
        </div>
        <div class="form-group">
          <label for="vision">What is your big picture vision for the work you are doing? </label>
          <textarea id="vision" name="vision" maxlength="4000" rows="6"></textarea>
          <span class="word-count" id="count_vision">0/500</span>
        </div>
        <div class="form-group">
          <label for="recognition">Why should you be recognised in this category? </label>
          <textarea id="recognition" name="recognition" maxlength="4000" rows="6"></textarea>
          <span class="word-count" id="count_recognition">0/500</span>
        </div>
        <div class="eligibility-check">
          <input type="checkbox" id="confirm-eligibility" />
          <label for="confirm-eligibility" style="font-size: 0.98rem; font-weight: 400;">
            I confirm that I do not have a criminal record and that I meet the minimum requirements and am eligible to enter the Women Changing The World Awards.
          </label>
        </div>
        <div class="form-actions">
          <button type="button" class="action-btn btn-view" id="saveCriteriaBtn">Save</button>
          <button type="button" class="action-btn btn-view" id="previewBtn">Preview</button>
        </div>
      </form>
    `;

    // Single source of truth for state
    let applicationId = null;
    let currentUser = null;
    firebase.auth().onAuthStateChanged(u => { currentUser = u; });

    // Show tab section on Start Entry
    document.getElementById('start-entry-btn').onclick = function() {
      document.getElementById('datesSection').style.display = 'none';
      document.getElementById('tabSection').style.display = 'block';
      document.getElementById('tabContent').innerHTML = startHereContent;
      setUpStartHereTab();
    };

    // Tabs
    document.getElementById('tabStart').onclick = function() {
      document.getElementById('tabStart').classList.add('active');
      document.getElementById('tabCriteria').classList.remove('active');
      document.getElementById('tabContent').innerHTML = startHereContent;
      setUpStartHereTab();
    };
    document.getElementById('tabCriteria').onclick = function() {
      document.getElementById('tabStart').classList.remove('active');
      document.getElementById('tabCriteria').classList.add('active');
      document.getElementById('tabContent').innerHTML = criteriaContent;
      setUpCriteriaTab();
    };

    // Helpers
    const db = () => firebase.firestore();

    function allInputsDisabled(rootEl) {
      const els = (rootEl || document).querySelectorAll('input, select, textarea, button');
      els.forEach(el => el.disabled = true);
    }

    // Prefill from last-saved document
    async function getApplicationData() {
      if (!applicationId) return null;
      try {
        const snap = await db().collection('applications').doc(applicationId).get();
        return snap.exists ? snap.data() : null;
      } catch (e) {
        console.error('Failed to fetch application', e);
        return null;
      }
    }
    function setVal(form, id, value) {
      const el = form.querySelector('#' + id);
      if (el) el.value = value ?? '';
    }
    async function hydrateStartHereForm() {
      const form = document.getElementById('startHereForm');
      if (!form) return;
      const data = await getApplicationData();
      if (!data) return;
      const setVal = (id, value) => { const el = form.querySelector('#' + id); if (el) el.value = value ?? ''; };

      setVal('category', data.category);
      ensureSubcategoryUI();
      populateSubcategoryUI(data.category || '', data.subcategory || '');

      setVal('name', data.name);
      setVal('website', data.website);
      setVal('award', data.awards_choice);
      setVal('email', data.email);
      setVal('mobile', data.mobile_number);
      setVal('address', data.address);
      setVal('instagram', data.instagram_url);
      setVal('linkedin', data.linkedin_url);
    }
    async function hydrateCriteriaForm() {
      const form = document.getElementById('criteriaForm');
      if (!form) return;
      const data = await getApplicationData();
      if (!data) return;
      setVal(form, 'about_yourself', data.tell_us_about_yourself);
      setVal(form, 'about_work', data.tell_us_about_your_work);
      setVal(form, 'inspiration', data.what_inspired_you);
      setVal(form, 'unique', data.what_makes_you_unique);
      setVal(form, 'challenge', data.greatest_challenge);
      setVal(form, 'achievements', data.top_achievements);
      setVal(form, 'significance', data.achievements_significance);
      setVal(form, 'vision', data.big_picture_vision);
      setVal(form, 'recognition', data.recognition_reason);
      const cb = form.querySelector('#confirm-eligibility');
      if (cb) cb.checked = !!data.eligibility;
      const submitBtn = form.querySelector('#submit-application');
      if (submitBtn) submitBtn.disabled = cb ? !cb.checked : true;
    }

    function collectStartHere(form) {
      const val = id => (form.querySelector('#' + id)?.value || '');
      const category = val('category');
      const subcategory = val('subcategory');
      const meta = findSubcatMeta(category, subcategory);
      return {
        category,
        subcategory,
        subcategory_title: meta?.title || '',
        subcategory_description: meta?.desc || '',
        name: val('name'),
        website: val('website'),
        awards_choice: val('award'),
        email: val('email'),
        mobile_number: val('mobile'),
        address: val('address'),
        instagram_url: val('instagram'),
        linkedin_url: val('linkedin')
      };
    }

    function collectCriteria(form) {
      const val = id => (form.querySelector('#' + id)?.value || '');
      return {
        tell_us_about_yourself: val('about_yourself'),
        tell_us_about_your_work: val('about_work'),
        what_inspired_you: val('inspiration'),
        what_makes_you_unique: val('unique'),
        greatest_challenge: val('challenge'),
        top_achievements: val('achievements'),
        achievements_significance: val('significance'),
        big_picture_vision: val('vision'),
        recognition_reason: val('recognition'),
        eligibility: !!form.querySelector('#confirm-eligibility')?.checked
      };
    }

    // Create/update Start Here data and keep the same document
    async function saveStartHereToFirestore() {
      if (!currentUser) throw new Error('Not signed in');
      const form = document.getElementById('startHereForm');
      if (!form) throw new Error('Start Here form not found');

      await ensureApplicationDoc();
      const payload = {
        ...collectStartHere(form),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        stage: 'draft',
        user_id: currentUser.uid,
        applicant_id: currentUser.uid
      };
      await firebase.firestore().collection('applications').doc(applicationId).set(payload, { merge: true });
    }

    // 
    async function ensureApplicationDoc() {
      if (applicationId) return applicationId;
      if (!currentUser) throw new Error('Not signed in');
      const base = {
        stage: 'draft',
        user_id: currentUser.uid,
        applicant_id: currentUser.uid,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      const docRef = await db().collection('applications').add(base);
      applicationId = docRef.id;
      return applicationId;
    }

    // START HERE handlers
    function setUpStartHereTab() {
      const saveBtn = document.getElementById('saveStartHereBtn');
      const nextBtn = document.getElementById('saveNextBtn');

      if (saveBtn) {
        saveBtn.onclick = async function () {
          try {
            await saveStartHereToFirestore();
            alert('Application saved as draft.');
          } catch (err) {
            console.error(err);
            alert('Failed to save application: ' + err.message);
          }
        };
      }

      if (nextBtn) {
        nextBtn.onclick = async function () {
          try {
            await saveStartHereToFirestore();
            const critTab = document.getElementById('tabCriteria');
            if (critTab) {
              critTab.disabled = false;
              critTab.click();
            }
          } catch (err) {
            console.error(err);
            alert('Failed to save application: ' + err.message);
          }
        };
      }

      // Prefill with last-saved data
      hydrateStartHereForm();

      // Wire category change → refresh subcats
      const catEl = document.getElementById('category');
      if (catEl) {
        ensureSubcategoryUI();
        populateSubcategoryUI(catEl.value || '', null);
        catEl.onchange = () => populateSubcategoryUI(catEl.value, null);
      }
    }

    // CRITERIA handlers
    function setUpCriteriaTab() {
      const saveBtn = document.getElementById('saveCriteriaBtn');
      const checkbox = document.getElementById('confirm-eligibility');
      const previewBtn = document.getElementById('previewBtn');

      if (saveBtn) {
        saveBtn.onclick = async function () {
          try {
            if (!currentUser) throw new Error('Not signed in');
            const form = document.getElementById('criteriaForm');
            if (!form) throw new Error('Criteria form not found');

            await ensureApplicationDoc();
            const payload = {
              ...collectCriteria(form),
              updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
              stage: 'draft'
            };
            await db().collection('applications').doc(applicationId).set(payload, { merge: true });
            alert('Criteria saved as draft.');
          } catch (err) {
            console.error(err);
            alert('Failed to save criteria: ' + err.message);
          }
        };
      }

      // Open preview 
      if (previewBtn) {
        previewBtn.onclick = async function () {
          try {
            await openPreviewModal();
          } catch (err) {
            console.error(err);
            alert('Failed to open preview: ' + err.message);
          }
        };
      }

      if (checkbox) {
        checkbox.onchange = () => {};
      }

      // Prefill with last-saved data
      hydrateCriteriaForm();
    }

    // --- Category → Subcategory Map (value, title, desc) ---
    const CATEGORY_MAP = {
      "BUSINESS AWARDS": [
        { value: "BUSINESS OF THE YEAR", title: "WOMEN CHANGING THE WORLD - BUSINESS OF THE YEAR", desc: "This award recognises exceptional women in business" },
        { value: "MICRO BUSINESS OF THE YEAR", title: "WOMEN CHANGING THE WORLD - MICRO BUSINESS OF THE YEAR", desc: "This award recognises exceptional women in micro business" },
        { value: "SMALL BUSINESS OF THE YEAR", title: "WOMEN CHANGING THE WORLD - SMALL BUSINESS OF THE YEAR", desc: "This award recognises exceptional women in small business" },
        { value: "SOCIAL ENTERPRISE AWARD", title: "WOMEN CHANGING THE WORLD SOCIAL ENTERPRISE AWARD", desc: "This award recognises individuals who are making a difference as a social enterprise founder or team" }
      ],
      "IMPACT AWARDS": [
        { value: "ADVOCACY IMPACT", title: "ADVOCACY IMPACT", desc: "" },
        { value: "CULTURAL DIVERSITY AND INCLUSION IMPACT", title: "WOMEN CHANGING THE WORLD - DIVERSITY AND INCLUSION IMPACT AWARD", desc: "This award recognises exceptional women that are changing the World in diversity and inclusion initiatives" },
        { value: "DISABILITY INCLUSION IMPACT", title: "DISABILITY INCLUSION IMPACT", desc: "" },
        { value: "GENDER EMPOWERMENT", title: "GENDER EMPOWERMENT", desc: "" },
        { value: "GENDER EQUALITY", title: "GENDER EQUALITY", desc: "" },
        { value: "GLOBAL IMPACT", title: "WOMEN CHANGING THE WORLD – GLOBAL IMPACT", desc: "This award recognises exceptional women that are changing the world in global initiatives" },
        { value: "HUMAN RIGHTS", title: "HUMAN RIGHTS", desc: "" },
        { value: "HUMANITARIAN IMPACT", title: "WOMEN CHANGING THE WORLD - HUMANITARIAN IMPACT", desc: "This award recognises exceptional women that are changing the world in humanitarian initiatives" },
        { value: "RURAL AND REGIONAL AREAS IMPACT", title: "WOMEN CHANGING THE WORLD IN RURAL AND REGIONAL AREAS IMPACT AWARD", desc: "This award recognises rural, remote & regional women that have achieved outstanding results" },
        { value: "VOLUNTEER OF THE YEAR", title: "VOLUNTEER OF THE YEAR", desc: "" },
        { value: "YOUTH IMPACT", title: "YOUTH IMPACT", desc: "" }
      ],
      "INDUSTRY AWARDS": [
        { value: "COACH OF THE YEAR", title: "WOMEN CHANGING THE WORLD COACH OF THE YEAR", desc: "This award recognises exceptional women that are changing the World through coaching and mentoring" },
        { value: "HEALTHTECH INNOVATION", title: "HEALTHTECH INNOVATION", desc: "" },
        { value: "INNOVATION AWARD", title: "WOMEN CHANGING THE WORLD INNOVATION AWARD", desc: "This award recognises women that have a creative, scalable, interesting and innovative idea, innovation or concept to change the world" },
        { value: "TECH INNOVATION", title: "TECH INNOVATION", desc: "" },
        { value: "WELLNESS & WELLBEING PROGRAMS", title: "WELLNESS & WELLBEING PROGRAMS", desc: "" },
        { value: "WELLNESS & WELLBEING SERVICES", title: "WELLNESS & WELLBEING SERVICES", desc: "" },
        { value: "WOMAN IN CORPORATE & PUBLIC SECTOR", title: "WOMEN CHANGING THE WORLD IN THE PUBLIC SECTOR", desc: "This award recognises exceptional women that are changing the World through public sector roles" },
        { value: "WOMAN IN CREATIVE INDUSTRIES (INACTIVE FOR ENTRANTS)", title: "WOMEN CHANGING THE WORLD IN CREATIVE INDUSTRIES", desc: "This award recognises exceptional women that are changing the world in creative fields" },
        { value: "WOMAN IN CREATIVE INDUSTRIES", title: "WOMAN IN CREATIVE INDUSTRIES", desc: "This award recognises exceptional women sharing their creativity with the world" },
        { value: "WOMAN IN EDUCATION - CHILDREN'S EDUCATION", title: "WOMAN IN EDUCATION - CHILDREN'S EDUCATION", desc: "" },
        { value: "WOMAN IN EDUCATION - EARLY CHILDHOOD EDUCATION", title: "WOMAN IN EDUCATION - EARLY CHILDHOOD EDUCATION", desc: "" },
        { value: "WOMAN IN FASHION & TEXTLIES", title: "WOMAN IN FASHION & TEXTLIES", desc: "This award recognises exceptional women in fashion" },
        { value: "WOMAN IN LITERATURE - CHILDRENS BOOKS", title: "WOMAN IN LITERATURE - CHILDRENS BOOKS", desc: "" },
        { value: "WOMAN IN PERSONAL SERVICES", title: "WOMAN IN PERSONAL SERVICES", desc: "" },
        { value: "WOMAN IN SCIENCE", title: "WOMEN CHANGING THE WORLD IN SCIENCE", desc: "This award recognises exceptional women that are changing the World in Science" },
        { value: "WOMAN IN THERAPY & CONSELLING SERVICES", title: "WOMAN IN THERAPY & CONSELLING SERVICES", desc: "" },
        { value: "WOMAN IN TRAVEL, RETREATS AND EVENTS", title: "WOMAN IN TRAVEL, RETREATS AND EVENTS AWARD", desc: "" },
        { value: "WOMAN IN ACADEMIC", title: "WOMEN CHANGING THE WORLD IN EDUCATION", desc: "This award recognises exceptional women in Education that are changing the World" },
        { value: "WOMAN IN AGRICULTURE & FARMING", title: "WOMEN CHANGING THE WORLD IN AGRICULTURE & FARMING", desc: "This award recognises exceptional women that are changing the World through agriculture and farming" },
        { value: "WOMAN IN ADULT EDUCATION & TRAINING", title: "WOMEN IN EDUCATION - ADULT EDUCATION & TRAINING", desc: "" },
        { value: "WOMAN IN ENGINEERING", title: "WOMEN CHANGING THE WORLD IN ENGINEERING", desc: "This award recognises exceptional women that are changing the World in engineering fields" },
        { value: "WOMAN IN FINANCE", title: "WOMEN CHANGING THE WORLD IN FINANCE", desc: "This award recognises exceptional women that are changing the World in Finance" },
        { value: "WOMAN IN FOOD AND BEVERGAES", title: "WOMEN CHANGING THE WORLD IN FOOD AND BEVERAGES", desc: "This award recognises exceptional women that are changing the World through food and beverage fields" },
        { value: "WOMAN IN HEALTH", title: "WOMEN CHANGING THE WORLD IN HEALTH", desc: "This award recognises exceptional women that are changing the World in Health" },
        { value: "WOMAN IN JOURNALISM AND MEDIA", title: "WOMEN CHANGING THE WORLD IN JOURNALISM AND MEDIA", desc: "This award recognises exceptional women that are changing the World in Journalism and Media" },
        { value: "WOMAN IN LAW", title: "WOMEN CHANGING THE WORLD IN LAW", desc: "This award recognises exceptional women that are changing the world through law" },
        { value: "WOMAN IN LITERATIRE", title: "WOMEN CHANGING THE WORLD IN LITERATURE", desc: "This award recognises women committed to changing the world through the power of writing" },
        { value: "WOMAN IN PROFESSIONAL SERVICES", title: "WOMAN IN PROFESSIONAL SERVICES", desc: "This award recognises exceptional women in professional service roles" },
        { value: "WOMAN IN SPORT", title: "WOMEN CHANGING THE WORLD IN SPORT", desc: "This award recognises exceptional women that are changing the World in sport" },
        { value: "WOMAN IN SUSTAINABILITY", title: "WOMEN CHANGING THE WORLD IN SUSTAINABILITY", desc: "This award recognises women committed to changing the world through sustainable and eco-friendly practices, advocacy or awareness" },
        { value: "WOMAN IN TECH", title: "WOMEN CHANGING THE WORLD IN TECH", desc: "This award recognises women changing the world through the introduction or improvement of an idea, method, technology, process or application" }
      ],
      "LEADERSHIP AWARDS": [
        { value: "BIG IDEA", title: "EMERGING LEADER OF THE YEAR", desc: "This award recognises exceptional women in emerging leadership roles (women under 35)" },
        { value: "DISABILITY LEADERSHIP AWARD", title: "WOMEN CHANGING THE WORLD – DISABILITY LEADERSHIP AWARD", desc: "This award recognises exceptional disabled women leaders that are changing the world" },
        { value: "FIRST NATIONS LEADERSHIP", title: "WOMEN CHANGING THE WORLD - FIRST NATIONS LEADERSHIP AWARD", desc: "This award recognises First Nations Women that are changing the world. *Must be First Nations to be eligible" },
        { value: "LEADER OF THE YEAR", title: "LEADER OF THE YEAR", desc: "This award recognises exceptional women in leadership roles" },
        { value: "LGBTQI+ LEADERSHIP AWARD", title: "WOMEN CHANGING THE WORLD – LGBTQI+ LEADERSHIP AWARD", desc: "This award recognises exceptional LGBTQI+ leaders that are changing the world" },
        { value: "MIGRANT LEADERSHIP AWARD", title: "WOMEN CHANGING THE WORLD - MIGRANT LEADERSHIP AWARD", desc: "This award recognises Migrant leaders that are changing the world" },
        { value: "TECH LEADER OF THE YEAR", title: "TECH LEADER OF THE YEAR AWARD", desc: "" },
        { value: "THOUGHT LEADER OF THE YEAR", title: "THOUGHT LEADER OF THE YEAR", desc: "This award recognises exceptional women Thought Leaders sharing their knowledge with the world" }
      ],
      "PEOPLE'S CHOICE": [
        { value: "People's Choice - BUSINESS", title: "People's Choice - BUSINESS", desc: "Most popular business making a difference as determined by people’s choice voting" },
        { value: "People's Choice - DIVERSITY AND INCLUSION", title: "People's Choice - DIVERSITY AND INCLUSION", desc: "Most popular diversity and inclusion focused business making a difference as determined by people’s choice voting" },
        { value: "People's Choice - EDUCATION", title: "People's Choice - EDUCATION", desc: "Most popular education business or organisation making a difference as determined by people’s choice voting" },
        { value: "People's Choice - ENVIRONMENTAL IMPACT", title: "People's Choice - ENVIRONMENTAL IMPACT", desc: "Most popular environmental impact business or organisation making a difference as determined by people’s choice voting" },
        { value: "People's Choice - GENDER EQUALITY", title: "People's Choice - GENDER EQUALITY", desc: "Most popular organisation making a difference by taking action or raising awareness for gender equality" },
        { value: "People's Choice - GLOBAL IMPACT", title: "People's Choice - GLOBAL IMPACT", desc: "Most popular global impact business or organisation making a difference as determined by people’s choice voting" },
        { value: "People's Choice - HEALTH & WELLBEING", title: "People's Choice - HEALTH & WELLBEING", desc: "Most popular health and wellbeing business or organisation making a difference as determined by people’s choice voting" },
        { value: "People's Choice - HUMANITARIAN IMPACT", title: "People's Choice - HUMANITARIAN IMPACT", desc: "Most popular humanitarian business or organisation making a difference as determined by people’s choice voting" },
        { value: "People's Choice - LOCAL COMMUNITY", title: "People's Choice - LOCAL COMMUNITY", desc: "Most popular local community focused business or organisation making a difference as determined by people’s choice voting" },
        { value: "People's Choice - NON PROFIT", title: "People's Choice - NON PROFIT", desc: "Most popular non-profit or charity organisation making a difference" },
        { value: "People's Choice - SOCIAL ENTERPRISE", title: "People's Choice - SOCIAL ENTERPRISE", desc: "Most popular social enterprise business making a difference" }
      ],
      "WOMAN OF THE YEAR AWARDS": [
        { value: "CHANGEMAKER", title: "WOMEN CHANGING THE WORLD - CHANGEMAKER", desc: "This award recognises exceptional women who are changing the world and are deserving of a larger platform" },
        { value: "COMPANY OF THE YEAR", title: "COMPANY CHANGING THE WORLD OF THE YEAR", desc: "This award recognises exceptional companies changing the world for women and girls" },
        { value: "EMERGING ENTREPRENEUR OF THE YEAR", title: "EMERGING ENTREPRENEUR OF THE YEAR", desc: "This award recognises exceptional entrepreneurs changing the world (under 2 years in business)" },
        { value: "EMERGING LEADER OF THE YEAR", title: "WOMEN CHANGING THE WORLD - EMERGING LEADER OF THE YEAR", desc: "This award recognises exceptional women in emerging leadership roles (women under 35)" },
        { value: "EMERGING WOMAN", title: "EMERGING WOMAN CHANGING THE WORLD OF THE YEAR", desc: "This award recognises exceptional women that are changing the World (working in the current field for less than 2 years)" },
        { value: "ENTREPRENEUR OF THE YEAR", title: "ENTREPRENEUR OF THE YEAR", desc: "This award recognises exceptional entrepreneurs changing the world" },
        { value: "GIRL OF THE YEAR", title: "GIRL CHANGING THE WORLD OF THE YEAR 2023", desc: "This award recognises exceptional girls changing the world (under 12 years)" },
        { value: "HALL OF FAME", title: "HALL OF FAME WOMAN CHANGING THE WORLD OF THE YEAR", desc: "This award recognises exceptional women who are changing the World (working in the current field for 20 years+)" },
        { value: "RISING STAR", title: "RISING STAR WOMAN CHANGING THE WORLD OF THE YEAR", desc: "This award recognises exceptional women who are changing the World (working in the current field for less than 5 years)" },
        { value: "WOMAN OF THE YEAR AWARD", title: "WOMAN OF THE YEAR AWARD", desc: "" },
        { value: "WOMAN CHANING THE WORLD", title: "WOMAN CHANGING THE WORLD OF THE YEAR", desc: "This award recognises exceptional women who are changing the World (working in the current field for less than 20 years)" },
        { value: "YOUNG WOMAN OF THE YEAR", title: "YOUNG WOMAN CHANGING THE WORLD OF THE YEAR", desc: "This award recognises exceptional young women changing the world (under 25 years)" }
      ]
    };

    function getSubcats(category) {
      return CATEGORY_MAP[category] || [];
    }
    function findSubcatMeta(category, subValue) {
      return getSubcats(category).find(s => s.value === subValue) || null;
    }

    // Inject/update Subcategory UI in Start here
    function ensureSubcategoryUI() {
      const catEl = document.getElementById('category');
      if (!catEl) return;

      // Create container once if missing
      let wrap = document.getElementById('subcategoryContainer');
      if (!wrap) {
        wrap = document.createElement('div');
        wrap.className = 'form-group';
        wrap.id = 'subcategoryContainer';
        wrap.innerHTML = `
          <label for="subcategory">Sub Category</label>
          <select id="subcategory"></select>
          <div class="subcat-info">
            <div id="subcatTitle" class="subcat-title"></div>
            <div id="subcatDesc" class="subcat-desc"></div>
          </div>
        `;
        // Insert right after the category field
        catEl.closest('.form-group')?.after(wrap);
      }
      return wrap;
    }

    function populateSubcategoryUI(category, selected) {
      const wrap = ensureSubcategoryUI();
      const select = document.getElementById('subcategory');
      const titleEl = document.getElementById('subcatTitle');
      const descEl = document.getElementById('subcatDesc');
      if (!wrap || !select) return;

      const options = getSubcats(category);
      if (!category || options.length === 0) {
        wrap.style.display = 'none';
        select.innerHTML = '';
        titleEl.textContent = '';
        descEl.textContent = '';
        return;
      }

      wrap.style.display = 'block';
      select.innerHTML = `<option value="">Select sub category</option>` + options.map(o => `<option value="${o.value}">${o.value}</option>`).join('');
      if (selected) select.value = selected;

      const meta = findSubcatMeta(category, select.value);
      titleEl.textContent = meta?.title || '';
      descEl.textContent = meta?.desc || '';

      // Change listener
      select.onchange = () => {
        const m = findSubcatMeta(category, select.value);
        titleEl.textContent = m?.title || '';
        descEl.textContent = m?.desc || '';
      };
    }

    // Update StartHere setup to wire category change
    function setUpStartHereTab() {
      const saveBtn = document.getElementById('saveStartHereBtn');
      const nextBtn = document.getElementById('saveNextBtn');

      if (saveBtn) {
        saveBtn.onclick = async function () {
          try {
            await saveStartHereToFirestore();
            alert('Application saved as draft.');
          } catch (err) {
            console.error(err);
            alert('Failed to save application: ' + err.message);
          }
        };
      }

      if (nextBtn) {
        nextBtn.onclick = async function () {
          try {
            await saveStartHereToFirestore();
            const critTab = document.getElementById('tabCriteria');
            if (critTab) {
              critTab.disabled = false;
              critTab.click();
            }
          } catch (err) {
            console.error(err);
            alert('Failed to save application: ' + err.message);
          }
        };
      }

      // Prefill with last-saved data
      hydrateStartHereForm();

      // Wire category change → refresh subcats
      const catEl = document.getElementById('category');
      if (catEl) {
        ensureSubcategoryUI();
        populateSubcategoryUI(catEl.value || '', null);
        catEl.onchange = () => populateSubcategoryUI(catEl.value, null);
      }
    }

    // Extend StartHere collect/hydrate to include subcategory
    function collectStartHere(form) {
      const val = id => (form.querySelector('#' + id)?.value || '');
      const category = val('category');
      const subcategory = val('subcategory');
      const meta = findSubcatMeta(category, subcategory);
      return {
        category,
        subcategory,
        subcategory_title: meta?.title || '',
        subcategory_description: meta?.desc || '',
        name: val('name'),
        website: val('website'),
        awards_choice: val('award'),
        email: val('email'),
        mobile_number: val('mobile'),
        address: val('address'),
        instagram_url: val('instagram'),
        linkedin_url: val('linkedin')
      };
    }

    async function hydrateStartHereForm() {
      const form = document.getElementById('startHereForm');
      if (!form) return;
      const data = await getApplicationData();
      if (!data) return;
      const setVal = (id, value) => { const el = form.querySelector('#' + id); if (el) el.value = value ?? ''; };

      setVal('category', data.category);
      // Build subcategory UI and select value
      ensureSubcategoryUI();
      populateSubcategoryUI(data.category || '', data.subcategory || '');

      setVal('name', data.name);
      setVal('website', data.website);
      setVal('award', data.awards_choice);
      setVal('email', data.email);
      setVal('mobile', data.mobile_number);
      setVal('address', data.address);
      setVal('instagram', data.instagram_url);
      setVal('linkedin', data.linkedin_url);
    }

    // Ensure any save to Firestore keeps subcategory fields
    async function saveStartHereToFirestore() {
      if (!currentUser) throw new Error('Not signed in');
      const form = document.getElementById('startHereForm');
      if (!form) throw new Error('Start Here form not found');

      await ensureApplicationDoc();
      const payload = {
        ...collectStartHere(form),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        stage: 'draft',
        user_id: currentUser.uid,
        applicant_id: currentUser.uid
      };
      await firebase.firestore().collection('applications').doc(applicationId).set(payload, { merge: true });
    }
  </script>
</body>