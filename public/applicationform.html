<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Application Form - WCW Awards</title>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; }
    footer {
      text-align: center;
      color: #888;
      margin-top: 40px;
      font-size: 14px;
    }
    header { background-color: #d7336f; color: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; }
    header h1 { margin: 0; font-size: 24px; }
    .back-btn { background-color: white; color: #d7336f; padding: 8px 16px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
    .back-btn:hover { background-color: #ffe6ee; }
    main { padding: 40px 30px; }
    .dates-section { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.1); max-width: 800px; margin: 30px auto; }
    .dates-section h2, .dates-section h3, .dates-section h4 { color: #d7336f; }
    .dates-section ul { font-size: 16px; }
    .dates-section p { font-size: 16px; }
    .start-entry-btn { padding: 12px 20px; background-color: #d7336f; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; margin-top: 20px; }
    .start-entry-btn:hover { background-color: #b8235a; }
    .tab-list { display: flex; gap: 0; margin: 40px auto 0 auto; max-width: 800px; }
    .tab { flex: 1; padding: 16px 0; text-align: center; font-size: 18px; font-weight: 500; border: none; cursor: pointer; background: #888; color: #fff; border-radius: 6px 6px 0 0; margin-right: 2px; }
    .tab.active { background: #b8235a; color: #fff; }
    .tab-content { background: white; min-height: 200px; border-radius: 0 0 10px 10px; box-shadow: 0 0 15px rgba(0,0,0,0.1); max-width: 800px; margin: 0 auto; padding: 30px; }
    .form-group { margin-bottom: 18px; }
    .form-group label { display: block; margin-bottom: 6px; font-weight: 500; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc; font-size: 16px; }
    .form-group textarea { resize: vertical; }
    .word-count { font-size: 13px; color: #888; float: right; }
    .eligibility-check { display: flex; align-items: flex-start; gap: 10px; margin-top: 10px; }
    .submit-btn { padding: 12px 20px; background-color: #d7336f; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; margin-top: 20px; }
    .submit-btn:disabled { background-color: #ccc; cursor: not-allowed; }
    /* Preview modal */
.preview-modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.4); z-index: 1000; padding: 24px; }
.preview-modal.open { display: flex; }
.preview-dialog { background: #fff; border-radius: 10px; max-width: 980px; width: 100%; box-shadow: 0 12px 40px rgba(0,0,0,.25); overflow: hidden; }
.preview-header { display: flex; justify-content: space-between; align-items: center; padding: 14px 18px; background: #faf0f4; color: #8c1f4c; }
.preview-body { padding: 18px; max-height: 75vh; overflow: auto; }
.preview-title { margin: 18px 0 10px; color: #8c1f4c; background: #faf0f4; padding: 8px 12px; border-radius: 6px; }
.preview-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px 16px; }
@media (max-width: 800px) { .preview-grid { grid-template-columns: 1fr; } }
.preview-actions { display: flex; gap: 10px; }
.preview-close { background: #fff; color: #8c1f4c; border: 2px solid #8c1f4c; border-radius: 6px; padding: 8px 14px; font-weight: 700; cursor: pointer; }
.preview-close:hover { background: #ffe6ee; }
.preview-submit { background: #d7336f; color: #fff; border: none; border-radius: 6px; padding: 8px 14px; font-weight: 700; cursor: pointer; }
.preview-submit:disabled { background: #ccc; cursor: not-allowed; }

    .preview-grid > div {
      display: flex;
      align-items: center;
      gap: 8px;              
    }
    .preview-grid label {
      min-width: 150px;   
      font-weight: 600;
      color: #000;
    }
    .preview-grid label::after {
      content: ":";         
      margin-left: 4px;    
    }

    
    .action-btn {
      border: 2px solid transparent;
      border-radius: 4px;
      padding: 8px 14px;
      font-weight: 700;
      text-transform: uppercase;
      cursor: pointer;
      transition: background-color .15s ease-in-out, transform .05s ease-in-out;
    }
    .action-btn:active { transform: translateY(1px); }
    .btn-view { background: #e1faed; color: #1f7a4b; border-color: #c9f2da; }
    .btn-view:hover { background: #c9f2da; }

    .form-actions {
      margin-top: 12px;              
      display: flex;
      gap: 10px;                    
      flex-wrap: wrap;
    }

    .upload-card { border: 1px solid #eee; border-radius: 8px; padding: 12px; background: #fcfcfc; }
    .file-row { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .filename { font-size: 14px; color: #555; }
    .preview-image { 
      display:none; 
      max-width: 100%;
      max-height: 400px;
      height: auto;
      object-fit: contain;
      border: 1px solid #eee;
      border-radius: 6px;
    }

  
  .file-row input[type="file"] {
    font-size: 18px;           
    line-height: 1.4;
  }
  .file-row input[type="file"]::file-selector-button {
    padding: 10px 16px;
    font-size: 18px;
    border-radius: 6px;
    border: 1px solid #ccc;
    background: #fff;
    color: #333;
    cursor: pointer;
  }
  .file-row input[type="file"]::-webkit-file-upload-button {
    padding: 10px 16px;
    font-size: 18px;
    border-radius: 6px;
    border: 1px solid #ccc;
    background: #fff;
    color: #333;
    cursor: pointer;
  }
  .preview-image {
    display: none;
    max-width: 100%;
    max-height: 400px;
    height: auto;
    object-fit: contain;
    border: 1px solid #eee;
    border-radius: 6px;
  }
    .user-menu-container { display: flex; align-items: center; gap: 10px; position: relative; }
    .user-fullname {
      font-weight: 600;
      color: #fff;
      font-size: 16px;
    }
    .user-circle {
      background: #8d57a0;
      color: #fff;
      border: 2px solid #5f386d;
      border-radius: 50%;
      width: 38px;
      height: 38px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .user-circle:hover {
      background: #5f386d;
    }
    .user-dropdown {
      display: none;
      position: absolute;
      top: 60px;
      right: 30px;
      background: #fff0f6;
      border: 1px solid #b8235a;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(215,51,111,0.08);
      min-width: 160px;
      z-index: 100;
      flex-direction: column;
    }
    .user-dropdown button {
      background: none;
      border: none;
      color: #b8235a;
      font-size: 15px;
      text-align: left;
      padding: 12px 18px;
      cursor: pointer;
      width: 100%;
      transition: background 0.15s;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .user-dropdown button:hover {
      background: #ffe6ee;
    }
    .user-dropdown.open {
      display: flex;
    }
    .material-symbols-outlined {
      color: #b8235a;
      vertical-align: middle;
    }
    
  </style>
  <!-- Add Firebase SDKs  -->
  <script src="/__/firebase/12.0.0/firebase-app-compat.js"></script>
  <script src="/__/firebase/12.0.0/firebase-auth-compat.js"></script>
  <script src="/__/firebase/12.0.0/firebase-firestore-compat.js"></script>
  <script src="/__/firebase/12.0.0/firebase-storage-compat.js"></script>
  <script src="/__/firebase/init.js?useEmulator=true"></script>
</head>
<body>
  <header>
    <div style="display:flex;align-items:center;justify-content:space-between;width:100%;">
      <h1 style="margin:0;">WCW Awards Application</h1>
      <div class="user-menu-container">
        <span id="userFullName" class="user-fullname"></span>
        <button id="userCircle" class="user-circle"></button>
        <button class="back-btn" onclick="goBack()">Back</button>
      </div>
    </div>
    <div id="userDropdown" class="user-dropdown">
      <button onclick="showProfile()">
        Profile <span class="material-symbols-outlined" style="font-size:20px;">person</span>
      </button>
      <button onclick="window.open('https://support.awardforce.com/hc/en-us','_blank')">
        Get help <span class="material-symbols-outlined" style="font-size:20px;">help</span>
      </button>
      <button onclick="logout()">
        Log out <span class="material-symbols-outlined" style="font-size:20px;">logout</span>
      </button>
    </div>
  </header>
  <main>
    <div class="dates-section" id="datesSection">
      <div id="datesBody">Loading datesâ€¦</div>
      <button class="start-entry-btn" id="start-entry-btn">Start Entry</button>
    </div>
    <div id="tabSection" style="display:none;">
      <div class="tab-list">
        <button class="tab active" id="tabStart">Start here</button>
        <button class="tab" id="tabCriteria" disabled>Criteria</button>
        <button class="tab" id="tabAttachments" disabled>Attachments</button>
      </div>
      <div id="tabContent" class="tab-content"></div>
    </div>
    <footer>
       &copy; 2025 WCW Awards Platform. All rights reserved.
    </footer>
  </main>
  <div id="previewModal" class="preview-modal" aria-hidden="true"></div>
  <script>
  // Firebase and global setup
  function logout() { firebase.auth().signOut().then(() => { window.location.href = "signin.html"; }).catch((error) => { alert("Error signing out: " + error.message); }); }
  function showProfile() { window.location.href = "applicantprofile.html";}
  function goBack() { window.location.href = "applicantdashboard.html"; }

  let applicationId = null;
  let currentUser = null;
  let criteriaQuestions = [];

  const db = () => firebase.firestore();

  (function initApplicationId() {
    try {
      const qs = new URLSearchParams(location.search);
      const id = qs.get('application') || sessionStorage.getItem('continueApplicationId');
      if (id) {
        applicationId = id;
        sessionStorage.removeItem('continueApplicationId');
      }
    } catch (e) {
      console.warn('Failed to init application id', e);
    }
  })();

  firebase.auth().onAuthStateChanged(u => { currentUser = u || null; });

  firebase.auth().onAuthStateChanged(user => {
    const fullNameEl = document.getElementById("userFullName");
    const circleEl = document.getElementById("userCircle");
    if (user) {
      const name = user.displayName || user.email || "User";
      fullNameEl.textContent = name;
      let initials = "U";
      if (user.displayName) {
        initials = user.displayName.split(' ').map(w => w[0]).join('').toUpperCase();
      } else if (user.email) {
        initials = user.email[0].toUpperCase();
      }
      circleEl.textContent = initials;
      firebase.firestore().collection("users").doc(user.uid).get().then(doc => {
        if (doc.exists && doc.data().darkMode === "enabled") {
          document.body.classList.add("dark-mode");
        } else {
          document.body.classList.remove("dark-mode");
        }
      }).catch(() => {
        document.body.classList.remove("dark-mode");
      });
    } else {
      window.location.href = "signin.html";
    }
  });

  // Dates info
  async function loadDatesFromFirestore() {
    try {
      const doc = await db().collection('applicationInfo').doc('DatesInfo').get();
      if (doc.exists) {
        const data = doc.data() || {};
        if (data.Body) {
          let html = String(data.Body)
            .replace(/\\n/g, '')
            .replace(/\\"/g, '"')
            .replace(/\\'/g, "'");
          document.getElementById('datesBody').innerHTML = html.trim();
        }
      }
    } catch (e) {}
  }
  loadDatesFromFirestore();

  // Categories/Awards logic
  let CATEGORIES_MAP = {};
  let AWARDS_LIST = [];
  async function loadCategoriesFromFirestore() {
    const namesToTry = ['Categories', 'Category'];
    CATEGORIES_MAP = {};
    for (const col of namesToTry) {
      try {
        const snap = await db().collection(col).get();
        if (!snap.empty) {
          snap.forEach(doc => {
            const data = doc.data() || {};
            const subcats = Object.values(data).filter(Boolean).map(v => String(v));
            CATEGORIES_MAP[doc.id] = subcats;
          });
          break;
        }
      } catch (e) {}
    }
    populateCategorySelects();
  }
  function populateCategorySelects(selectedCategory = '') {
    ['category', 'pv_category'].forEach(id => {
      const sel = document.getElementById(id);
      if (!sel) return;
      sel.innerHTML = '';
      const def = document.createElement('option');
      def.value = '';
      def.textContent = 'Select category';
      sel.appendChild(def);
      Object.keys(CATEGORIES_MAP).forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        sel.appendChild(opt);
      });
      if (selectedCategory) sel.value = selectedCategory;
    });
  }
  function fillSubcategorySelect(selectEl, category, selectedValue = '') {
    if (!selectEl) return;
    const list = CATEGORIES_MAP[category] || [];
    selectEl.innerHTML = '';
    const def = document.createElement('option');
    def.value = '';
    def.textContent = 'Select subcategory';
    selectEl.appendChild(def);
    list.forEach(sc => {
      const opt = document.createElement('option');
      opt.value = sc;
      opt.textContent = sc;
      selectEl.appendChild(opt);
    });
    selectEl.disabled = list.length === 0;
    if (selectedValue) selectEl.value = selectedValue;
  }
  async function loadAwardsFromFirestore() {
    const namesToTry = ['Award', 'Awards'];
    AWARDS_LIST = [];
    for (const col of namesToTry) {
      try {
        const snap = await db().collection(col).get();
        if (!snap.empty) {
          snap.forEach(doc => {
            AWARDS_LIST.push(String(doc.id));
          });
          break;
        }
      } catch (e) {}
    }
    populateAwardSelects();
  }
  function populateAwardSelects(selected = '') {
    ['award', 'pv_award'].forEach(id => {
      const sel = document.getElementById(id);
      if (!sel) return;
      sel.innerHTML = '';
      const def = document.createElement('option');
      def.value = '';
      def.textContent = 'Select award';
      sel.appendChild(def);
      AWARDS_LIST.forEach(a => {
        const opt = document.createElement('option');
        opt.value = a;
        opt.textContent = a;
        sel.appendChild(opt);
      });
      if (selected) sel.value = selected;
    });
  }
  loadAwardsFromFirestore();
  loadCategoriesFromFirestore();

  // Ensure application doc exists
  async function ensureApplicationDoc() {
    if (applicationId) return;
    if (!currentUser) throw new Error('Not signed in');
    const now = firebase.firestore.FieldValue.serverTimestamp();
    let seasonName = null;
    try { seasonName = await getCurrentSeasonName(); } catch (e) { seasonName = null; }
    const ref = await db().collection('applications').add({
      user_id: currentUser.uid,
      applicant_id: currentUser.uid,
      season: seasonName,
      stage: 'Draft',
      createdAt: now,
      updatedAt: now
    });
    applicationId = ref.id;
  }

  async function getApplicationData() {
    if (!applicationId) return null;
    try {
      const snap = await db().collection('applications').doc(applicationId).get();
      return snap.exists ? snap.data() : null;
    } catch (e) { return null; }
  }
  function setVal(form, id, value) {
    const el = form.querySelector('#' + id);
    if (el) el.value = value ?? '';
  }

  // Dynamic criteria
  async function getCurrentSeasonName() {
    const snap = await db().collection('season').get();
    let currentSeason = null;
    snap.forEach(doc => {
      if (doc.data().status === 'current') currentSeason = doc.id;
    });
    if (!currentSeason) throw new Error('No current season found');
    return currentSeason;
  }
  async function getSeasonQuestions(seasonName) {
    const snap = await db().collection('applicationInfo').get();
    let questions = [];
    snap.forEach(doc => {
      const data = doc.data();
      if (data[seasonName]) {
        questions.push({
          id: doc.id,
          question_ID: data.question_ID,
          question: data.Question,
          order: data[seasonName],
          wordLimit: data.wordLimit
        });
      }
    });
    questions.sort((a, b) => {
      const nA = Number(a.order.replace(/[^0-9]/g, ''));
      const nB = Number(b.order.replace(/[^0-9]/g, ''));
      return nA - nB;
    });
    return questions;
  }
  async function buildCriteriaContent() {
    if (!criteriaQuestions.length) {
      const seasonName = await getCurrentSeasonName();
      criteriaQuestions = await getSeasonQuestions(seasonName);
    }
    let html = `<form id="criteriaForm">`;
    for (const q of criteriaQuestions) {
      html += `
        <div class="form-group">
          <label for="${q.question_ID}">${q.question}</label>
          <textarea id="${q.question_ID}" name="${q.question_ID}" maxlength="${q.wordLimit * 8}" rows="4"></textarea>
          <span class="word-count" id="count_${q.question_ID}">0/${q.wordLimit}</span>
        </div>
      `;
    }
    html += `
      <div class="eligibility-check">
        <input type="checkbox" id="confirm-eligibility" />
        <label for="confirm-eligibility" style="font-size: 0.98rem; font-weight: 400;">
          I confirm that I do not have a criminal record and that I meet the minimum requirements and am eligible to enter the Women Changing The World Awards.
        </label>
      </div>
      <div class="form-actions">
        <button type="button" class="action-btn btn-view" id="saveCriteriaBtn">Save</button>
        <button type="button" class="action-btn btn-view" id="saveCriteriaNextBtn">Save & Next</button>
      </div>
    </form>
    `;
    return html;
  }
  async function hydrateCriteriaForm() {
    const form = document.getElementById('criteriaForm');
    if (!form) return;
    const data = await getApplicationData();
    if (!data) return;
    for (const q of criteriaQuestions) {
      setVal(form, q.question_ID, data[q.question_ID]);
    }
    const cb = form.querySelector('#confirm-eligibility');
    if (cb) cb.checked = !!data.eligibility;
  }
  function collectCriteria(form) {
    const val = id => (form.querySelector('#' + id)?.value || '');
    let out = {};
    for (const q of criteriaQuestions) { out[q.question_ID] = val(q.question_ID); }
    out.eligibility = form.querySelector('#confirm-eligibility')?.checked ? true : false;
    return out;
  }
  function setUpWordCount(formId) {
    const form = document.getElementById(formId);
    if (!form) return;
    function countWords(s) { return s.trim().split(/\s+/).filter(Boolean).length; }
    for (const q of criteriaQuestions) {
      const ta = form.querySelector('#' + q.question_ID);
      const span = document.getElementById('count_' + q.question_ID);
      if (!ta || !span) continue;
      const max = Number(q.wordLimit);
      ta.addEventListener('input', () => {
        let words = countWords(ta.value);
        if (words > max) {
          ta.value = ta.value.split(/\s+/).slice(0, max).join(' ');
          words = max;
        }
        span.textContent = `${words}/${max}`;
      });
      ta.dispatchEvent(new Event('input'));
    }
  }

  // Static start here tab
  const startHereContent = `
    <form id="startHereForm">
      <div class="form-group">
        <label for="category">Category</label>
        <select id="category" name="category" required>
          <option value="">Select category</option>
        </select>
      </div>
      <div class="form-group">
        <label for="subcategory">Subcategory</label>
        <select id="subcategory" name="subcategory" disabled>
          <option value="">Select subcategory</option>
        </select>
      </div>
      <div class="form-group">
        <label for="award">Which Awards would you want to enter?</label>
        <select id="award" name="award" required>
          <option value="">Select award</option>
        </select>
      </div>
      <div class="form-group">
        <label for="name">Name</label>
        <input type="text" id="name" name="name" required />
      </div>
      <div class="form-group">
        <label for="website">Website (optional)</label>
        <input type="text" id="website" name="website" />
      </div>
      <div class="form-group">
        <label for="email">Email</label>
        <input type="email" id="email" name="email" required />
      </div>
      <div class="form-group">
        <label for="mobile">Mobile Number</label>
        <input type="tel" id="mobile" name="mobile" required />
      </div>
      <div class="form-group">
        <label for="address">Address</label>
        <input type="text" id="address" name="address" required autocomplete="off"/>
      </div>
      <div class="form-group">
        <label for="instagram">Instagram profile page URL (if applicable)</label>
        <input type="text" id="instagram" name="instagram" />
      </div>
      <div class="form-group">
        <label for="linkedin">LinkedIn profile page URL (if applicable)</label>
        <input type="text" id="linkedin" name="linkedin" />
      </div>
      <div class="form-actions">
        <button type="button" class="action-btn btn-view" id="saveStartHereBtn">Save</button>
        <button type="button" class="action-btn btn-view" id="saveNextBtn">Save & Next</button>
      </div>
    </form>
  `;

  // Attachments tab (static)
  const attachmentsContent = `
    <section>
      <h2 style="margin-top:0; color:#8c1f4c; background:#faf0f4; padding:10px 12px; border-radius:6px;">
        Attach your photo
      </h2>
      <div>
        <p style="margin:0 0 10px 0;">Materials to be supplied</p>
        <p style="margin:0 0 8px 0; font-weight:600;">HIGH RESOLUTION PHOTO TO BE ATTACHED TO YOUR ENTRY FORM</p>
        <ul style="padding-left:20px; margin-top:6px;">
          <li>The photo file should be named with your name and business name (e.g., Katy Garner, AusMumpreneur).</li>
          <li>This photo should be just yourself without other people in it unless you are entering as a partnership or team.</li>
          <li>Please no text, logos or montages.</li>
          <li>If you are a finalist this photo will be used for the digital screen at the awards night so please use a good quality image you would be proud to share.</li>
          <li>Your photo is part of your application and must be included to be eligible. Maximum file size is 5MB per piece.</li>
        </ul>
      </div>
      <div class="upload-card" style="margin-top:14px;">
        <div class="file-row">
          <input type="file" id="att_photo" accept="image/*" />
        </div>
        <div style="margin-top:10px">
          <img id="att_preview" class="preview-image" alt="Selected photo preview" />
        </div>
      </div>
      <div class="form-actions" style="margin-top:14px;">
        <button type="button" class="action-btn btn-view" id="att_save_btn">Save</button>
        <button type="button" class="action-btn btn-view" id="attachmentsPreviewBtn">Preview</button>
      </div>
    </section>
  `;

  // Tab logic
  document.getElementById('tabStart').onclick = function() {
    document.getElementById('tabStart').classList.add('active');
    document.getElementById('tabCriteria').classList.remove('active');
    document.getElementById('tabAttachments').classList.remove('active');
    document.getElementById('tabContent').innerHTML = startHereContent;
    setUpStartHereTab();
  };
  document.getElementById('tabCriteria').onclick = async function() {
    document.getElementById('tabStart').classList.remove('active');
    document.getElementById('tabCriteria').classList.add('active');
    document.getElementById('tabAttachments').classList.remove('active');
    document.getElementById('tabContent').innerHTML = await buildCriteriaContent();
    await hydrateCriteriaForm();
    setUpWordCount('criteriaForm');
    setUpCriteriaTab();
  };
  document.getElementById('tabAttachments').onclick = function() {
    document.getElementById('tabStart').classList.remove('active');
    document.getElementById('tabCriteria').classList.remove('active');
    document.getElementById('tabAttachments').classList.add('active');
    document.getElementById('tabContent').innerHTML = attachmentsContent;
    setUpAttachmentsTab();
  };

  // Dynamic criteria tab setup
  function setUpCriteriaTab() {
    const form = document.getElementById('criteriaForm');
    if (!form) return;
    const saveBtn = document.getElementById('saveCriteriaBtn');
    const nextBtn = document.getElementById('saveCriteriaNextBtn');
    if (saveBtn) {
      saveBtn.onclick = async () => {
        try {
          if (!currentUser) throw new Error('Not signed in');
          await ensureApplicationDoc();
          const payload = {
            ...collectCriteria(form),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            stage: 'Draft'
          };
          await db().collection('applications').doc(applicationId).set(payload, { merge: true });
          alert('Saved.');
        } catch (e) { alert('Failed to save: ' + e.message); }
      };
    }
    if (nextBtn) {
      nextBtn.onclick = async () => {
        try {
          if (!currentUser) throw new Error('Not signed in');
          await ensureApplicationDoc();
          const payload = {
            ...collectCriteria(form),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            stage: 'Draft'
          };
          await db().collection('applications').doc(applicationId).set(payload, { merge: true });
          const attTab = document.getElementById('tabAttachments');
          if (attTab) attTab.disabled = false;
          attTab?.click();
        } catch (e) { alert('Failed to save: ' + e.message); }
      };
    }
  }

  // Attachments logic
  function setUpAttachmentsTab() {
    const fileInput = document.getElementById('att_photo');
    const img = document.getElementById('att_preview');
    const saveBtn = document.getElementById('att_save_btn');
    const previewBtn = document.getElementById('attachmentsPreviewBtn');
    fileInput?.addEventListener('change', () => {
      const f = fileInput.files && fileInput.files[0];
      if (f) {
        const url = URL.createObjectURL(f);
        img.src = url;
        img.style.display = 'inline-block';
      } else {
        img.removeAttribute('src');
        img.style.display = 'none';
      }
    });
    saveBtn?.addEventListener('click', () => {
      alert('The image saving function is not implemented.');
    });
    previewBtn?.addEventListener('click', async () => {
      try { await openPreviewModal(); }
      catch (e) { alert('Failed to open preview: ' + e.message); }
    });
  }

  // Start here tab setup
  async function hydrateStartHereForm() {
    const form = document.getElementById('startHereForm');
    if (!form) return;
    const data = await getApplicationData();
    if (!data) return;
    setVal(form, 'category', data.category);
    fillSubcategorySelect(form.querySelector('#subcategory'), data.category, data.subcategory);
    setVal(form, 'name', data.name);
    setVal(form, 'website', data.website);
    setVal(form, 'award', data.awards_choice);
    setVal(form, 'email', data.email);
    setVal(form, 'mobile', data.mobile_number);
    setVal(form, 'address', data.address);
    setVal(form, 'instagram', data.instagram_url);
    setVal(form, 'linkedin', data.linkedin_url);
  }
  function collectStartHere(form) {
    const val = id => (form.querySelector('#' + id)?.value || '');
    return {
      category: val('category'),
      subcategory: val('subcategory'),           
      name: val('name'),
      website: val('website'),
      awards_choice: val('award'),
      email: val('email'),
      mobile_number: val('mobile'),
      address: val('address'),
      instagram_url: val('instagram'),
      linkedin_url: val('linkedin')
    };
  }
  function setUpStartHereTab() {
    const form = document.getElementById('startHereForm');
    if (!form) return;
    form.reset();
    populateCategorySelects();
    populateAwardSelects();
    const cat = form.querySelector('#category');
    const sub = form.querySelector('#subcategory');
    cat.addEventListener('change', () => {
      fillSubcategorySelect(sub, cat.value, '');
    });
    hydrateStartHereForm();
    const saveBtn = document.getElementById('saveStartHereBtn');
    const nextBtn = document.getElementById('saveNextBtn');
    async function saveStartHereToFirestore() {
      if (!currentUser) throw new Error('Not signed in');
      await ensureApplicationDoc();
      const payload = {
        ...collectStartHere(form),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        stage: 'Draft'
      };
      await db().collection('applications').doc(applicationId).set(payload, { merge: true });
    }
    if (saveBtn) {
      saveBtn.onclick = async () => {
        try { await saveStartHereToFirestore(); alert('Saved.'); }
        catch (e) { alert('Failed to save: ' + e.message); }
      };
    }
    if (nextBtn) {
      nextBtn.onclick = async () => {
        try {
          await saveStartHereToFirestore();
          const critTab = document.getElementById('tabCriteria');
          const attTab = document.getElementById('tabAttachments');
          if (critTab) critTab.disabled = false;
          if (attTab) attTab.disabled = false;
          critTab?.click();
        } catch (e) { alert('Failed to save: ' + e.message); }
      };
    }
  }

  // Preview modal
  async function buildPreviewModal() {
    let html = `
      <div class="preview-dialog">
        <div class="preview-header">
          <strong>Preview your application</strong>
          <div class="preview-actions">
            <button id="previewClose" class="preview-close">Close</button>
            <button id="previewSubmit" class="preview-submit" disabled>Submit Application</button>
          </div>
        </div>
        <div class="preview-body">
          <h3 class="preview-title">Start here</h3>
          <div class="preview-grid">
            <div>
              <label>Category</label>
              <select id="pv_category"><option value="">Select category</option></select>
            </div>
            <div>
              <label>Subcategory</label>
              <select id="pv_subcategory"><option value="">Select subcategory</option></select>
            </div>
            <div>
              <label>Award</label>
              <select id="pv_award"><option value="">Select award</option></select>
            </div>
            <div><label>Name</label><input id="pv_name" type="text"></div>
            <div><label>Website</label><input id="pv_website" type="text"></div>
            <div><label>Email</label><input id="pv_email" type="email"></div>
            <div><label>Mobile Number</label><input id="pv_mobile" type="tel"></div>
            <div><label>Address</label><input id="pv_address" type="text"></div>
            <div><label>Instagram URL</label><input id="pv_instagram" type="text"></div>
            <div><label>LinkedIn URL</label><input id="pv_linkedin" type="text"></div>
          </div>
          <h3 class="preview-title">Criteria</h3>
          <div id="pv_criteria_questions"></div>
          <div class="eligibility-check">
            <input type="checkbox" id="pv_confirm_eligibility" />
            <label for="pv_confirm_eligibility" style="font-size: 0.98rem; font-weight: 400;">
              I confirm that I do not have a criminal record and that I meet the minimum requirements and am eligible to enter the Women Changing The World Awards.
            </label>
          </div>
        </div>
      </div>
    `;
    return html;
  }
  async function openPreviewModal() {
    if (!criteriaQuestions.length) {
      const seasonName = await getCurrentSeasonName();
      criteriaQuestions = await getSeasonQuestions(seasonName);
    }
    const modal = document.getElementById('previewModal');
    if (!modal) return;
    modal.innerHTML = await buildPreviewModal();
    const data = await getApplicationData();
    populateAwardSelects(data.awards_choice);
    populateCategorySelects(data.category);
    document.getElementById('pv_category').value = data.category || '';
    fillSubcategorySelect(document.getElementById('pv_subcategory'), data.category, data.subcategory);
    document.getElementById('pv_award').value = data.awards_choice || '';
    document.getElementById('pv_name').value = data.name || '';
    document.getElementById('pv_website').value = data.website || '';
    document.getElementById('pv_email').value = data.email || '';
    document.getElementById('pv_mobile').value = data.mobile_number || '';
    document.getElementById('pv_address').value = data.address || '';
    document.getElementById('pv_instagram').value = data.instagram_url || '';
    document.getElementById('pv_linkedin').value = data.linkedin_url || '';
    document.getElementById('pv_category').onchange = (e) => {
      fillSubcategorySelect(document.getElementById('pv_subcategory'), e.target.value, '');
    };
    let qHtml = "";
    for (const q of criteriaQuestions) {
      qHtml += `
        <div class="form-group">
          <label for="pv_${q.question_ID}">${q.question}</label>
          <textarea id="pv_${q.question_ID}" name="pv_${q.question_ID}" maxlength="${q.wordLimit * 8}" rows="4"></textarea>
          <span class="word-count" id="pv_count_${q.question_ID}">0/${q.wordLimit}</span>
        </div>
      `;
    }
    document.getElementById('pv_criteria_questions').innerHTML = qHtml;
    for (const q of criteriaQuestions) {
      document.getElementById('pv_' + q.question_ID).value = data[q.question_ID] || '';
    }
    document.getElementById('pv_confirm_eligibility').checked = !!data.eligibility;
    setUpPreviewWordCount();
    bindPreviewValidation();
    updatePreviewSubmitState();
    modal.classList.add('open');
    modal.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
    document.getElementById('previewClose')?.addEventListener('click', closePreviewModal);
    modal?.addEventListener('click', (e) => {
      if (e.target === modal) closePreviewModal();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal?.classList.contains('open')) {
        closePreviewModal();
      }
    });
    document.getElementById('previewSubmit').onclick = async function() {
      if (!previewRequiredOk()) {
        return alert('Please complete all required fields and confirm eligibility.');
      }

      // Confirm submission
      const confirmed = confirm('Are you sure you want to submit your application? This cannot be undone.');
      if (!confirmed) return;
      try {
        const payload = collectPreviewData();
        await db().collection('applications').doc(applicationId).set({
          ...payload,
          submitted: true,
          submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          stage: 'Submitted'
        }, { merge: true });
        alert('Application submitted successfully!');
        closePreviewModal()
        window.location.href = 'applicationdashboard.html';
      } catch (err) {
        alert('Failed to submit application: ' + err.message);
      }
    };
  }
  function closePreviewModal() {
    const modal = document.getElementById('previewModal');
    if (!modal) return;
    modal.classList.remove('open');
    modal.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
  }
  function setUpPreviewWordCount() {
    function countWords(s) { return s.trim().split(/\s+/).filter(Boolean).length; }
    for (const q of criteriaQuestions) {
      const ta = document.getElementById('pv_' + q.question_ID);
      const span = document.getElementById('pv_count_' + q.question_ID);
      if (!ta || !span) continue;
      const max = Number(q.wordLimit);
      ta.addEventListener('input', () => {
        let words = countWords(ta.value);
        if (words > max) {
          ta.value = ta.value.split(/\s+/).slice(0, max).join(' ');
          words = max;
        }
        span.textContent = `${words}/${max}`;
      });
      ta.dispatchEvent(new Event('input'));
    }
  }
  function previewRequiredOk() {
    let allFilled = [
      'pv_award','pv_name','pv_email','pv_mobile'
    ].every(id => getPreviewVal(id).length > 0);
    allFilled = allFilled && criteriaQuestions.every(q =>
      getPreviewVal('pv_' + q.question_ID).length > 0
    );
    const eligible = !!document.getElementById('pv_confirm_eligibility')?.checked;
    return allFilled && eligible;
  }
  function getPreviewVal(id) {
    const el = document.getElementById(id);
    return (el && typeof el.value === 'string') ? el.value.trim() : '';
  }
  function updatePreviewSubmitState() {
    const btn = document.getElementById('previewSubmit');
    if (btn) btn.disabled = !previewRequiredOk();
  }
  function bindPreviewValidation() {
    const wire = (id, evt = 'input') => {
      const el = document.getElementById(id);
      if (!el || el.dataset.bound === '1') return;
      el.addEventListener(evt, updatePreviewSubmitState);
      el.dataset.bound = '1';
    };
    ['pv_award','pv_name','pv_email','pv_mobile'].forEach(id => wire(id));
    criteriaQuestions.forEach(q => wire('pv_' + q.question_ID));
    wire('pv_confirm_eligibility', 'change');
    ['pv_category','pv_subcategory','pv_website','pv_address','pv_instagram','pv_linkedin'].forEach(id => wire(id, 'change'));
  }
  function collectPreviewData() {
    let out = {};
    out.category = getPreviewVal('pv_category');
    out.subcategory = getPreviewVal('pv_subcategory');
    out.awards_choice = getPreviewVal('pv_award');
    out.name = getPreviewVal('pv_name');
    out.website = getPreviewVal('pv_website');
    out.email = getPreviewVal('pv_email');
    out.mobile_number = getPreviewVal('pv_mobile');
    out.address = getPreviewVal('pv_address');
    out.instagram_url = getPreviewVal('pv_instagram');
    out.linkedin_url = getPreviewVal('pv_linkedin');
    for (const q of criteriaQuestions) {
      out[q.question_ID] = getPreviewVal('pv_' + q.question_ID);
    }
    out.eligibility = !!document.getElementById('pv_confirm_eligibility')?.checked;
    return out;
  }

  // Init
  (async () => {
    const data = await getApplicationData();
    if (data) {
      document.getElementById('tabSection').style.display = 'block';
      document.getElementById('datesSection').style.display = 'none';
      document.getElementById('tabContent').innerHTML = startHereContent;
      const critTab = document.getElementById('tabCriteria');
      const attTab = document.getElementById('tabAttachments');
      if (critTab) critTab.disabled = false;
      if (attTab) attTab.disabled = false;
      hydrateStartHereForm();
      setUpStartHereTab();
    } else {
      document.getElementById('tabContent').innerHTML = startHereContent;
      setUpStartHereTab();
    }
  })();

  // User menu
  const userCircle = document.getElementById("userCircle");
  const userDropdown = document.getElementById("userDropdown");
  userCircle.onclick = function(e) {
    userDropdown.classList.toggle("open");
  };
  document.addEventListener("click", function(e) {
    if (!userCircle.contains(e.target) && !userDropdown.contains(e.target)) {
      userDropdown.classList.remove("open");
    }
  });

  document.getElementById('start-entry-btn')?.addEventListener('click', function() {
    document.getElementById('datesSection').style.display = 'none';
    document.getElementById('tabSection').style.display = 'block';  
    document.getElementById('tabContent').innerHTML = startHereContent;
    setUpStartHereTab();
  });
  </script>
</body>
</html>