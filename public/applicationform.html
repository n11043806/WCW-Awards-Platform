<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Application Form - WCW Awards</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; }
    header { background-color: #d7336f; color: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; }
    header h1 { margin: 0; font-size: 24px; }
    .back-btn { background-color: white; color: #d7336f; padding: 8px 16px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
    .back-btn:hover { background-color: #ffe6ee; }
    main { padding: 40px 30px; }
    .dates-section { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.1); max-width: 800px; margin: 30px auto; }
    .dates-section h2, .dates-section h3, .dates-section h4 { color: #d7336f; }
    .dates-section ul { font-size: 16px; }
    .dates-section p { font-size: 16px; }
    .start-entry-btn { padding: 12px 20px; background-color: #d7336f; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; margin-top: 20px; }
    .start-entry-btn:hover { background-color: #b8235a; }
    .tab-list { display: flex; gap: 0; margin: 40px auto 0 auto; max-width: 800px; }
    .tab { flex: 1; padding: 16px 0; text-align: center; font-size: 18px; font-weight: 500; border: none; cursor: pointer; background: #888; color: #fff; border-radius: 6px 6px 0 0; margin-right: 2px; }
    .tab.active { background: #b8235a; color: #fff; }
    .tab-content { background: white; min-height: 200px; border-radius: 0 0 10px 10px; box-shadow: 0 0 15px rgba(0,0,0,0.1); max-width: 800px; margin: 0 auto; padding: 30px; }
    .form-group { margin-bottom: 18px; }
    .form-group label { display: block; margin-bottom: 6px; font-weight: 500; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc; font-size: 16px; }
    .form-group textarea { resize: vertical; }
    .word-count { font-size: 13px; color: #888; float: right; }
    .eligibility-check { display: flex; align-items: flex-start; gap: 10px; margin-top: 10px; }
    .submit-btn { padding: 12px 20px; background-color: #d7336f; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; margin-top: 20px; }
    .submit-btn:disabled { background-color: #ccc; cursor: not-allowed; }
    /* Preview modal */
.preview-modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.4); z-index: 1000; padding: 24px; }
.preview-modal.open { display: flex; }
.preview-dialog { background: #fff; border-radius: 10px; max-width: 980px; width: 100%; box-shadow: 0 12px 40px rgba(0,0,0,.25); overflow: hidden; }
.preview-header { display: flex; justify-content: space-between; align-items: center; padding: 14px 18px; background: #faf0f4; color: #8c1f4c; }
.preview-body { padding: 18px; max-height: 75vh; overflow: auto; }
.preview-title { margin: 18px 0 10px; color: #8c1f4c; background: #faf0f4; padding: 8px 12px; border-radius: 6px; }
.preview-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px 16px; }
@media (max-width: 800px) { .preview-grid { grid-template-columns: 1fr; } }
.preview-actions { display: flex; gap: 10px; }
.preview-close { background: #fff; color: #8c1f4c; border: 2px solid #8c1f4c; border-radius: 6px; padding: 8px 14px; font-weight: 700; cursor: pointer; }
.preview-close:hover { background: #ffe6ee; }
.preview-submit { background: #d7336f; color: #fff; border: none; border-radius: 6px; padding: 8px 14px; font-weight: 700; cursor: pointer; }
.preview-submit:disabled { background: #ccc; cursor: not-allowed; }

    .preview-grid > div {
      display: flex;
      align-items: center;
      gap: 8px;              
    }
    .preview-grid label {
      min-width: 150px;   
      font-weight: 600;
      color: #000;
    }
    .preview-grid label::after {
      content: ":";         
      margin-left: 4px;    
    }

    
    .action-btn {
      border: 2px solid transparent;
      border-radius: 4px;
      padding: 8px 14px;
      font-weight: 700;
      text-transform: uppercase;
      cursor: pointer;
      transition: background-color .15s ease-in-out, transform .05s ease-in-out;
    }
    .action-btn:active { transform: translateY(1px); }
    .btn-view { background: #e1faed; color: #1f7a4b; border-color: #c9f2da; }
    .btn-view:hover { background: #c9f2da; }

    .form-actions {
      margin-top: 12px;              
      display: flex;
      gap: 10px;                    
      flex-wrap: wrap;
    }
  </style>
  <!-- Add Firebase SDKs  -->
  <script src="/__/firebase/12.0.0/firebase-app-compat.js"></script>
  <script src="/__/firebase/12.0.0/firebase-auth-compat.js"></script>
  <script src="/__/firebase/12.0.0/firebase-firestore-compat.js"></script>
  
  <script src="/__/firebase/init.js?useEmulator=true"></script>
</head>
<body>
  <header>
    <h1>WCW Awards Application</h1>
    <button class="back-btn" onclick="goBack()">Back</button>
  </header>
  <main>
    <div class="dates-section" id="datesSection">
      <h2>Dates</h2>
      <ul style="margin-bottom: 1.5em;">
        <li>Please note the entry deadline, this date is final and there will be no extensions provided.</li>
        <li>You may edit your entry after submitting, up until the entry deadline for your region.</li>
        <li>Please make sure all your personal details are entered accurately, including contact details.</li>
        <li>You are eligible to enter more than one category, as long as the work submitted meets the criteria.</li>
      </ul>
      <p style="font-style: italic; margin-bottom: 1.5em;">* You can use the ‘copy’ feature to create a copy of your entry and change the category as required.</p>
      <h3>IMPORTANT DATES</h3>
      <h4>GLOBAL:</h4>
      <p>All nominations have now closed for 2025<br>
      Finalists in all categories announced - 17 FEBRUARY 2025</p>
      <p>People’s Choice Voting starts - 24 FEBRUARY 2025<br>
      People’s Choice Voting ends - 10 MARCH 2025</p>
      <p>Winners Announced Global Awards & Summit - London 2-3 APRIL 2025</p>
      <p>For any questions, please contact <a href="mailto:awards@thewomenchangingtheworld.com">awards@thewomenchangingtheworld.com</a></p>
      <h3>Support</h3>
      <p>If you have any questions on the entry process, please contact the organisers by email to <a href="mailto:awards@thewomenchangingtheworld.com">awards@thewomenchangingtheworld.com</a></p>
      <button class="start-entry-btn" id="start-entry-btn">Start Entry</button>
    </div>
    <div id="tabSection" style="display:none;">
      <!-- Only show Start Here tab at first -->
      <div class="tab-list">
        <button class="tab active" id="tabStart">Start here</button>
        <button class="tab" id="tabCriteria" disabled>Criteria</button>
      </div>
      <div id="tabContent" class="tab-content"></div>
    </div>
  </main>
  <div id="previewModal" class="preview-modal" aria-hidden="true">
  <div class="preview-dialog">
    <div class="preview-header">
      <strong>Preview your application</strong>
      <div class="preview-actions">
        <button id="previewClose" class="preview-close">Close</button>
        <button id="previewSubmit" class="preview-submit" disabled>Submit Application</button>
      </div>
    </div>
    <div class="preview-body">
      <h3 class="preview-title">Start here</h3>
      <div class="preview-grid">
        <div>
          <label>Category</label>
          <select id="pv_category">
            <option value="">Select category</option>
            <option value="BUSINESS AWARDS">BUSINESS AWARDS</option>
            <option value="IMPACT AWARDS">IMPACT AWARDS</option>
            <option value="INDUSTRY AWARDS">INDUSTRY AWARDS</option>
            <option value="LEADERSHIP AWARDS">LEADERSHIP AWARDS</option>
            <option value="PEOPLE'S CHOICE">PEOPLE'S CHOICE</option>
            <option value="WOMAN OF THE YEAR AWARDS">WOMAN OF THE YEAR AWARDS</option>
          </select>
        </div>
        <div>
          <label>Award</label>
          <select id="pv_award">
            <option value="">Select award</option>
            <option value="WCWA Americas">WCWA Americas</option>
            <option value="WCWA Middle East & North Africa (MENA)">WCWA Middle East & North Africa (MENA)</option>
            <option value="WCWA Czech Republic">WCWA Czech Republic</option>
            <option value="WCWA South Africa">WCWA South Africa</option>
            <option value="WCWA Global 2025">WCWA Global 2025</option>
          </select>
        </div>
        <div><label>Name</label><input id="pv_name" type="text"></div>
        <div><label>Website</label><input id="pv_website" type="text"></div>
        <div><label>Email</label><input id="pv_email" type="email"></div>
        <div><label>Mobile Number</label><input id="pv_mobile" type="tel"></div>
        <div><label>Address</label><input id="pv_address" type="text"></div>
        <div><label>Instagram URL</label><input id="pv_instagram" type="text"></div>
        <div><label>LinkedIn URL</label><input id="pv_linkedin" type="text"></div>
      </div>

      <h3 class="preview-title">Criteria</h3>
      <div>
        <div class="form-group"><label>Tell us about yourself</label><textarea id="pv_about_yourself" rows="3"></textarea></div>
        <div class="form-group"><label>Tell us about your work</label><textarea id="pv_about_work" rows="3"></textarea></div>
        <div class="form-group"><label>What inspired you?</label><textarea id="pv_inspiration" rows="4"></textarea></div>
        <div class="form-group"><label>What makes you unique?</label><textarea id="pv_unique" rows="4"></textarea></div>
        <div class="form-group"><label>Greatest challenge</label><textarea id="pv_challenge" rows="6"></textarea></div>
        <div class="form-group"><label>Top achievements (last 12 months)</label><textarea id="pv_achievements" rows="5"></textarea></div>
        <div class="form-group"><label>Why achievements significant?</label><textarea id="pv_significance" rows="4"></textarea></div>
        <div class="form-group"><label>Big picture vision</label><textarea id="pv_vision" rows="6"></textarea></div>
        <div class="form-group"><label>Why should you be recognised?</label><textarea id="pv_recognition" rows="6"></textarea></div>

        <div class="eligibility-check">
          <input type="checkbox" id="pv_confirm_eligibility" />
          <label for="pv_confirm_eligibility" style="font-size: 0.98rem; font-weight: 400;">
            I confirm that I do not have a criminal record and that I meet the minimum requirements and am eligible to enter the Women Changing The World Awards.
          </label>
        </div>
      </div>
    </div>
  </div>
</div>
  <script>
    function goBack() {
      window.location.href = "applicantdashboard.html";
    }

    // Tab content templates
    const startHereContent = `
      <form id="startHereForm">
        <div class="form-group">
          <label for="category">Category</label>
          <select id="category" name="category" required>
            <option value="">Select category</option>
            <option value="BUSINESS AWARDS">BUSINESS AWARDS</option>
            <option value="IMPACT AWARDS">IMPACT AWARDS</option>
            <option value="INDUSTRY AWARDS">INDUSTRY AWARDS</option>
            <option value="LEADERSHIP AWARDS">LEADERSHIP AWARDS</option>
            <option value="PEOPLE'S CHOICE">PEOPLE'S CHOICE</option>
            <option value="WOMAN OF THE YEAR AWARDS">WOMAN OF THE YEAR AWARDS</option>
          </select>
        </div>
        <div class="form-group">
          <label for="name">Name</label>
          <input type="text" id="name" name="name" required />
        </div>
        <div class="form-group">
          <label for="website">Website (optional)</label>
          <input type="text" id="website" name="website" />
        </div>
        <div class="form-group">
          <label for="award">Which Awards would you want to enter?</label>
          <select id="award" name="award" required>
            <option value="">Select award</option>
            <option value="WCWA Americas">WCWA Americas</option>
            <option value="WCWA Middle East & North Africa (MENA)">WCWA Middle East & North Africa (MENA)</option>
            <option value="WCWA Czech Republic">WCWA Czech Republic</option>
            <option value="WCWA South Africa">WCWA South Africa</option>
            <option value="WCWA Global 2025">WCWA Global 2025</option>
          </select>
        </div>
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" name="email" required />
        </div>
        <div class="form-group">
          <label for="mobile">Mobile Number</label>
          <input type="tel" id="mobile" name="mobile" required />
        </div>
        <div class="form-group">
          <label for="address">Address</label>
          <input type="text" id="address" name="address" required autocomplete="off"/>
        </div>
        <div class="form-group">
          <label for="instagram">Instagram profile page URL (if applicable)</label>
          <input type="text" id="instagram" name="instagram" />
        </div>
        <div class="form-group">
          <label for="linkedin">LinkedIn profile page URL (if applicable)</label>
          <input type="text" id="linkedin" name="linkedin" />
        </div>
        <div class="form-actions">
          <button type="button" class="action-btn btn-view" id="saveStartHereBtn">Save</button>
          <button type="button" class="action-btn btn-view" id="saveNextBtn">Save & Next</button>
        </div>
      </form>
    `;

    const criteriaContent = `
      <form id="criteriaForm">
        <div class="form-group">
          <label for="about_yourself">Tell us about yourself</label>
          <textarea id="about_yourself" name="about_yourself" maxlength="1200" rows="3"></textarea>
          <span class="word-count" id="count_about_yourself">0/150</span>
        </div>
        <div class="form-group">
          <label for="about_work">Tell us about your work</label>
          <textarea id="about_work" name="about_work" maxlength="1200" rows="3"></textarea>
          <span class="word-count" id="count_about_work">0/150</span>
        </div>
        <div class="form-group">
          <label for="inspiration">What inspired you to do this work?</label>
          <textarea id="inspiration" name="inspiration" maxlength="1600" rows="4"></textarea>
          <span class="word-count" id="count_inspiration">0/200</span>
        </div>
        <div class="form-group">
          <label for="unique">What makes what you do special or unique?</label>
          <textarea id="unique" name="unique" maxlength="1600" rows="4"></textarea>
          <span class="word-count" id="count_unique">0/200</span>
        </div>
        <div class="form-group">
          <label for="challenge">What has been your greatest challenge & how have you addressed this? </label>
          <textarea id="challenge" name="challenge" maxlength="4000" rows="6"></textarea>
          <span class="word-count" id="count_challenge">0/500</span>
        </div>
        <div class="form-group">
          <label for="achievements">What have been your top 3 greatest achievements in the past 12 months? </label>
          <textarea id="achievements" name="achievements" maxlength="2400" rows="5"></textarea>
          <span class="word-count" id="count_achievements">0/300</span>
        </div>
        <div class="form-group">
          <label for="significance">Why were these achievements significant and what do you attribute your achievements to?</label>
          <textarea id="significance" name="significance" maxlength="1600" rows="4"></textarea>
          <span class="word-count" id="count_significance">0/200</span>
        </div>
        <div class="form-group">
          <label for="vision">What is your big picture vision for the work you are doing? </label>
          <textarea id="vision" name="vision" maxlength="4000" rows="6"></textarea>
          <span class="word-count" id="count_vision">0/500</span>
        </div>
        <div class="form-group">
          <label for="recognition">Why should you be recognised in this category? </label>
          <textarea id="recognition" name="recognition" maxlength="4000" rows="6"></textarea>
          <span class="word-count" id="count_recognition">0/500</span>
        </div>
        <div class="eligibility-check">
          <input type="checkbox" id="confirm-eligibility" />
          <label for="confirm-eligibility" style="font-size: 0.98rem; font-weight: 400;">
            I confirm that I do not have a criminal record and that I meet the minimum requirements and am eligible to enter the Women Changing The World Awards.
          </label>
        </div>
        <div class="form-actions">
          <button type="button" class="action-btn btn-view" id="saveCriteriaBtn">Save</button>
          <button type="button" class="action-btn btn-view" id="previewBtn">Preview</button>
        </div>
      </form>
    `;

    // Single source of truth for state
    let applicationId = null;
    let currentUser = null;
    firebase.auth().onAuthStateChanged(u => { currentUser = u; });

    // Show tab section on Start Entry
    document.getElementById('start-entry-btn').onclick = function() {
      document.getElementById('datesSection').style.display = 'none';
      document.getElementById('tabSection').style.display = 'block';
      document.getElementById('tabContent').innerHTML = startHereContent;
      setUpStartHereTab();
    };

    // Tabs
    document.getElementById('tabStart').onclick = function() {
      document.getElementById('tabStart').classList.add('active');
      document.getElementById('tabCriteria').classList.remove('active');
      document.getElementById('tabContent').innerHTML = startHereContent;
      setUpStartHereTab();
    };
    document.getElementById('tabCriteria').onclick = function() {
      document.getElementById('tabStart').classList.remove('active');
      document.getElementById('tabCriteria').classList.add('active');
      document.getElementById('tabContent').innerHTML = criteriaContent;
      setUpCriteriaTab();
    };

    // Helpers
    const db = () => firebase.firestore();

    function allInputsDisabled(rootEl) {
      const els = (rootEl || document).querySelectorAll('input, select, textarea, button');
      els.forEach(el => el.disabled = true);
    }

    // Prefill from last-saved document
    async function getApplicationData() {
      if (!applicationId) return null;
      try {
        const snap = await db().collection('applications').doc(applicationId).get();
        return snap.exists ? snap.data() : null;
      } catch (e) {
        console.error('Failed to fetch application', e);
        return null;
      }
    }
    function setVal(form, id, value) {
      const el = form.querySelector('#' + id);
      if (el) el.value = value ?? '';
    }
    async function hydrateStartHereForm() {
      const form = document.getElementById('startHereForm');
      if (!form) return;
      const data = await getApplicationData();
      if (!data) return;
      setVal(form, 'category', data.category);
      setVal(form, 'name', data.name);
      setVal(form, 'website', data.website);
      setVal(form, 'award', data.awards_choice);
      setVal(form, 'email', data.email);
      setVal(form, 'mobile', data.mobile_number);
      setVal(form, 'address', data.address);
      setVal(form, 'instagram', data.instagram_url);
      setVal(form, 'linkedin', data.linkedin_url);
    }
    async function hydrateCriteriaForm() {
      const form = document.getElementById('criteriaForm');
      if (!form) return;
      const data = await getApplicationData();
      if (!data) return;
      setVal(form, 'about_yourself', data.tell_us_about_yourself);
      setVal(form, 'about_work', data.tell_us_about_your_work);
      setVal(form, 'inspiration', data.what_inspired_you);
      setVal(form, 'unique', data.what_makes_you_unique);
      setVal(form, 'challenge', data.greatest_challenge);
      setVal(form, 'achievements', data.top_achievements);
      setVal(form, 'significance', data.achievements_significance);
      setVal(form, 'vision', data.big_picture_vision);
      setVal(form, 'recognition', data.recognition_reason);
      const cb = form.querySelector('#confirm-eligibility');
      if (cb) cb.checked = !!data.eligibility;
      const submitBtn = form.querySelector('#submit-application');
      if (submitBtn) submitBtn.disabled = cb ? !cb.checked : true;
    }

    function collectStartHere(form) {
      const val = id => (form.querySelector('#' + id)?.value || '');
      return {
        category: val('category'),
        name: val('name'),
        website: val('website'),
        awards_choice: val('award'),
        email: val('email'),
        mobile_number: val('mobile'),
        address: val('address'),
        instagram_url: val('instagram'),
        linkedin_url: val('linkedin')
      };
    }

    function collectCriteria(form) {
      const val = id => (form.querySelector('#' + id)?.value || '');
      return {
        tell_us_about_yourself: val('about_yourself'),
        tell_us_about_your_work: val('about_work'),
        what_inspired_you: val('inspiration'),
        what_makes_you_unique: val('unique'),
        greatest_challenge: val('challenge'),
        top_achievements: val('achievements'),
        achievements_significance: val('significance'),
        big_picture_vision: val('vision'),
        recognition_reason: val('recognition'),
        eligibility: !!form.querySelector('#confirm-eligibility')?.checked
      };
    }

    // Create/update Start Here data and keep the same document
    async function saveStartHereToFirestore() {
      if (!currentUser) throw new Error('Not signed in');
      const form = document.getElementById('startHereForm');
      if (!form) throw new Error('Start Here form not found');

      const payload = {
        ...collectStartHere(form),
        stage: 'draft',
        user_id: currentUser.uid,
        applicant_id: currentUser.uid,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      if (!applicationId) payload.createdAt = firebase.firestore.FieldValue.serverTimestamp();

      if (!applicationId) {
        const docRef = await db().collection('applications').add(payload); // auto-ID
        applicationId = docRef.id;
        return docRef.id;
      } else {
        await db().collection('applications').doc(applicationId).set(payload, { merge: true });
        return applicationId;
      }
    }

    // 
    async function ensureApplicationDoc() {
      if (applicationId) return applicationId;
      if (!currentUser) throw new Error('Not signed in');
      const base = {
        stage: 'draft',
        user_id: currentUser.uid,
        applicant_id: currentUser.uid,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      const docRef = await db().collection('applications').add(base);
      applicationId = docRef.id;
      return applicationId;
    }

    // START HERE handlers
    function setUpStartHereTab() {
      const saveBtn = document.getElementById('saveStartHereBtn');
      const nextBtn = document.getElementById('saveNextBtn');

      if (saveBtn) {
        saveBtn.onclick = async function () {
          try {
            await saveStartHereToFirestore();
            alert('Application saved as draft.');
          } catch (err) {
            console.error(err);
            alert('Failed to save application: ' + err.message);
          }
        };
      }

      if (nextBtn) {
        nextBtn.onclick = async function () {
          try {
            await saveStartHereToFirestore();
            const critTab = document.getElementById('tabCriteria');
            if (critTab) {
              critTab.disabled = false;
              critTab.click();
            }
          } catch (err) {
            console.error(err);
            alert('Failed to save application: ' + err.message);
          }
        };
      }

      // Prefill with last-saved data
      hydrateStartHereForm();
    }

    // CRITERIA handlers
    function setUpCriteriaTab() {
      const saveBtn = document.getElementById('saveCriteriaBtn');
      const checkbox = document.getElementById('confirm-eligibility');
      const previewBtn = document.getElementById('previewBtn');

      if (saveBtn) {
        saveBtn.onclick = async function () {
          try {
            if (!currentUser) throw new Error('Not signed in');
            const form = document.getElementById('criteriaForm');
            if (!form) throw new Error('Criteria form not found');

            await ensureApplicationDoc();
            const payload = {
              ...collectCriteria(form),
              updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
              stage: 'draft'
            };
            await db().collection('applications').doc(applicationId).set(payload, { merge: true });
            alert('Criteria saved as draft.');
          } catch (err) {
            console.error(err);
            alert('Failed to save criteria: ' + err.message);
          }
        };
      }

      // Open preview 
      if (previewBtn) {
        previewBtn.onclick = async function () {
          try {
            await openPreviewModal();
          } catch (err) {
            console.error(err);
            alert('Failed to open preview: ' + err.message);
          }
        };
      }

      if (checkbox) {
        checkbox.onchange = () => {};
      }

      // Prefill with last-saved data
      hydrateCriteriaForm();
    }
  </script>
  <script>
</script>

<script>
(function initContinueApplication() {
  try {
    const qs = new URLSearchParams(location.search);
    const idFromUrl = qs.get('application');
    const idFromSession = sessionStorage.getItem('continueApplicationId');
    const id = idFromUrl || idFromSession;

    if (!id) return; // new-application flow

    sessionStorage.removeItem('continueApplicationId');
    applicationId = id;

    // Show tabs and default to Start Here
    const dates = document.getElementById('datesSection');
    const tabs = document.getElementById('tabSection');
    if (dates) dates.style.display = 'none';
    if (tabs) tabs.style.display = 'block';

    const tabStart = document.getElementById('tabStart');
    const tabCriteria = document.getElementById('tabCriteria');
    const tabContent = document.getElementById('tabContent');

    tabStart?.classList.add('active');
    if (tabCriteria) {
      tabCriteria.disabled = false; 
      tabCriteria.classList.remove('active');
    }

    if (tabContent) {
      tabContent.innerHTML = typeof startHereContent !== 'undefined' ? startHereContent : '';
      if (typeof setUpStartHereTab === 'function') setUpStartHereTab();
    }

    if (typeof hydrateStartHereForm === 'function') hydrateStartHereForm();
  } catch (e) {
    console.error('Failed to initialize continued application', e);
  }
})();
</script>
<script>

function pvSet(id, v) { const el = document.getElementById(id); if (el) el.value = v ?? ''; }
function pvGet(id) { const el = document.getElementById(id); return el ? el.value || '' : ''; }

function collectPreviewStartHere() {
  return {
    category: pvGet('pv_category'),
    name: pvGet('pv_name'),
    website: pvGet('pv_website'),
    awards_choice: pvGet('pv_award'),
    email: pvGet('pv_email'),
    mobile_number: pvGet('pv_mobile'),
    address: pvGet('pv_address'),
    instagram_url: pvGet('pv_instagram'),
    linkedin_url: pvGet('pv_linkedin')
  };
}
function collectPreviewCriteria() {
  return {
    tell_us_about_yourself: pvGet('pv_about_yourself'),
    tell_us_about_your_work: pvGet('pv_about_work'),
    what_inspired_you: pvGet('pv_inspiration'),
    what_makes_you_unique: pvGet('pv_unique'),
    greatest_challenge: pvGet('pv_challenge'),
    top_achievements: pvGet('pv_achievements'),
    achievements_significance: pvGet('pv_significance'),
    big_picture_vision: pvGet('pv_vision'),
    recognition_reason: pvGet('pv_recognition'),
    eligibility: !!document.getElementById('pv_confirm_eligibility')?.checked
  };
}

async function openPreviewModal() {
  const startForm = document.getElementById('startHereForm');
  const criteriaForm = document.getElementById('criteriaForm');
  let startData = startForm ? collectStartHere(startForm) : {};
  let critData = criteriaForm ? collectCriteria(criteriaForm) : {};

  // If fields are empty and we have an applicationId, try to hydrate from Firestore
  if (applicationId) {
    const data = await getApplicationData();
    if (data) {
      startData = { ...startData, 
        category: startData.category || data.category,
        name: startData.name || data.name,
        website: startData.website || data.website,
        awards_choice: startData.awards_choice || data.awards_choice,
        email: startData.email || data.email,
        mobile_number: startData.mobile_number || data.mobile_number,
        address: startData.address || data.address,
        instagram_url: startData.instagram_url || data.instagram_url,
        linkedin_url: startData.linkedin_url || data.linkedin_url
      };
      critData = { ...critData,
        tell_us_about_yourself: critData.tell_us_about_yourself || data.tell_us_about_yourself,
        tell_us_about_your_work: critData.tell_us_about_your_work || data.tell_us_about_your_work,
        what_inspired_you: critData.what_inspired_you || data.what_inspired_you,
        what_makes_you_unique: critData.what_makes_you_unique || data.what_makes_you_unique,
        greatest_challenge: critData.greatest_challenge || data.greatest_challenge,
        top_achievements: critData.top_achievements || data.top_achievements,
        achievements_significance: critData.achievements_significance || data.achievements_significance,
        big_picture_vision: critData.big_picture_vision || data.big_picture_vision,
        recognition_reason: critData.recognition_reason || data.recognition_reason,
        eligibility: typeof critData.eligibility === 'boolean' ? critData.eligibility : !!data.eligibility
      };
    }
  }

  // Fill preview inputs
  pvSet('pv_category', startData.category);
  pvSet('pv_award', startData.awards_choice);
  pvSet('pv_name', startData.name);
  pvSet('pv_website', startData.website);
  pvSet('pv_email', startData.email);
  pvSet('pv_mobile', startData.mobile_number);
  pvSet('pv_address', startData.address);
  pvSet('pv_instagram', startData.instagram_url);
  pvSet('pv_linkedin', startData.linkedin_url);

  pvSet('pv_about_yourself', critData.tell_us_about_yourself);
  pvSet('pv_about_work', critData.tell_us_about_your_work);
  pvSet('pv_inspiration', critData.what_inspired_you);
  pvSet('pv_unique', critData.what_makes_you_unique);
  pvSet('pv_challenge', critData.greatest_challenge);
  pvSet('pv_achievements', critData.top_achievements);
  pvSet('pv_significance', critData.achievements_significance);
  pvSet('pv_vision', critData.big_picture_vision);
  pvSet('pv_recognition', critData.recognition_reason);
  const pvcb = document.getElementById('pv_confirm_eligibility');
  if (pvcb) pvcb.checked = !!critData.eligibility;

  const pvSubmit = document.getElementById('previewSubmit');
  const pvCheck = document.getElementById('pv_confirm_eligibility');
  if (pvSubmit && pvCheck) {
    pvSubmit.disabled = !pvCheck.checked;
    pvCheck.onchange = () => { pvSubmit.disabled = !pvCheck.checked; };
  }

  // Open
  document.getElementById('previewModal').classList.add('open');
  document.getElementById('previewModal').setAttribute('aria-hidden','false');
}

function closePreviewModal() {
  const el = document.getElementById('previewModal');
  el.classList.remove('open');
  el.setAttribute('aria-hidden','true');
}

document.getElementById('previewClose')?.addEventListener('click', closePreviewModal);
document.getElementById('previewModal')?.addEventListener('click', (e) => {
  if (e.target.id === 'previewModal') closePreviewModal();
});

// Submit from preview 
document.getElementById('previewSubmit')?.addEventListener('click', async () => {
  try {
    if (!currentUser) throw new Error('Not signed in');
    await ensureApplicationDoc();

    const payload = {
      ...collectPreviewStartHere(),
      ...collectPreviewCriteria(),
      stage: 'submitted',
      status: 'submitted',
      submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      user_id: currentUser.uid,
      applicant_id: currentUser.uid
    };

    await db().collection('applications').doc(applicationId).set(payload, { merge: true });
    alert('Application submitted successfully.');
    applicationId = null;
    window.location.href = 'applicantdashboard.html';
  } catch (err) {
    console.error(err);
    alert('Failed to submit application: ' + err.message);
  }
});
</script>
</body>
</html>