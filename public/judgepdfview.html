<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Print Application</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    html,body { height:100%; margin:0; font-family: Arial, sans-serif; background:#fff; color:#111; }
    .wrap { height:100%; display:flex; flex-direction:column; }
    .toolbar {
      background:#fff; padding:10px 16px; border-bottom:1px solid #eee; display:flex; align-items:center; gap:12px;
    }
    .btn {
      padding:8px 14px; border-radius:6px; border:1px solid #ccc; background:#fff; cursor:pointer; font-weight:700;
    }
    .btn-primary { background:#d7336f; color:#fff; border-color:#d7336f; }
    .loader { color:#666; font-size:14px; }
    .frame-wrap { flex:1; }
    iframe { width:100%; height:100%; border:0; display:block; }
    .note { font-size:13px; color:#666; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="toolbar">
      <div class="loader" id="status">Preparing print view…</div>
      <div style="flex:1"></div>
      <button id="printBtn" class="btn btn-primary" style="display:none;">Print</button>
      <button id="closeBtn" class="btn" style="display:none;">Close</button>
    </div>

    <div class="frame-wrap" id="frameWrap" aria-live="polite">
      <!-- iframe will be injected here -->
    </div>

    <div style="padding:10px 16px;border-top:1px solid #f0f0f0;background:#fff;">
      <div class="note">If automatic printing fails, click "Print" to open the print dialog for the application.</div>
    </div>
  </div>

  <script>
    (function(){
      const params = new URLSearchParams(window.location.search);
      const appId = params.get('id');
      const frameWrap = document.getElementById('frameWrap');
      const status = document.getElementById('status');
      const printBtn = document.getElementById('printBtn');
      const closeBtn = document.getElementById('closeBtn');

      if (!appId) {
        status.textContent = 'No application id provided.';
        return;
      }

      // Use the real application view so styling/colors are preserved.
      const iframe = document.createElement('iframe');
      // add a flag so judgeapplicationview can optionally avoid extra chrome when embedded (if you support it)
      iframe.src = `judgeapplicationview.html?id=${encodeURIComponent(appId)}&embeddedPrint=1`;
      iframe.title = 'Application print preview';
      iframe.setAttribute('allowfullscreen','');
      iframe.style.background = '#fff';
      frameWrap.appendChild(iframe);

      // helper to attempt printing the iframe content (safe try/catch)
      async function tryPrint() {
        try {
          if (!iframe.contentWindow) throw new Error('iframe not ready');
          // focus iframe before print to improve reliability
          iframe.contentWindow.focus();
          // small delay to allow any in-iframe scripts to finish rendering
          await new Promise(r => setTimeout(r, 300));
          iframe.contentWindow.print();
          status.textContent = 'Print dialog opened.';
        } catch (err) {
          console.warn('Print failed:', err);
          status.textContent = 'Automatic print failed — use the Print button below.';
          printBtn.style.display = 'inline-block';
          closeBtn.style.display = 'inline-block';
        }
      }

      // When iframe loads, attempt auto-print
      iframe.addEventListener('load', function() {
        status.textContent = 'Print preview loaded. Opening print dialog…';
        // attempt automatic print (do not block if it errors)
        tryPrint();
      });

      // Manual controls
      printBtn.addEventListener('click', function(){
        tryPrint();
      });
      closeBtn.addEventListener('click', function(){
        window.close();
      });

      // Fallback: if popup blockers prevent window.close, show a message
      window.addEventListener('beforeunload', function(){});
    })();
  </script>
</body>
</html>