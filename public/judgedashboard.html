<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Judge Dashboard - WCW Awards</title>

  <style>
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background-color: #f4f4f4;
    color: #333;
  }

  header {
    background-color: #d7336f;
    color: white;
    padding: 20px 30px;
    display: flex;
    align-items: center;
    /* Flush header content to the left */
    justify-content: flex-start;
  }

  header h1 {
    margin: 0;
    font-size: 24px;
    font-weight: bold;
    letter-spacing: 0.5px;
  }

  .logout-btn {
    background-color: white;
    color: #d7336f;
    padding: 8px 16px;
    border: none;
    border-radius: 5px;
    font-weight: bold;
    cursor: pointer;
    margin-left: auto;
  }

  .logout-btn:hover {
    background-color: #ffe6ee;
  }

  main {
    padding: 40px 30px;
  }

  .dashboard-section {
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 15px rgba(0,0,0,0.1);
    max-width: 1100px;
    margin: 30px auto;
  }

  .dashboard-section h2 {
    color: #d7336f;
    margin-bottom: 20px;
    text-align: left;
  }

  .dashboard-section p {
    font-size: 16px;
    margin-bottom: 20px;
  }

  .dashboard-section button {
    padding: 12px 20px;
    background-color: #d7336f;
    color: white;
    border: none;
    border-radius: 5px;
    font-size: 16px;
    cursor: pointer;
  }

  .dashboard-section button:hover {
    background-color: #b8235a;
  }

  table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 10px;
    margin-top: 10px;
  }

  thead tr {
    background: #faf0f4;
  }

  th, td {
    padding: 12px 16px;
    text-align: left;
    font-size: 15px;
  }

  th {
    color: #8c1f4c;
    font-weight: 700;
  }

  tbody tr {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(215,51,111,0.04);
  }

  tbody tr td {
    border-top: 1px solid #f4f4f4;
    border-bottom: 1px solid #f4f4f4;
  }

  .list-header {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 10px;
    margin-bottom: 18px;
  }

  .list-header label {
    font-weight: 700;
    color: #d7336f;
    font-size: 1.1em;
    margin-bottom: 6px;
  }

  .list-header select {
    padding: 10px 16px;
    border-radius: 6px;
    border: 1px solid #d7336f;
    font-size: 1em;
    background: #fff;
    color: #d7336f;
    min-width: 220px;
  }

  footer {
    text-align: center;
    margin-top: 60px;
    font-size: 14px;
    color: #888;
  }
  </style>
</head>

<body>
  <header>
    <h1>Welcome, <span id="judgeName">Judge</span></h1>
    <button class="logout-btn" onclick="logout()">Log Out</button>
  </header>

  <main>
    <div class="dashboard-section" style="max-width:1100px;">
  <h2 style="color:#d7336f;margin-bottom:0.5em;">Judging information</h2>
      <div style="background:#ffe6ee;padding:18px 24px;border-radius:8px;margin-bottom:30px;">
        <b>Some tips to help you get started:</b>
        <ol style="margin-top:10px;">
          <li>Clicking on the entry name will take you into the entry view.</li>
          <li>When you click into an entry, you will see all the details entered by the entrant on the left side of the page. On the right side, is where you put in your score and comments.</li>
          <li>If you wish to abstain from judging for any reason, check the box on top on the right side and you can skip scoring that entry.</li>
          <li>The <i>Comments</i> box can be seen by organisers and may be used publicly.</li>
          <li>Once you have scored all criteria, hit 'Save & next' to move to the next entry.</li>
          <li>The status 'to be scored' refers to an entry that is yet to be scored.</li>
          <li>The status 'in progress' refers to an entry that hasn't had all the criteria scored yet (but has commenced).</li>
          <li>The status 'complete' refers to an entry that has had all criteria scored and is therefore completed.</li>
          <li>You can also view/download a PDF for each entry for offline use.</li>
        </ol>
      </div>
      <div class="list-header" style="display:flex;align-items:center;justify-content:flex-end;gap:10px;margin-bottom:18px;">
        <div style="display:flex;flex-direction:column;align-items:flex-end;width:100%;">
          <label style="font-weight:700;color:#d7336f;font-size:1.1em;margin-bottom:6px;">Sort/Filter By</label>
          <select id="sortDropdown" style="padding:10px 16px;border-radius:6px;border:1px solid #d7336f;font-size:1em;background:#fff;color:#d7336f;min-width:220px;">
            <option value="">(Clear All)</option>
            <option value="category_asc">Category (Ascending)</option>
            <option value="category_desc">Category (Descending)</option>
            <option value="status_new">Status (New)</option>
            <option value="status_saved">Status (Saved)</option>
            <option value="status_submitted">Status (Submitted)</option>
          </select>
        </div>
      </div>
      <table style="width:100%;border-collapse:separate;border-spacing:0 10px;">
        <thead>
          <tr style="background:#faf0f4;">
            <th style="padding:12px 16px;color:#8c1f4c;font-size:15px;font-weight:700;">Application ID</th>
            <th style="padding:12px 16px;color:#8c1f4c;font-size:15px;font-weight:700;">Name</th>
            <th style="padding:12px 16px;color:#8c1f4c;font-size:15px;font-weight:700;">Category</th>
            <th style="padding:12px 16px;color:#8c1f4c;font-size:15px;font-weight:700;">Subcategory</th>
            <th style="padding:12px 16px;color:#8c1f4c;font-size:15px;font-weight:700;">Status</th>
            <th style="padding:12px 16px;color:#8c1f4c;font-size:15px;font-weight:700;">Last Updated</th>
            <th style="padding:12px 16px;color:#8c1f4c;font-size:15px;font-weight:700;">Actions</th>
          </tr>
        </thead>
        <tbody id="appsBody">
          <!-- Table rows will be rendered by JS -->
        </tbody>
      </table>
      <div id="viewModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:1000;align-items:center;justify-content:center;">
        <div style="background:#fff;border-radius:10px;max-width:1100px;width:90vw;box-shadow:0 12px 40px rgba(0,0,0,.25);overflow:auto;max-height:90vh;position:relative;">
          <button id="closeViewModal" style="position:absolute;top:18px;right:18px;background:#d7336f;color:#fff;border:none;border-radius:5px;padding:8px 16px;font-weight:bold;cursor:pointer;">Close</button>
          <div id="viewModalContent" style="padding:40px 32px 32px 32px;"></div>
        </div>
      </div>
    </div>
  </main>

  <footer>
    &copy; 2025 WCW Awards Platform. All rights reserved.
  </footer>

  <!-- Firebase SDKs -->
  <script src="/__/firebase/12.0.0/firebase-app-compat.js"></script>
  <script src="/__/firebase/12.0.0/firebase-auth-compat.js"></script>
  <script src="/__/firebase/12.0.0/firebase-firestore-compat.js"></script>
  <script src="/__/firebase/init.js?useEmulator=true"></script>
  <script>
document.addEventListener('DOMContentLoaded', function() {
  const tableBody = document.getElementById('appsBody');
  const sortDropdown = document.getElementById('sortDropdown');
  let rows = [];

  function renderTable(filteredRows) {
    tableBody.innerHTML = '';
    if (!filteredRows.length) {
      tableBody.innerHTML = '<tr><td colspan="7">No assigned applications found.</td></tr>';
      return;
    }
    for (const row of filteredRows) {
      tableBody.innerHTML += `
        <tr>
          <td>${row.applicationId}</td>
          <td>${row.name}</td>
          <td>${row.category}</td>
          <td>${row.subcategory}</td>
          <td>${row.status}</td>
          <td>${row.lastUpdated}</td>
          <td>
            <button class="logout-btn" onclick="onView('${row.applicationId}')">View</button>
          </td>
        </tr>
      `;
    }

    // Store the filtered application IDs for navigation in application view
    localStorage.setItem('judgeFilteredAppIds', JSON.stringify(filteredRows.map(r => r.applicationId)));
  }

  sortDropdown.addEventListener('change', function() {
    let filtered = [...rows];
    const val = sortDropdown.value;
    if (val === "category_asc") {
      filtered.sort((a, b) => (a.category || '').localeCompare(b.category || ''));
    } else if (val === "category_desc") {
      filtered.sort((a, b) => (b.category || '').localeCompare(a.category || ''));
    } else if (val === "status_new") {
      filtered = filtered.filter(r => r.status === "new");
    } else if (val === "status_saved") {
      filtered = filtered.filter(r => r.status === "saved");
    } else if (val === "status_submitted") {
      filtered = filtered.filter(r => r.status === "submitted");
    } else {
      localStorage.removeItem('judgeFilteredAppIds');
      localStorage.removeItem('judgeCurrentIndex');
    }
    renderTable(filtered);
  });

  firebase.auth().onAuthStateChanged(async user => {
    if (!user) {
      tableBody.innerHTML = '<tr><td colspan="7">Please log in.</td></tr>';
      return;
    }
    const judgeId = user.uid;
    const db = firebase.firestore();

    try {
      const assignmentsSnap = await db.collection('judgeAssignments')
        .where('judgeId', '==', judgeId)
        .get();

      if (assignmentsSnap.empty) {
        tableBody.innerHTML = '<tr><td colspan="7">No assigned applications found.</td></tr>';
        return;
      }

      rows = [];
      for (const doc of assignmentsSnap.docs) {
        const assign = doc.data();
        const appId = assign.applicationId;
        let appData = {};
        if (appId) {
          const appDoc = await db.collection('applications').doc(appId).get();
          if (appDoc.exists) {
            appData = appDoc.data();
          }
        }

        // Fetch judgeResponses status
        let judgeStatus = "new";
        try {
          const judgeRespDoc = await db.collection('judgeResponses').doc(judgeId + '_' + appId).get();
          if (judgeRespDoc.exists && judgeRespDoc.data().status) {
            judgeStatus = judgeRespDoc.data().status;
          }
        } catch (e) {
          // ignore, fallback to "new"
        }

        rows.push({
          applicationId: appId || '-',
          name: appData.name || assign.entryName || '-',
          category: appData.category || '-',
          subcategory: appData.subcategory || '-',
          status: judgeStatus,
          lastUpdated: assign.updatedAt ? new Date(assign.updatedAt.seconds * 1000).toLocaleString() : '-'
        });
      }
      renderTable(rows);
    } catch (err) {
      console.error(err);
      tableBody.innerHTML = '<tr><td colspan="7">Error loading assignments.</td></tr>';
    }
  });

  window.onView = function(applicationId) {
    const filteredAppIds = JSON.parse(localStorage.getItem('judgeFilteredAppIds') || '[]');
    const currentIndex = filteredAppIds.indexOf(applicationId);
    localStorage.setItem('judgeCurrentIndex', currentIndex);
    window.location.href = `judgeapplicationview.html?id=${applicationId}`;
  }
});
  </script>
</body>
</html>
