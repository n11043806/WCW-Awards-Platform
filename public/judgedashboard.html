<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Judge Dashboard - WCW Awards</title>

  <!-- ADDED: Material Symbols font for pdf icon matching adminentriestab -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

  <style>
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background-color: #f4f4f4;
    color: #333;
  }

  header {
    background-color: #d7336f;
    color: white;
    padding: 20px 30px;
    display: flex;
    align-items: center;
    /* Flush header content to the left */
    justify-content: flex-start;
  }

  header h1 {
    margin: 0;
    font-size: 24px;
    font-weight: bold;
    letter-spacing: 0.5px;
  }

  .logout-btn {
    background-color: white;
    color: #d7336f;
    padding: 8px 16px;
    border: none;
    border-radius: 5px;
    font-weight: bold;
    cursor: pointer;
    margin-left: auto;
  }

  .logout-btn:hover {
    background-color: #ffe6ee;
  }

  main {
    padding: 40px 30px;
  }

  .dashboard-section {
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 15px rgba(0,0,0,0.1);
    max-width: 1100px;
    margin: 30px auto;
  }

  .dashboard-section h2 {
    color: #d7336f;
    margin-bottom: 20px;
    text-align: left;
  }

  .dashboard-section p {
    font-size: 16px;
    margin-bottom: 20px;
  }

  .dashboard-section button {
    padding: 12px 20px;
    background-color: #d7336f;
    color: white;
    border: none;
    border-radius: 5px;
    font-size: 16px;
    cursor: pointer;
  }

  .dashboard-section button:hover {
    background-color: #b8235a;
  }

  table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 10px;
    margin-top: 10px;
  }

  thead tr {
    background: #faf0f4;
  }

  th, td {
    padding: 12px 16px;
    text-align: left;
    font-size: 15px;
  }

  th {
    color: #8c1f4c;
    font-weight: 700;
  }

  tbody tr {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(215,51,111,0.04);
  }

  tbody tr td {
    border-top: 1px solid #f4f4f4;
    border-bottom: 1px solid #f4f4f4;
  }

  .list-header {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 10px;
    margin-bottom: 18px;
  }

  .list-header label {
    font-weight: 700;
    color: #d7336f;
    font-size: 1.1em;
    margin-bottom: 6px;
  }

  .list-header select {
    padding: 10px 16px;
    border-radius: 6px;
    border: 1px solid #d7336f;
    font-size: 1em;
    background: #fff;
    color: #d7336f;
    min-width: 220px;
  }

  footer {
    text-align: center;
    margin-top: 60px;
    font-size: 14px;
    color: #888;
  }

    /* Update just the PDF button colors to match site theme */
    .pdf-btn {
      background: #d7336f;               
      border: 2px solid transparent;
      padding: 6px 8px;
      border-radius: 6px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .pdf-btn:active { transform: translateY(1px); }
    .pdf-btn:hover { background: #b8235a; } 

    .material-symbols-outlined.pdf-icon {
      font-variation-settings: 'wght' 700;
      font-size: 22px;                   
      vertical-align: middle;
      color: #fff;                   
      transition: color .12s ease;
    }
    .pdf-btn:hover .pdf-icon { color: #fff; }


  .profile-btn {
    background-color: #d7336f;
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 10px 24px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    margin-right: 10px;
  }

  .profile-btn:hover {
    background-color: #b8235a;
  }

  /* Dropdown styled to match judgeprofile (pale pink card, maroon accents) */
.profile-menu { position: relative; display: inline-block; }
.profile-avatar {
  background: #b84b7a; /* darker maroon circle */
  color: #fff;
  border: 3px solid rgba(255,255,255,0.12);
  width: 40px;
  height: 40px;
  border-radius: 50%;
  font-weight:700;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  box-shadow: 0 2px 0 rgba(0,0,0,0.06) inset;
}
.profile-dropdown {
  display: none;
  position: absolute;
  top: 52px;
  right: 0;
  min-width: 170px;
  background: #ffeef3; /* pale pink */
  border: 1px solid #b84b7a; /* maroon border */
  border-radius: 10px;
  box-shadow: 0 8px 20px rgba(184,75,122,0.12);
  padding: 6px 0;
  z-index: 200;
}
.profile-dropdown.open { display: block; }
.profile-dropdown button {
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  width:100%;
  padding:10px 14px;
  background:transparent;
  border:0;
  color:#b84b7a;
  font-weight:600;
  cursor:pointer;
  font-size:14px;
}
.profile-dropdown button .icon { opacity:0.95; font-size:16px; }
.profile-dropdown button:hover { background:#ffe0ef; }

  .profile-menu {
    position: relative;
    display: inline-block;
  }

  .profile-avatar {
    background: #b8235a;
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 38px;
    height: 38px;
    font-size: 1.2em;
    font-weight: bold;
    cursor: pointer;
  }

  .profile-dropdown {
    position: absolute;
    top: 45px;
    right: 0;
    background: #ffe6ee;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    min-width: 160px;
    z-index: 100;
    padding: 8px 0;
  }

  .profile-dropdown button {
    background: none;
    border: none;
    width: 100%;
    text-align: left;
    padding: 10px 18px;
    color: #d7336f;
    font-size: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .profile-dropdown button:hover {
    background: #ffd6e6;
  }

  .back-btn {
    background: #fff;
    color: #d7336f;
    border: none;
    border-radius: 6px;
    padding: 10px 24px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
  }

  .back-btn:hover {
    background-color: #b8235a;
  }

  /* Add these CSS styles in your <style> section */
.sort-dropdown { 
  position: relative; 
  display: inline-block; 
}

.sort-btn {
  background: #fff;
  color: #572338;
  border: 2px solid #572338;
  border-radius: 4px;
  padding: 6px 12px;
  font-weight: 700;
  cursor: pointer;
  min-width: 180px;
  text-align: left;
}

.sort-btn:after { 
  content: "â–¼"; 
  float: right; 
  font-size: 12px; 
  margin-left: 8px; 
}

.sort-list {
  display: none;
  position: absolute;
  top: 110%;
  left: 0;
  background: #fff;
  border: 1px solid #eee;
  border-radius: 4px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  min-width: 220px;
  z-index: 10;
}

.sort-list.open { 
  display: block; 
}

.sort-list button {
  width: 100%;
  background: none;
  border: none;
  padding: 8px 12px;
  text-align: left;
  font-size: 14px;
  color: #572338;
  cursor: pointer;
}

.sort-list button:hover { 
  background: #f0e4e9; 
}

/* Add filter button and modal styles */
.btn-filter {
  background: #a1466b;
  color: #eec5d6;
  border: 2px solid #572338;
  padding: 8px 12px;
  border-radius: 6px;
  font-weight: 700;
  cursor: pointer;
}
.btn-filter:hover { background: #eec5d6; color: #572338; }

/* Filter modal styles */
.modal {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,.4);
  z-index: 1000;
  padding: 24px;
}

.modal.open { display: flex; }

.modal-dialog {
  background: #fff;
  border-radius: 10px;
  max-width: 980px;
  width: 100%;
  box-shadow: 0 12px 40px rgba(0,0,0,.25);
  overflow: hidden;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px 18px;
  background: #faf0f4;
  color: #8c1f4c;
}

.modal-body {
  padding: 18px;
  max-height: 75vh;
  overflow: auto;
}

.filters-grid { 
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
  margin-top: 20px;
}

.filter-group { 
  border: 1px solid #eee;
  padding: 16px;
  border-radius: 6px;
  background: #fcfcfc;
}

.filter-group h4 { 
  color: #8c1f4c;
  margin: 0 0 12px 0;
  font-size: 15px;
}

.chk { 
  display: flex;
  gap: 8px;
  align-items: center;
  margin: 8px 0;
  font-size: 14px;
}

.chk input[type="checkbox"] {
  margin: 0;
}

.filter-select {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
  color: #333;
  background: #fff;
}

.filter-select:focus {
  border-color: #d7336f;
  outline: none;
}

/* New styles for PDF export */
@page { margin: 2cm; }
body {
  margin: 0;
  font-family: Arial, sans-serif;
  color: #333;
  background: #fff;
}
.header {
  margin-bottom: 20px;
  border-bottom: 2px solid #d7336f;
  padding-bottom: 10px;
}
.content { padding: 0 20px; }
.criteria-row {
  margin-bottom: 30px;
  page-break-inside: avoid;
}
.card {
  background: #fff;
  padding: 18px;
  border-radius: 8px;
  box-shadow: 0 4px 14px rgba(0,0,0,0.04);
  margin-bottom: 18px;
}
h2 {
  margin: 0 0 12px 0;
  color: #333;
  font-weight: 600;
  font-size: 18px;
}
.field {
  background: #fff;
  padding: 12px;
  border-radius: 6px;
  border: 1px solid #f0f0f0;
  color: #333;
  margin-bottom: 12px;
  white-space: pre-wrap;
  line-height: 1.45;
}
.criterion {
  margin: 0;
  display: flex;
  gap: 16px;
  align-items: flex-start;
  border: 1px solid #eee;
  padding: 16px;
  border-radius: 6px;
  background: #fff;
  margin-top: 15px;
  width: 100%;
}
.score-box {
  background: #6e1742;
  color: #fff;
  padding: 12px;
  border-radius: 6px;
  width: 120px;
  text-align: center;
  font-weight: 700;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  flex-shrink: 0;
}
.score-input {
  background: white;
  color: #333;
  padding: 6px 8px;
  border-radius: 4px;
  width: 100%;
  text-align: center;
}
.comment-area {
  flex: 1;
  margin-right: 16px;
  max-width: calc(100% - 140px);
}
.comment-box {
  width: 100%;
  min-height: 100px;
  border: 1px solid #e0e0e0;
  border-radius: 6px;
  padding: 8px;
  box-sizing: border-box;
  margin-right: 16px;
}
footer {
  margin-top: 30px;
  text-align: center;
  font-size: 12px;
  color: #666;
}
  </style>
</head>

<body>
  <header>
    <h1>Welcome, <span id="judgeName">Judge</span></h1>
    <div style="display:flex;align-items:center;justify-content:flex-end;gap:10px;position:absolute;top:20px;right:30px;">
      <!-- user's first name will be placed here (replaces logout button position) -->
      <span id="headerUserName" style="font-weight:bold;color:#fff;margin-right:8px;"></span>
      <div class="profile-menu" id="profileMenuRoot">
  <button id="avatarBtn" class="profile-avatar" aria-haspopup="true" aria-expanded="false">A</button>

  <div id="profileDropdown" class="profile-dropdown" aria-hidden="true">
    <button type="button" onclick="window.location.href='judgeprofile.html'">
      <span>Profile</span>
      <span class="pd-icon" aria-hidden="true">ðŸ‘¤</span>
    </button>
    <button onclick="window.open('https://support.awardforce.com/hc/en-us','_blank')">
      Get help <span class="material-symbols-outlined" style="font-size:20px;">help</span>
    </button>
    <button id="headerLogoutBtn" type="button">
      <span>Log out</span>
      <span class="pd-icon" aria-hidden="true">â¤´</span>
    </button>
  </div>
</div>
      <!-- logout removed as requested -->
    </div>
  </header>

  <main>
    <div class="dashboard-section" style="max-width:1100px;">
  <h2 style="color:#d7336f;margin-bottom:0.5em;">Judging information</h2>
      <div style="background:#ffe6ee;padding:18px 24px;border-radius:8px;margin-bottom:30px;">
        <b>Some tips to help you get started:</b>
        <ol style="margin-top:10px;">
          <li>Clicking on the entry name will take you into the entry view.</li>
          <li>When you click into an entry, you will see all the details entered by the entrant on the left side of the page. On the right side, is where you put in your score and comments.</li>
          <li>If you wish to abstain from judging for any reason, check the box on top on the right side and you can skip scoring that entry.</li>
          <li>The <i>Comments</i> box can be seen by organisers and may be used publicly.</li>
          <li>Once you have scored all criteria, hit 'Save & next' to move to the next entry.</li>
          <li>The status 'to be scored' refers to an entry that is yet to be scored.</li>
          <li>The status 'in progress' refers to an entry that hasn't had all the criteria scored yet (but has commenced).</li>
          <li>The status 'complete' refers to an entry that has had all criteria scored and is therefore completed.</li>
          <li>You can also view/download a PDF for each entry for offline use.</li>
        </ol>
      </div>

<div style="display:flex;justify-content:flex-end;gap:12px;margin-bottom:20px;">
        <div class="sort-dropdown" id="sortDropdown">
          <button class="sort-btn" id="sortBtn">SORT BY: -select-</button>
          <div class="sort-list" id="sortList">
            <button data-sort="none">-select-</button>
            <button data-sort="asc">Application ID Ascending</button>
            <button data-sort="desc">Application ID Descending</button>
            <button data-sort="updated_desc">Updated (Newest first)</button>
            <button data-sort="updated_asc">Updated (Oldest first)</button>
          </div>
        </div>
        <button id="openFilter" class="btn-filter">Filter</button>
      </div>

<!-- Add filter modal -->
<div id="filterModal" class="modal" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-header">
      <strong>Filter</strong>
      <button id="filterClose" class="close-btn">Close</button>
    </div>
    <div class="modal-body">
      <div class="filters-grid">
        <div class="filter-group">
          <h4>Applicant Name</h4>
          <select id="flt_names" class="filter-select">
            <option value="">All Names</option>
          </select>
        </div>
        <div class="filter-group">
          <h4>Category</h4>
          <select id="flt_categories" class="filter-select">
            <option value="">All Categories</option>
          </select>
        </div>
        <div class="filter-group">
          <h4>Subcategory</h4>
          <select id="flt_subcategories" class="filter-select">
            <option value="">All Subcategories</option>
          </select>
        </div>
        <div class="filter-group">
          <h4>Status</h4>
          <div id="flt_status">
            <label class="chk"><input type="checkbox" value="new"/> New</label>
            <label class="chk"><input type="checkbox" value="saved"/> In Progress</label>
            <label class="chk"><input type="checkbox" value="submitted"/> Complete</label>
          </div>
        </div>
      </div>
      <div style="margin-top:12px; display:flex; gap:12px;">
        <button id="filterApply" class="action-btn btn-view">Done</button>
        <button id="filterClear" class="close-btn">Clear</button>
      </div>
    </div>
  </div>
</div>

      <table style="width:100%;border-collapse:separate;border-spacing:0 10px;">
        <thead>
          <tr style="background:#faf0f4;">
            <th style="padding:12px 16px;color:#8c1f4c;font-size:15px;font-weight:700;">Application ID</th>
            <th style="padding:12px 16px;color:#8c1f4c;font-size:15px;font-weight:700;">Name</th>
            <th style="padding:12px 16px;color:#8c1f4c;font-size:15px;font-weight:700;">Category</th>
            <th style="padding:12px 16px;color:#8c1f4c;font-size:15px;font-weight:700;">Subcategory</th>
            <th style="padding:12px 16px;color:#8c1f4c;font-size:15px;font-weight:700;">Status</th>
            <th style="padding:12px 16px;color:#8c1f4c;font-size:15px;font-weight:700;">Last Updated</th>
            <th style="padding:12px 16px;color:#8c1f4c;font-size:15px;font-weight:700;">PDF</th>
            <th style="padding:12px 16px;color:#8c1f4c;font-size:15px;font-weight:700;">Actions</th>
          </tr>
        </thead>
        <tbody id="appsBody">
          <!-- Table rows will be rendered by JS -->
        </tbody>
      </table>
      <div id="viewModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:1000;align-items:center;justify-content:center;">
        <div style="background:#fff;border-radius:10px;max-width:1100px;width:90vw;box-shadow:0 12px 40px rgba(0,0,0,.25);overflow:auto;max-height:90vh;position:relative;">
          <button id="closeViewModal" style="position:absolute;top:18px;right:18px;background:#d7336f;color:#fff;border:none;border-radius:5px;padding:8px 16px;font-weight:bold;cursor:pointer;">Close</button>
          <div id="viewModalContent" style="padding:40px 32px 32px 32px;"></div>
        </div>
      </div>
    </div>
  </main>

  <footer>
    &copy; 2025 WCW Awards Platform. All rights reserved.
  </footer>

  <!-- Firebase SDKs -->
  <script src="/__/firebase/12.0.0/firebase-app-compat.js"></script>
  <script src="/__/firebase/12.0.0/firebase-auth-compat.js"></script>
  <script src="/__/firebase/12.0.0/firebase-firestore-compat.js"></script>
  <script src="/__/firebase/init.js?useEmulator=true"></script>
  <script>
// Helper function to escape HTML
function esc(str) {
  return String(str || '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

// Replace the hardcoded CRITERIA_DEFS with this dynamic version
let CRITERIA_DEFS = []; // Start empty, will be populated from Firestore

// Function to load criteria from Firestore
async function loadCriteriaDefinitions() {
  try {
    const db = firebase.firestore();
    
    // Load questions from applicationInfo collection
    const snapshot = await db.collection('applicationInfo')
      .where('Question', '!=', null) // Only docs with Question field
      .get();
    
    if (snapshot.empty) {
      console.warn('No questions found in applicationInfo collection');
      // Use hardcoded fallback
      CRITERIA_DEFS = [
        { key: 'Tell_us_about_yourself', title: 'Tell us about yourself' },
        { key: 'Tell_us_about_your_work', title: 'Tell us about your work' },
        { key: 'What_inspired_you', title: 'What inspired you to do this work?' },
        { key: 'What_makes_you_special_unique', title: 'What makes what you do special or unique?' },
        { key: 'greatest_challenge', title: 'What has been your greatest challenge & how have you addressed this' },
        { key: 'top_greatest_achievements', title: 'What have been your top 3 greatest achievements in the past 12 months' },
        { key: 'achievements_significant', title: 'Why were these achievements significant and what do you attribute your achievements to' },
        { key: 'big_picture_vision', title: 'What is your big picture vision for the work you are doing' },
        { key: 'recognised_in_this_category', title: 'Why should you be recognised in this category' }
      ];
      return;
    }

    // Convert Firestore docs to CRITERIA_DEFS format
    const questions = [];
    snapshot.forEach(doc => {
      const data = doc.data();
      
      // Skip documents that don't have proper question structure
      if (!data.Question || !data.question_ID) return;
      
      const question = {
        key: data.question_ID, // Use question_ID as the key for matching responses
        title: data.Question, // Use Question as the display title
        docId: doc.id, // Store document ID for reference
        wordLimit: data.wordLimit || null
      };
      
      // Extract order from Season2025 field (e.g., "Q1" -> 1)
      const seasonOrder = data.Season2025 || data.season2025;
      if (seasonOrder) {
        const orderMatch = String(seasonOrder).match(/Q?(\d+)/i);
        question.order = orderMatch ? parseInt(orderMatch[1]) : 999;
      } else {
        question.order = 999; // No order specified
      }
      
      questions.push(question);
    });

    // Sort by order field
    questions.sort((a, b) => a.order - b.order);
    
    CRITERIA_DEFS = questions;
    console.log(`Loaded ${CRITERIA_DEFS.length} criteria from applicationInfo:`, CRITERIA_DEFS);
    
  } catch (err) {
    console.error('Error loading criteria definitions:', err);
    // Use hardcoded fallback on error
    CRITERIA_DEFS = [
      { key: 'Tell_us_about_yourself', title: 'Tell us about yourself' },
      { key: 'Tell_us_about_your_work', title: 'Tell us about your work' },
      { key: 'What_inspired_you', title: 'What inspired you to do this work?' },
      { key: 'What_makes_you_special_unique', title: 'What makes what you do special or unique?' },
      { key: 'greatest_challenge', title: 'What has been your greatest challenge & how have you addressed this' },
      { key: 'top_greatest_achievements', title: 'What have been your top 3 greatest achievements in the past 12 months' },
      { key: 'achievements_significant', title: 'Why were these achievements significant and what do you attribute your achievements to' },
      { key: 'big_picture_vision', title: 'What is your big picture vision for the work you are doing' },
      { key: 'recognised_in_this_category', title: 'Why should you be recognised in this category' }
    ];
  }
}

// Update the exportAppPdf function to ensure criteria are loaded
async function exportAppPdf(id) {
  try {
    // Ensure criteria are loaded before generating PDF
    if (CRITERIA_DEFS.length === 0) {
      await loadCriteriaDefinitions();
    }
    
    const db = firebase.firestore();
    const user = firebase.auth().currentUser;
    if (!user) {
      alert("Please log in first.");
      return;
    }

    // Get application data
    let appData = {};
    try {
      const appDoc = await db.collection('applications').doc(id).get();
      if (appDoc.exists) {
        appData = appDoc.data();
        console.log('Loaded application data:', appData);
      }
    } catch (err) {
      console.warn('Could not read application directly:', err);
      // Try judgeAssignments fallback if needed
      try {
        const assignDoc = await db.collection('judgeAssignments')
          .doc(`${user.uid}_${id}`)
          .get();
        if (assignDoc.exists) {
          const assignData = assignDoc.data();
          appData = {
            name: assignData.entryName || assignData.name || '-',
            category: assignData.category || '-',
            subcategory: assignData.subcategory || '-',
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
            // Add other fields as needed
            tell_us_about_yourself: assignData.tell_us_about_yourself || '-',
            tell_us_about_your_work: assignData.tell_us_about_your_work || '-',
            what_inspired_you: assignData.what_inspired_you || '-',
            what_makes_you_unique: assignData.what_makes_you_unique || '-',
            Greatest_challenge: assignData.Greatest_challenge || '-',
            Top_achievements: assignData.Top_achievements || '-',
=======
=======
>>>>>>> afbeb186fe086fb684e125a10a83dc1ce0565219
=======
>>>>>>> afbeb186fe086fb684e125a10a83dc1ce0565219
            // Add the correct field names based on your Firebase structure
            Tell_us_about_yourself: assignData.Tell_us_about_yourself || '-',
            Tell_us_about_your_work: assignData.Tell_us_about_your_work || '-',
            What_inspired_you: assignData.What_inspired_you || '-',
            What_makes_you_special_unique: assignData.What_makes_you_special_unique || '-',
            greatest_challenge: assignData.greatest_challenge || '-',
            top_greatest_achievements: assignData.top_greatest_achievements || '-',
<<<<<<< HEAD
<<<<<<< HEAD
>>>>>>> afbeb186fe086fb684e125a10a83dc1ce0565219
=======
>>>>>>> afbeb186fe086fb684e125a10a83dc1ce0565219
=======
>>>>>>> afbeb186fe086fb684e125a10a83dc1ce0565219
            achievements_significant: assignData.achievements_significant || '-',
            big_picture_vision: assignData.big_picture_vision || '-',
            recognised_in_this_category: assignData.recognised_in_this_category || '-'
          };
        }
      } catch (err2) {
        console.warn('Could not read judge assignment:', err2);
      }
    }

    // Get judge scores and comments
    let judgeScores = {};
    try {
      const judgeDoc = await db.collection('judgeResponses').doc(`${user.uid}_${id}`).get();
      if (judgeDoc.exists && judgeDoc.data().scores) {
        judgeScores = judgeDoc.data().scores;
        console.log('Loaded judge scores:', judgeScores);
      }
    } catch (err) {
      console.warn('Could not load judge scores:', err);
    }

    if (!appData.name || appData.name === '-') {
      alert("Could not load application data for PDF export.");
      return;
    }

    const win = window.open('', '_blank');
    if (!win) { 
      alert('Please allow popups to view the PDF.'); 
      return; 
    }

    // Create the criteria HTML with actual scores and comments
    const criteriaHtml = CRITERIA_DEFS.map(c => {
      const value = appData[c.key] || '-';
      const judgeData = judgeScores[c.key] || {};
      const score = judgeData.score || '';
      const comment = judgeData.comment || '';
      
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
=======
      console.log(`Field ${c.key}:`, value, 'Score:', score, 'Comment:', comment); // Debug log
      
>>>>>>> afbeb186fe086fb684e125a10a83dc1ce0565219
=======
      console.log(`Field ${c.key}:`, value, 'Score:', score, 'Comment:', comment); // Debug log
      
>>>>>>> afbeb186fe086fb684e125a10a83dc1ce0565219
=======
      console.log(`Field ${c.key}:`, value, 'Score:', score, 'Comment:', comment); // Debug log
      
>>>>>>> afbeb186fe086fb684e125a10a83dc1ce0565219
      return `
        <div class="criteria-row">
          <div class="card">
            <h2>${esc(c.title)}</h2>
            <div class="field">${esc(value)}</div>
            <div class="criterion">
              <div class="score-box">
                <div style="font-size:13px;">Judging</div>
                <div class="score-input">${score ? esc(score) : '____'} / 10</div>
              </div>
              <div class="comment-area">
                <div style="font-size:13px;color:#666;margin-bottom:6px;">Comments</div>
                <div class="comment-box">${comment ? esc(comment) : ''}</div>
              </div>
            </div>
          </div>
        </div>
      `;
    }).join('');

<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
    // Write the HTML with updated styles for displaying scores/comments
=======
    // Write the complete HTML document
>>>>>>> afbeb186fe086fb684e125a10a83dc1ce0565219
=======
    // Write the complete HTML document
>>>>>>> afbeb186fe086fb684e125a10a83dc1ce0565219
=======
    // Write the complete HTML document
>>>>>>> afbeb186fe086fb684e125a10a83dc1ce0565219
    win.document.write(`
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="utf-8">
        <title>Application Review - ${esc(id)}</title>
        <style>
          @page { margin: 2cm; }
          body {
            margin: 0;
            font-family: Arial, sans-serif;
            color: #333;
            background: #fff;
          }
          .header {
            margin-bottom: 20px;
            border-bottom: 2px solid #d7336f;
            padding-bottom: 10px;
          }
          .content { padding: 0 20px; }
          .criteria-row {
            margin-bottom: 30px;
            page-break-inside: avoid;
          }
          .card {
            background: #fff;
            padding: 18px;
            border-radius: 8px;
            box-shadow: 0 4px 14px rgba(0,0,0,0.04);
            margin-bottom: 18px;
          }
          h2 {
            margin: 0 0 12px 0;
            color: #333;
            font-weight: 600;
            font-size: 18px;
          }
          .field {
            background: #fff;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #f0f0f0;
            color: #333;
            margin-bottom: 12px;
            white-space: pre-wrap;
            line-height: 1.45;
          }
          .criterion {
            margin: 0;
            display: flex;
            gap: 16px;
            align-items: flex-start;
            border: 1px solid #eee;
            padding: 16px;
            border-radius: 6px;
            background: #fff;
            margin-top: 15px;
          }
          .score-box {
            background: #6e1742;
            color: #fff;
            padding: 12px;
            border-radius: 6px;
            width: 120px;
            text-align: center;
            font-weight: 700;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
          }
          .score-input {
            background: white;
            color: #333;
            padding: 6px 8px;
            border-radius: 4px;
            width: 100%;
            text-align: center;
            font-weight: bold;
          }
          .comment-area {
            flex: 1;
            margin-right: 16px;
            max-width: calc(100% - 140px);
          }
          .comment-box {
            width: 100%;
            min-height: 100px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 8px;
            box-sizing: border-box;
            background: #fff;
            white-space: pre-wrap;
            line-height: 1.4;
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
=======
            color: #333;
>>>>>>> afbeb186fe086fb684e125a10a83dc1ce0565219
=======
            color: #333;
>>>>>>> afbeb186fe086fb684e125a10a83dc1ce0565219
=======
            color: #333;
>>>>>>> afbeb186fe086fb684e125a10a83dc1ce0565219
          }
          footer {
            margin-top: 30px;
            text-align: center;
            font-size: 12px;
            color: #666;
          }
        </style>
      </head>
      <body>
        <div class="header">
          <h1 style="margin:0;color:#d7336f;">WCW Awards - Application Review</h1>
          <div style="color:#666;margin-top:5px;">Application ID: ${esc(id)}</div>
        </div>
        
        <div class="content">
          <div class="card">
            <h2>Applicant Details</h2>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
              <div>
                <div style="color:#666;font-size:14px;">Category</div>
                <div class="field">${esc(appData.category || '-')}</div>
              </div>
              <div>
                <div style="color:#666;font-size:14px;">Subcategory</div>
                <div class="field">${esc(appData.subcategory || '-')}</div>
              </div>
              <div>
                <div style="color:#666;font-size:14px;">Name</div>
                <div class="field">${esc(appData.name || '-')}</div>
              </div>
            </div>
          </div>

          ${criteriaHtml}
        </div>

        <footer>
          Â© ${new Date().getFullYear()} WCW Awards Platform
        </footer>
      </body>
      </html>
    `);

    win.document.close();
    win.focus();
    
    setTimeout(() => {
      win.print();
    }, 1000);

  } catch (err) {
    console.error('PDF generation failed:', err);
    alert('Failed to generate PDF preview: ' + err.message);
  }
}

document.addEventListener('DOMContentLoaded', async function() {
  // Load criteria definitions first
  await loadCriteriaDefinitions();
  
  const tableBody = document.getElementById('appsBody');
  let rows = [];
  let currentSort = 'none';
  let filteredRows = [];

  function renderTable(displayRows) {
    tableBody.innerHTML = '';
    if (!displayRows.length) {
      tableBody.innerHTML = '<tr><td colspan="8">No assigned applications found.</td></tr>';
      return;
    }
    for (const row of displayRows) {
      tableBody.innerHTML += `
        <tr>
          <td>${row.applicationId}</td>
          <td>${row.name}</td>
          <td>${row.category}</td>
          <td>${row.subcategory}</td>
          <td>${row.status}</td>
          <td>${row.lastUpdated}</td>
          <td>
            <button class="pdf-btn" title="Open printable preview" onclick="exportAppPdf('${row.applicationId}')">
              <span class="material-symbols-outlined pdf-icon" aria-hidden="true">picture_as_pdf</span>
            </button>
          </td>
          <td>
            <button class="logout-btn" onclick="window.location.href='judgeapplicationview.html?id=${row.applicationId}'">View</button>
          </td>
        </tr>
      `;
    }

    localStorage.setItem('judgeFilteredAppIds', JSON.stringify(filteredRows.map(r => r.applicationId)));
    const orderedAppIds = filteredRows.map(row => row.applicationId);
    localStorage.setItem('judgeOrderedAppIds', JSON.stringify(orderedAppIds));
  }

  // Add this new function to handle both sorting and filtering
// Add this new function to handle both sorting and filtering
function applyCurrentSortAndFilter() {
  // First apply filters
  filteredRows = rows.filter(row => {
    const catOk = !FILTERS.category || row.category === FILTERS.category;
    const subOk = !FILTERS.subcategory || row.subcategory === FILTERS.subcategory;
    const nameOk = !FILTERS.name || row.name === FILTERS.name;
    const statusOk = FILTERS.status.size === 0 || FILTERS.status.has(row.status);
    return catOk && subOk && nameOk && statusOk;
  });

  // Then apply current sort
  if (currentSort === 'asc') {
    filteredRows.sort((a, b) => String(a.applicationId).localeCompare(String(b.applicationId)));
  } else if (currentSort === 'desc') {
    filteredRows.sort((a, b) => String(b.applicationId).localeCompare(String(a.applicationId)));
  } else if (currentSort === 'updated_desc') {
    // **FIX: Sort by newest first (most recent at top)**
    filteredRows.sort((a, b) => {
      // Use the original timestamp data, not the formatted string
      const timeA = a.originalTimestamp || new Date(a.lastUpdated).getTime() || 0;
      const timeB = b.originalTimestamp || new Date(b.lastUpdated).getTime() || 0;
      return timeB - timeA; // Newest first (higher timestamp first)
    });
  } else if (currentSort === 'updated_asc') {
    // **FIX: Sort by oldest first (earliest at top)**
    filteredRows.sort((a, b) => {
      // Use the original timestamp data, not the formatted string
      const timeA = a.originalTimestamp || new Date(a.lastUpdated).getTime() || 0;
      const timeB = b.originalTimestamp || new Date(b.lastUpdated).getTime() || 0;
      return timeA - timeB; // Oldest first (lower timestamp first)
    });
  }

  renderTable(filteredRows);
}
  
  const sortBtn = document.getElementById('sortBtn');
  const sortList = document.getElementById('sortList');

  sortBtn.onclick = () => sortList.classList.toggle('open');

  sortList.onclick = (e) => {
    if (e.target.tagName === 'BUTTON') {
      const sortMode = e.target.dataset.sort;
      currentSort = sortMode; // Store current sort mode
      
      sortBtn.textContent = 'SORT BY: ' + (
        sortMode === 'asc' ? 'Application ID Ascending' :
        sortMode === 'desc' ? 'Application ID Descending' :
        sortMode === 'updated_desc' ? 'Updated (Newest first)' :
        sortMode === 'updated_asc' ? 'Updated (Oldest first)' :
        '-select-'
      );
      sortList.classList.remove('open');
      
      // Apply sorting to current filtered rows
      applyCurrentSortAndFilter();
    }
  };

  // Filter state and handlers
  const FILTERS = {
    category: '',
    subcategory: '',
    name: '',
    status: new Set()
  };

  // Filter modal controls
  const fModal = document.getElementById('filterModal');
  const fOpen = document.getElementById('openFilter');
  const fClose = document.getElementById('filterClose');
  const fApply = document.getElementById('filterApply');
  const fClear = document.getElementById('filterClear');

  function buildFilterUI() {
    // Get unique values
    const names = [...new Set(rows.map(r => r.name).filter(Boolean))].sort();
    const categories = [...new Set(rows.map(r => r.category).filter(Boolean))].sort();
    const subcategories = [...new Set(rows.map(r => r.subcategory).filter(Boolean))].sort();
    
    // Build dropdowns
    const nameSelect = document.getElementById('flt_names');
    const catSelect = document.getElementById('flt_categories');
    const subcatSelect = document.getElementById('flt_subcategories');
    
    // Names dropdown
    nameSelect.innerHTML = '<option value="">All Names</option>' + 
      names.map(name => `<option value="${name}" ${FILTERS.name === name ? 'selected' : ''}>${name}</option>`).join('');
    
    // Categories dropdown
    catSelect.innerHTML = '<option value="">All Categories</option>' + 
      categories.map(cat => `<option value="${cat}" ${FILTERS.category === cat ? 'selected' : ''}>${cat}</option>`).join('');
    
    // Subcategories dropdown
    subcatSelect.innerHTML = '<option value="">All Subcategories</option>' + 
      subcategories.map(sub => `<option value="${sub}" ${FILTERS.subcategory === sub ? 'selected' : ''}>${sub}</option>`).join('');
    
    // Reset status checkboxes
    const statusChecks = document.querySelectorAll('#flt_status input[type="checkbox"]');
    statusChecks.forEach(checkbox => {
      checkbox.checked = FILTERS.status.has(checkbox.value);
    });

    // Wire up change handlers for dropdowns
    nameSelect.addEventListener('change', e => FILTERS.name = e.target.value);
    catSelect.addEventListener('change', e => FILTERS.category = e.target.value);
    subcatSelect.addEventListener('change', e => FILTERS.subcategory = e.target.value);
    
    // Wire up status checkboxes
    document.getElementById('flt_status').addEventListener('change', e => {
      if (e.target.type === 'checkbox') {
        if (e.target.checked) FILTERS.status.add(e.target.value);
        else FILTERS.status.delete(e.target.value);
      }
    });
  }

  // Wire up filter modal events
  if (fOpen) fOpen.addEventListener('click', () => {
    buildFilterUI();
    fModal.classList.add('open');
    fModal.setAttribute('aria-hidden', 'false');
  });

  if (fClose) fClose.addEventListener('click', () => {
    fModal.classList.remove('open');
    fModal.setAttribute('aria-hidden', 'true');
  });

  if (fModal) fModal.addEventListener('click', e => {
    if (e.target === fModal) {
      fModal.classList.remove('open');
      fModal.setAttribute('aria-hidden', 'true');
    }
  });

  if (fApply) fApply.addEventListener('click', () => {
    // Update the filter apply button handler
    applyCurrentSortAndFilter();
    fModal.classList.remove('open');
    fModal.setAttribute('aria-hidden', 'true');
  });

  // Update the clear filter handler
  if (fClear) fClear.addEventListener('click', () => {
    FILTERS.category = '';
    FILTERS.subcategory = '';
    FILTERS.name = '';
    FILTERS.status.clear();
    
    // Reset dropdowns
    document.getElementById('flt_names').value = '';
    document.getElementById('flt_categories').value = '';
    document.getElementById('flt_subcategories').value = '';
    
    // Reset checkboxes
    const statusChecks = document.querySelectorAll('#flt_status input[type="checkbox"]');
    statusChecks.forEach(checkbox => {
      checkbox.checked = false;
    });
    
    // Apply current sort to unfiltered rows
    applyCurrentSortAndFilter();
  });

  firebase.auth().onAuthStateChanged(async user => {
    if (!user) {
      tableBody.innerHTML = '<tr><td colspan="8">Please log in.</td></tr>';
      return;
    }

    // Populate header with signed-in user's first name (uses users/{uid}.fullName if available)
    try {
      const judgeNameEl = document.getElementById('judgeName');
      const headerUserNameEl = document.getElementById('headerUserName');
      const avatarBtn = document.querySelector('.profile-avatar');

      let display = user.displayName || user.email || 'Judge';
      try {
        const udoc = await firebase.firestore().collection('users').doc(user.uid).get();
        if (udoc.exists && udoc.data().fullName) display = udoc.data().fullName;
      } catch (e) {
        console.warn('users doc read failed', e);
      }

      const first = (display && display.split(' ')[0]) || 'Judge';
      const capFirst = first.charAt(0).toUpperCase() + first.slice(1);

      if (judgeNameEl) judgeNameEl.textContent = capFirst;
      if (headerUserNameEl) headerUserNameEl.textContent = capFirst;
      if (avatarBtn) avatarBtn.textContent = (capFirst[0] || 'J').toUpperCase();
    } catch (err) {
      console.warn('Header population failed', err);
    }

    const judgeId = user.uid;
    const db = firebase.firestore();

    try {
      const assignmentsSnap = await db.collection('judgeAssignments')
        .where('judgeId', '==', judgeId)
        .get();

      if (assignmentsSnap.empty) {
        tableBody.innerHTML = '<tr><td colspan="8">No assigned applications found.</td></tr>';
        return;
      }

      rows = [];
      for (const doc of assignmentsSnap.docs) {
        const assign = doc.data();
        const appId = assign.applicationId;
        
        // Try to read full application doc; if forbidden, fall back to assignment summary fields
        let appData = {};
        let isWithdrawn = false; // Track withdrawal status
        
        if (appId) {
          try {
            const appDoc = await db.collection('applications').doc(appId).get();
            if (appDoc.exists) {
              appData = appDoc.data();
              
              // Check if application is withdrawn
              if (appData.stage === "withdrawn" || appData.stage === "Withdrawn") {
                isWithdrawn = true;
              }
            } else {
              // app missing â€” use assignment summary if present
              appData = {
                name: assign.entryName || '-',
                category: assign.category || '-',
                subcategory: assign.subcategory || '-'
              };
              
              // Check assignment for withdrawal status as fallback
              if (assign.stage === "withdrawn" || assign.stage === "Withdrawn") {
                isWithdrawn = true;
              }
            }
          } catch (readErr) {
            // permission-denied or other read error: fallback to assignment fields
            console.warn('Could not read application', appId, readErr);
            appData = {
              name: assign.entryName || '-',
              category: assign.category || assign.cat || '-',
              subcategory: assign.subcategory || assign.subCat || '-'
            };
            
            // Check assignment for withdrawal status as fallback
            if (assign.stage === "withdrawn" || assign.stage === "Withdrawn") {
              isWithdrawn = true;
            }
          }
        }

        // Skip withdrawn applications
        if (isWithdrawn) {
          console.log(`Skipping withdrawn application: ${appId}`);
          continue; // Skip this iteration, don't add to rows
        }

        // Fetch judgeResponses status
        let judgeStatus = "new";
        try {
          const judgeRespDoc = await db.collection('judgeResponses').doc(judgeId + '_' + appId).get();
          if (judgeRespDoc.exists && judgeRespDoc.data().status) {
            judgeStatus = judgeRespDoc.data().status;
          }
        } catch (e) {
          // ignore, fallback to "new"
        }

        // Construct PDF URL (safe, do NOT attempt to read non-existent pdfUploads collection)
        // Prefer (in order): assignment.pdfUrl, application doc fields (appData.pdfUrl / pdfURL / pdf), otherwise empty.
        let pdfUrl = '';
        if (assign && assign.pdfUrl) {
          pdfUrl = assign.pdfUrl;
        } else if (appData) {
          pdfUrl = appData.pdfUrl || appData.pdfURL || appData.pdf || '';
        } else {
          pdfUrl = '';
        }

        // **IMPROVED: Store both formatted string and original timestamp**
        const originalTimestamp = assign.updatedAt ? assign.updatedAt.seconds * 1000 : 0;
        const formattedTime = assign.updatedAt ? new Date(originalTimestamp).toLocaleString() : '-';

        rows.push({
          applicationId: appId || '-',
          name: appData.name || assign.entryName || '-',
          category: appData.category || '-',
          subcategory: appData.subcategory || '-',
          status: judgeStatus,
          lastUpdated: formattedTime, // Display formatted time
          originalTimestamp: originalTimestamp, // Store original timestamp for sorting
          pdfUrl: pdfUrl
        });
      }
      
      // Initialize filteredRows and apply current sort and filter
      filteredRows = rows;
      applyCurrentSortAndFilter();
      
    } catch (err) {
      console.error(err);
      tableBody.innerHTML = '<tr><td colspan="8">Error loading assignments.</td></tr>';
    }
  });

}); 

// Move the dropdown script OUTSIDE the DOMContentLoaded function
(function(){
  const avatar = document.getElementById('avatarBtn');
  const dropdown = document.getElementById('profileDropdown');

  function closeAll() {
    if(dropdown) { dropdown.classList.remove('open'); dropdown.setAttribute('aria-hidden','true'); }
    if(avatar) avatar.setAttribute('aria-expanded','false');
  }

  document.addEventListener('click', (e) => {
    const root = document.getElementById('profileMenuRoot');
    if (!root) return;
    if (root.contains(e.target)) {
      // clicked inside menu root
      if (e.target.id === 'avatarBtn' || e.target.closest('#avatarBtn')) {
        const isOpen = dropdown.classList.toggle('open');
        dropdown.setAttribute('aria-hidden', (!isOpen).toString());
        if (avatar) avatar.setAttribute('aria-expanded', String(isOpen));
      }
      return;
    }
    // clicked outside - close it
    closeAll();
  });

  // wire logout inside dropdown
  document.addEventListener('click', (e) => {
    if (e.target && (e.target.id === 'headerLogoutBtn' || e.target.closest('#headerLogoutBtn'))) {
      e.preventDefault();
      firebase.auth().signOut().then(()=> {
        window.location.href = 'signin.html';
      }).catch(()=> { window.location.href = 'signin.html'; });
    }
  });

  // ensure closed on load
  document.addEventListener('DOMContentLoaded', () => {
    if (dropdown) { dropdown.classList.remove('open'); dropdown.setAttribute('aria-hidden','true'); }
    if (avatar) avatar.setAttribute('aria-expanded','false');
  });
})();
  </script>
</body>
</html>