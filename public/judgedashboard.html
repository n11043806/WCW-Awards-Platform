<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Judge Dashboard - WCW Awards</title>

  <style>
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background-color: #f4f4f4;
    color: #333;
  }

  header {
    background-color: #d7336f;
    color: white;
    padding: 20px 30px;
    display: flex;
    align-items: center;
    /* Flush header content to the left */
    justify-content: flex-start;
  }

  header h1 {
    margin: 0;
    font-size: 24px;
    font-weight: bold;
    letter-spacing: 0.5px;
  }

  .logout-btn {
    background-color: white;
    color: #d7336f;
    padding: 8px 16px;
    border: none;
    border-radius: 5px;
    font-weight: bold;
    cursor: pointer;
    margin-left: auto;
  }

  .logout-btn:hover {
    background-color: #ffe6ee;
  }

  main {
    padding: 40px 30px;
  }

  .dashboard-section {
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 15px rgba(0,0,0,0.1);
    max-width: 1100px;
    margin: 30px auto;
  }

  .dashboard-section h2 {
    color: #d7336f;
    margin-bottom: 20px;
    text-align: left;
  }

  .dashboard-section p {
    font-size: 16px;
    margin-bottom: 20px;
  }

  .dashboard-section button {
    padding: 12px 20px;
    background-color: #d7336f;
    color: white;
    border: none;
    border-radius: 5px;
    font-size: 16px;
    cursor: pointer;
  }

  .dashboard-section button:hover {
    background-color: #b8235a;
  }

  table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 10px;
    margin-top: 10px;
  }

  thead tr {
    background: #faf0f4;
  }

  th, td {
    padding: 12px 16px;
    text-align: left;
    font-size: 15px;
  }

  th {
    color: #8c1f4c;
    font-weight: 700;
  }

  tbody tr {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(215,51,111,0.04);
  }

  tbody tr td {
    border-top: 1px solid #f4f4f4;
    border-bottom: 1px solid #f4f4f4;
  }

  .list-header {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 10px;
    margin-bottom: 18px;
  }

  .list-header label {
    font-weight: 700;
    color: #d7336f;
    font-size: 1.1em;
    margin-bottom: 6px;
  }

  .list-header select {
    padding: 10px 16px;
    border-radius: 6px;
    border: 1px solid #d7336f;
    font-size: 1em;
    background: #fff;
    color: #d7336f;
    min-width: 220px;
  }

  footer {
    text-align: center;
    margin-top: 60px;
    font-size: 14px;
    color: #888;
  }

  .pdf-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
  }

  .profile-btn {
    background-color: #d7336f;
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 10px 24px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    margin-right: 10px;
  }

  .profile-btn:hover {
    background-color: #b8235a;
  }

  /* Dropdown styled to match judgeprofile (pale pink card, maroon accents) */
.profile-menu { position: relative; display: inline-block; }
.profile-avatar {
  background: #b84b7a; /* darker maroon circle */
  color: #fff;
  border: 3px solid rgba(255,255,255,0.12);
  width: 40px;
  height: 40px;
  border-radius: 50%;
  font-weight:700;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  box-shadow: 0 2px 0 rgba(0,0,0,0.06) inset;
}
.profile-dropdown {
  display: none;
  position: absolute;
  top: 52px;
  right: 0;
  min-width: 170px;
  background: #ffeef3; /* pale pink */
  border: 1px solid #b84b7a; /* maroon border */
  border-radius: 10px;
  box-shadow: 0 8px 20px rgba(184,75,122,0.12);
  padding: 6px 0;
  z-index: 200;
}
.profile-dropdown.open { display: block; }
.profile-dropdown button {
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  width:100%;
  padding:10px 14px;
  background:transparent;
  border:0;
  color:#b84b7a;
  font-weight:600;
  cursor:pointer;
  font-size:14px;
}
.profile-dropdown button .icon { opacity:0.95; font-size:16px; }
.profile-dropdown button:hover { background:#ffe0ef; }

  .profile-menu {
    position: relative;
    display: inline-block;
  }

  .profile-avatar {
    background: #b8235a;
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 38px;
    height: 38px;
    font-size: 1.2em;
    font-weight: bold;
    cursor: pointer;
  }

  .profile-dropdown {
    position: absolute;
    top: 45px;
    right: 0;
    background: #ffe6ee;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    min-width: 160px;
    z-index: 100;
    padding: 8px 0;
  }

  .profile-dropdown button {
    background: none;
    border: none;
    width: 100%;
    text-align: left;
    padding: 10px 18px;
    color: #d7336f;
    font-size: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .profile-dropdown button:hover {
    background: #ffd6e6;
  }

  .back-btn {
    background: #fff;
    color: #d7336f;
    border: none;
    border-radius: 6px;
    padding: 10px 24px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
  }

  .back-btn:hover {
    background-color: #b8235a;
  }
  </style>
</head>

<body>
  <header>
    <h1>Welcome, <span id="judgeName">Judge</span></h1>
    <div style="display:flex;align-items:center;justify-content:flex-end;gap:10px;position:absolute;top:20px;right:30px;">
      <!-- user's first name will be placed here (replaces logout button position) -->
      <span id="headerUserName" style="font-weight:bold;color:#fff;margin-right:8px;"></span>
      <div class="profile-menu" id="profileMenuRoot">
  <button id="avatarBtn" class="profile-avatar" aria-haspopup="true" aria-expanded="false">A</button>

  <div id="profileDropdown" class="profile-dropdown" aria-hidden="true">
    <button type="button" onclick="window.location.href='judgeprofile.html'">
      <span>Profile</span>
      <span class="pd-icon" aria-hidden="true">üë§</span>
    </button>
    <button type="button" onclick="window.location.href='mailto:support@wcw.com'">
      <span>Get help</span>
      <span class="pd-icon" aria-hidden="true">‚ùì</span>
    </button>
    <button id="headerLogoutBtn" type="button">
      <span>Log out</span>
      <span class="pd-icon" aria-hidden="true">‚§¥</span>
    </button>
  </div>
</div>
      <!-- logout removed as requested -->
    </div>
  </header>

  <main>
    <div class="dashboard-section" style="max-width:1100px;">
  <h2 style="color:#d7336f;margin-bottom:0.5em;">Judging information</h2>
      <div style="background:#ffe6ee;padding:18px 24px;border-radius:8px;margin-bottom:30px;">
        <b>Some tips to help you get started:</b>
        <ol style="margin-top:10px;">
          <li>Clicking on the entry name will take you into the entry view.</li>
          <li>When you click into an entry, you will see all the details entered by the entrant on the left side of the page. On the right side, is where you put in your score and comments.</li>
          <li>If you wish to abstain from judging for any reason, check the box on top on the right side and you can skip scoring that entry.</li>
          <li>The <i>Comments</i> box can be seen by organisers and may be used publicly.</li>
          <li>Once you have scored all criteria, hit 'Save & next' to move to the next entry.</li>
          <li>The status 'to be scored' refers to an entry that is yet to be scored.</li>
          <li>The status 'in progress' refers to an entry that hasn't had all the criteria scored yet (but has commenced).</li>
          <li>The status 'complete' refers to an entry that has had all criteria scored and is therefore completed.</li>
          <li>You can also view/download a PDF for each entry for offline use.</li>
        </ol>
      </div>
      <!-- Place this above your table in the dashboard -->
<div style="margin-bottom:18px;">
  <label for="categoryFilter" style="font-weight:bold;font-size:16px;color:#d7336f;">Browse by category</label>
  <select id="categoryFilter" style="margin-left:12px;padding:10px 16px;border-radius:6px;border:1px solid #d7336f;font-size:1em;background:#fff;color:#d7336f;min-width:220px;">
    <option value="">(All Categories)</option>
    <option value="IMPACT AWARDS">IMPACT AWARDS</option>
    <option value="INDUSTRY AWARDS">INDUSTRY AWARDS</option>
    <option value="LEADERSHIP AWARDS">LEADERSHIP AWARDS</option>
    <!-- Add more categories as needed -->
  </select>
</div>
      <div class="list-header" style="display:flex;align-items:center;justify-content:flex-end;gap:10px;margin-bottom:18px;">
        <div style="display:flex;flex-direction:column;align-items:flex-end;width:100%;">
          <label style="font-weight:700;color:#d7336f;font-size:1.1em;margin-bottom:6px;">Sort/Filter By</label>
          <select id="sortDropdown" style="padding:10px 16px;border-radius:6px;border:1px solid #d7336f;font-size:1em;background:#fff;color:#d7336f;min-width:220px;">
            <option value="">(Clear All)</option>
            <option value="category_asc">Category (Ascending)</option>
            <option value="category_desc">Category (Descending)</option>
            <option value="status_new">Status (New)</option>
            <option value="status_saved">Status (Saved)</option>
            <option value="status_submitted">Status (Submitted)</option>
          </select>
        </div>
      </div>
      <table style="width:100%;border-collapse:separate;border-spacing:0 10px;">
        <thead>
          <tr style="background:#faf0f4;">
            <th style="padding:12px 16px;color:#8c1f4c;font-size:15px;font-weight:700;">Application ID</th>
            <th style="padding:12px 16px;color:#8c1f4c;font-size:15px;font-weight:700;">Name</th>
            <th style="padding:12px 16px;color:#8c1f4c;font-size:15px;font-weight:700;">Category</th>
            <th style="padding:12px 16px;color:#8c1f4c;font-size:15px;font-weight:700;">Subcategory</th>
            <th style="padding:12px 16px;color:#8c1f4c;font-size:15px;font-weight:700;">Status</th>
            <th style="padding:12px 16px;color:#8c1f4c;font-size:15px;font-weight:700;">Last Updated</th>
            <th style="padding:12px 16px;color:#8c1f4c;font-size:15px;font-weight:700;">PDF</th>
            <th style="padding:12px 16px;color:#8c1f4c;font-size:15px;font-weight:700;">Actions</th>
          </tr>
        </thead>
        <tbody id="appsBody">
          <!-- Table rows will be rendered by JS -->
        </tbody>
      </table>
      <div id="viewModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:1000;align-items:center;justify-content:center;">
        <div style="background:#fff;border-radius:10px;max-width:1100px;width:90vw;box-shadow:0 12px 40px rgba(0,0,0,.25);overflow:auto;max-height:90vh;position:relative;">
          <button id="closeViewModal" style="position:absolute;top:18px;right:18px;background:#d7336f;color:#fff;border:none;border-radius:5px;padding:8px 16px;font-weight:bold;cursor:pointer;">Close</button>
          <div id="viewModalContent" style="padding:40px 32px 32px 32px;"></div>
        </div>
      </div>
    </div>
  </main>

  <footer>
    &copy; 2025 WCW Awards Platform. All rights reserved.
  </footer>

  <!-- Firebase SDKs -->
  <script src="/__/firebase/12.0.0/firebase-app-compat.js"></script>
  <script src="/__/firebase/12.0.0/firebase-auth-compat.js"></script>
  <script src="/__/firebase/12.0.0/firebase-firestore-compat.js"></script>
  <script src="/__/firebase/init.js?useEmulator=true"></script>
  <script>
document.addEventListener('DOMContentLoaded', function() {
  const tableBody = document.getElementById('appsBody');
  const sortDropdown = document.getElementById('sortDropdown');
  const categoryFilter = document.getElementById('categoryFilter');
  let rows = [];

  function updateCategoryFilterOptions(rows) {
    const categoryFilter = document.getElementById('categoryFilter');
    // Get unique categories from current rows
    const categories = Array.from(new Set(rows.map(r => r.category).filter(c => c && c !== '-')));
    // Clear existing options
    categoryFilter.innerHTML = '';
    // Add "(All Categories)" option
    categoryFilter.innerHTML += `<option value="">(All Categories)</option>`;
    // Add dynamic category options
    categories.forEach(cat => {
      categoryFilter.innerHTML += `<option value="${cat}">${cat}</option>`;
    });
    // Restore previous selection if possible
    if (categoryFilter._lastValue) categoryFilter.value = categoryFilter._lastValue;
  }

  function renderTable(filteredRows) {
    tableBody.innerHTML = '';
    if (!filteredRows.length) {
      tableBody.innerHTML = '<tr><td colspan="8">No assigned applications found.</td></tr>';
      updateCategoryFilterOptions(rows); // Always use full rows for filter options
      return;
    }
    for (const row of filteredRows) {
      tableBody.innerHTML += `
        <tr>
          <td>${row.applicationId}</td>
          <td>${row.name}</td>
          <td>${row.category}</td>
          <td>${row.subcategory}</td>
          <td>${row.status}</td>
          <td>${row.lastUpdated}</td>
          <td>
            <a href="judgepdfview.html?id=${row.applicationId}" target="_blank" title="Download PDF">
              <img src="images/32px_PDF_file.png" alt="PDF" style="width:28px;height:28px;vertical-align:middle;border:none;background:none;">
            </a>
          </td>
          <td>
            <button class="logout-btn" onclick="window.location.href='judgeapplicationview.html?id=${row.applicationId}'">View</button>
          </td>
        </tr>
      `;
    }

    localStorage.setItem('judgeFilteredAppIds', JSON.stringify(filteredRows.map(r => r.applicationId)));
    const orderedAppIds = filteredRows.map(row => row.applicationId);
    localStorage.setItem('judgeOrderedAppIds', JSON.stringify(orderedAppIds));

    // Always update category filter options using all rows
    updateCategoryFilterOptions(rows);
  }

  sortDropdown.addEventListener('change', function() {
    let filtered = [...rows];
    const val = sortDropdown.value;
    if (val === "category_asc") {
      filtered.sort((a, b) => (a.category || '').localeCompare(b.category || ''));
    } else if (val === "category_desc") {
      filtered.sort((a, b) => (b.category || '').localeCompare(a.category || ''));
    } else if (val === "status_new") {
      filtered = filtered.filter(r => r.status === "new");
    } else if (val === "status_saved") {
      filtered = filtered.filter(r => r.status === "saved");
    } else if (val === "status_submitted") {
      filtered = filtered.filter(r => r.status === "submitted");
    } else {
      localStorage.removeItem('judgeFilteredAppIds');
      localStorage.removeItem('judgeCurrentIndex');
    }
    renderTable(filtered);
  });

  document.getElementById('categoryFilter').addEventListener('change', function() {
    const selectedCategory = this.value;
    this._lastValue = selectedCategory; // Save selection for dynamic updates
    let filteredRows = rows;
    if (selectedCategory) {
      filteredRows = rows.filter(row => row.category === selectedCategory);
    }
    renderTable(filteredRows);
    localStorage.setItem('judgeOrderedAppIds', JSON.stringify(filteredRows.map(r => r.applicationId)));
  });

  firebase.auth().onAuthStateChanged(async user => {
    if (!user) {
      tableBody.innerHTML = '<tr><td colspan="8">Please log in.</td></tr>';
      return;
    }

    // Populate header with signed-in user's first name (uses users/{uid}.fullName if available)
    try {
      const judgeNameEl = document.getElementById('judgeName');
      const headerUserNameEl = document.getElementById('headerUserName');
      const avatarBtn = document.querySelector('.profile-avatar');

      let display = user.displayName || user.email || 'Judge';
      try {
        const udoc = await firebase.firestore().collection('users').doc(user.uid).get();
        if (udoc.exists && udoc.data().fullName) display = udoc.data().fullName;
      } catch (e) {
        console.warn('users doc read failed', e);
      }

      const first = (display && display.split(' ')[0]) || 'Judge';
      const capFirst = first.charAt(0).toUpperCase() + first.slice(1);

      if (judgeNameEl) judgeNameEl.textContent = capFirst;
      if (headerUserNameEl) headerUserNameEl.textContent = capFirst;
      if (avatarBtn) avatarBtn.textContent = (capFirst[0] || 'J').toUpperCase();
    } catch (err) {
      console.warn('Header population failed', err);
    }

    const judgeId = user.uid;
    const db = firebase.firestore();

    try {
      const assignmentsSnap = await db.collection('judgeAssignments')
        .where('judgeId', '==', judgeId)
        .get();

      if (assignmentsSnap.empty) {
        tableBody.innerHTML = '<tr><td colspan="8">No assigned applications found.</td></tr>';
        return;
      }

      rows = [];
      for (const doc of assignmentsSnap.docs) {
        const assign = doc.data();
        const appId = assign.applicationId;
        // Try to read full application doc; if forbidden, fall back to assignment summary fields
        let appData = {};
        if (appId) {
          try {
            const appDoc = await db.collection('applications').doc(appId).get();
            if (appDoc.exists) {
              appData = appDoc.data();
            } else {
              // app missing ‚Äî use assignment summary if present
              appData = {
                name: assign.entryName || '-',
                category: assign.category || '-',
                subcategory: assign.subcategory || '-'
              };
            }
          } catch (readErr) {
            // permission-denied or other read error: fallback to assignment fields
            console.warn('Could not read application', appId, readErr);
            appData = {
              name: assign.entryName || '-',
              category: assign.category || assign.cat || '-',
              subcategory: assign.subcategory || assign.subCat || '-'
            };
          }
        }
 
        // Fetch judgeResponses status
        let judgeStatus = "new";
        try {
          const judgeRespDoc = await db.collection('judgeResponses').doc(judgeId + '_' + appId).get();
          if (judgeRespDoc.exists && judgeRespDoc.data().status) {
            judgeStatus = judgeRespDoc.data().status;
          }
        } catch (e) {
          // ignore, fallback to "new"
        }
 
        // Construct PDF URL
        let pdfUrl = '';
        try {
          const pdfDoc = await db.collection('pdfUploads').doc(appId).get();
          if (pdfDoc.exists) {
            pdfUrl = pdfDoc.data().url;
          } else if (assign.pdfUrl) {
            // fallback if admin stored pdf link on assignment
            pdfUrl = assign.pdfUrl;
          }
        } catch (e) {
          console.error('Error fetching PDF URL:', e);
          // fallback to assignment field if present
          pdfUrl = assign.pdfUrl || '';
        }
 
        rows.push({
          applicationId: appId || '-',
          name: appData.name || assign.entryName || '-',
          category: appData.category || '-',
          subcategory: appData.subcategory || '-',
          status: judgeStatus,
          lastUpdated: assign.updatedAt ? new Date(assign.updatedAt.seconds * 1000).toLocaleString() : '-',
          pdfUrl: pdfUrl
        });
      }
      renderTable(rows);
    } catch (err) {
      console.error(err);
      tableBody.innerHTML = '<tr><td colspan="8">Error loading assignments.</td></tr>';
    }
  });

  window.onView = function(applicationId) {
    const orderedAppIds = JSON.parse(localStorage.getItem('judgeOrderedAppIds') || '[]');
    const currentIndex = orderedAppIds.indexOf(applicationId);
    localStorage.setItem('judgeCurrentIndex', currentIndex);
    window.location.href = `judgeapplicationview.html?id=${applicationId}`;
  }
});
  </script>

  <script>
// dropdown toggle (idempotent, matches judgeprofile behaviour)
(function(){
  const avatar = document.getElementById('avatarBtn');
  const dropdown = document.getElementById('profileDropdown');

  function closeAll() {
    if(dropdown) { dropdown.classList.remove('open'); dropdown.setAttribute('aria-hidden','true'); }
    if(avatar) avatar.setAttribute('aria-expanded','false');
  }

  document.addEventListener('click', (e) => {
    const root = document.getElementById('profileMenuRoot');
    if (!root) return;
    if (root.contains(e.target)) {
      // clicked inside menu root
      if (e.target.id === 'avatarBtn' || e.target.closest('#avatarBtn')) {
        const isOpen = dropdown.classList.toggle('open');
        dropdown.setAttribute('aria-hidden', (!isOpen).toString());
        if (avatar) avatar.setAttribute('aria-expanded', String(isOpen));
      }
      return;
    }
    // clicked outside - close it
    closeAll();
  });

  // wire logout inside dropdown
  document.addEventListener('click', (e) => {
    if (e.target && (e.target.id === 'headerLogoutBtn' || e.target.closest('#headerLogoutBtn'))) {
      e.preventDefault();
      firebase.auth().signOut().then(()=> {
        window.location.href = 'signin.html';
      }).catch(()=> { window.location.href = 'signin.html'; });
    }
  });

  // ensure closed on load
  document.addEventListener('DOMContentLoaded', () => {
    if (dropdown) { dropdown.classList.remove('open'); dropdown.setAttribute('aria-hidden','true'); }
    if (avatar) avatar.setAttribute('aria-expanded','false');
  });
})();
  </script>
</body>
</html>
